{
  DB db=getDb();
  BasicDBObject doc=new BasicDBObject();
  doc.put("name","nico");
  doc.put("color","tabby");
  WriteResult result=db.getCollection("updatetests").insert(doc);
  ObjectId savedOid=doc.getObjectId("_id");
  assertNull(result.getError());
  Set<String> colls=db.getCollectionNames();
  assertTrue(colls.contains("updatetests"));
  DBCollection coll=db.getCollection("updatetests");
  DBCursor cur=coll.find();
  BasicDBObject returnedObject=null;
  assertTrue(cur.hasNext());
  returnedObject=(BasicDBObject)cur.next();
  assertFalse(cur.hasNext());
  UUID id=UUID.fromString(returnedObject.get("uuid").toString());
  ObjectId returnedOid=new ObjectId(returnedObject.getString("_id"));
  assertEquals("nico",returnedObject.get("name"));
  assertEquals("tabby",returnedObject.get("color"));
  assertEquals(savedOid,returnedOid);
  assertNotNull(id);
  BasicDBObject query=new BasicDBObject();
  query.put("_id",savedOid);
  returnedObject=new BasicDBObject(db.getCollection("updatetests").findOne(query).toMap());
  assertEquals("nico",returnedObject.get("name"));
  assertEquals("tabby",returnedObject.get("color"));
  assertEquals(savedOid,new ObjectId(returnedObject.getString("_id")));
  assertEquals(id.toString(),returnedObject.get("uuid"));
  BasicDBObject object=new BasicDBObject();
  object.put("newprop","newvalue");
  object.put("color","black");
  db.getCollection("updatetests").update(query,object);
  Thread.sleep(5000);
  UUID appId=emf.lookupApplication("test-organization/test-app");
  EntityManager em=emf.getEntityManager(appId);
  Entity entity=em.get(new SimpleEntityRef((String)returnedObject.get("type"),id));
  assertNotNull(entity);
  assertEquals("nico",entity.getProperty("name"));
  assertEquals("black",entity.getProperty("color"));
  assertEquals("newvalue",entity.getProperty("newprop"));
  returnedObject=new BasicDBObject(db.getCollection("updatetests").findOne(query).toMap());
  assertEquals("nico",returnedObject.get("name"));
  assertEquals("black",returnedObject.get("color"));
  assertEquals("newvalue",returnedObject.get("newprop"));
  assertEquals(savedOid,new ObjectId(returnedObject.getString("_id")));
  assertEquals(id.toString(),returnedObject.get("uuid"));
}
