{
  if (!isOkToSend(notification,jobExecution)) {
    LOG.info("notification " + notification.getUuid() + " canceled");
    if (jobExecution != null) {
      jobExecution.killed();
    }
    return;
  }
  LOG.debug("processing batch {}",notification.getUuid());
  QueueResults queueResults=getDeliveryBatch(notification,jobExecution == null ? BATCH_SIZE / 2 : BATCH_SIZE);
  long reschedule_delay=jobScheduler.SCHEDULER_GRACE_PERIOD;
  final TaskManager taskManager=new TaskManager(em,this,qm,notification,queueResults);
  if (queueResults.size() > 0) {
    consecutiveEmptyQueues.set(0);
    sendBatchToProviders(taskManager,notification,queueResults.getMessages());
  }
 else {
    consecutiveEmptyQueues.incrementAndGet();
  }
  if (!isNotificationDeliveryComplete(notification) && consecutiveEmptyQueues.get() <= CONSECUTIVE_EMPTY_QUEUES) {
    if (jobExecution == null) {
      jobScheduler.scheduleBatchJob(notification,reschedule_delay);
    }
 else {
      processBatchAndReschedule(notification,jobExecution);
    }
  }
 else {
    consecutiveEmptyQueues.set(0);
    finishedBatch(notification,0,0,true);
  }
  LOG.debug("finished processing batch");
}
