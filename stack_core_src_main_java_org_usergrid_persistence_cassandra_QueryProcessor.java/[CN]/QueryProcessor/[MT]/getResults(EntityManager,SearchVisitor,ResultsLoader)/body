{
  if (rootNode == null) {
    return null;
  }
  rootNode.visit(visitor);
  ResultIterator itr=visitor.getResults();
  List<UUID> entityIds=new ArrayList<UUID>(size);
  CursorCache resultsCursor=new CursorCache();
  while (entityIds.size() < size && itr.hasNext()) {
    entityIds.addAll(itr.next());
  }
  if (entityIds.size() > 0) {
    int resultSize=Math.min(entityIds.size(),size);
    entityIds=entityIds.subList(0,resultSize);
    itr.finalizeCursor(resultsCursor,entityIds.get(resultSize - 1));
  }
  Results results=loader.getResults(entityIds);
  if (results == null) {
    return null;
  }
  results.setCursor(resultsCursor.asString());
  results.setQuery(query);
  return results;
}
