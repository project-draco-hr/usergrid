{
  if (rootNode == null) {
    return null;
  }
  rootNode.visit(visitor);
  ResultIterator itr=visitor.getResults();
  List<UUID> entityIds=new ArrayList<UUID>(Math.min(size,Query.MAX_LIMIT));
  CursorCache resultsCursor=new CursorCache();
  while (entityIds.size() < size && itr.hasNext()) {
    entityIds.addAll(itr.next());
  }
  if (entityIds.size() > 0) {
    int resultSize=Math.min(entityIds.size(),size);
    entityIds=entityIds.subList(0,resultSize);
    if (resultSize == size) {
      itr.finalizeCursor(resultsCursor,entityIds.get(resultSize - 1));
    }
  }
  ResultsLoader loader=getResultsLoader(em,query);
  Results results=loader.getResults(entityIds);
  if (results == null) {
    return null;
  }
  results.setCursor(resultsCursor.asString());
  results.setQuery(query);
  return results;
}
