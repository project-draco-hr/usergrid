{
  final EdgeShardSerialization edgeShardSerialization=mock(EdgeShardSerialization.class);
  final NodeShardCounterSerialization NodeShardCounterSerialization=mock(NodeShardCounterSerialization.class);
  final TimeService timeService=mock(TimeService.class);
  final Keyspace keyspace=mock(Keyspace.class);
  final MutationBatch batch=mock(MutationBatch.class);
  when(keyspace.prepareMutationBatch()).thenReturn(batch);
  NodeShardAllocation approximation=new NodeShardAllocationImpl(edgeShardSerialization,NodeShardCounterSerialization,timeService,graphFig,keyspace);
  final Id nodeId=createId("test");
  final String type="type";
  final String subType="subType";
  final long timeservicetime=System.currentTimeMillis();
  when(timeService.getCurrentTime()).thenReturn(timeservicetime);
  when(edgeShardSerialization.getEdgeMetaData(same(scope),same(nodeId),any(Optional.class),same(type),same(subType))).thenReturn(Arrays.asList(0l).iterator());
  final long count=graphFig.getShardSize() - 1;
  when(NodeShardCounterSerialization.getCount(eq(new ShardKey(scope,nodeId,0l,type,subType)))).thenReturn(count);
  final boolean result=approximation.auditMaxShard(scope,nodeId,type,subType);
  assertFalse("Shard allocated",result);
}
