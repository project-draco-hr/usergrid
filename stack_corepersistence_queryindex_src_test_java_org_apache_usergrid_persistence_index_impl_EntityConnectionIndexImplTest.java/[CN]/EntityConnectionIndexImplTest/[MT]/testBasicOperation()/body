{
  Id appId=new SimpleId("application");
  ApplicationScope applicationScope=new ApplicationScopeImpl(appId);
  CollectionScope muffinScope=new CollectionScopeImpl(appId,appId,"muffins");
  Entity muffin=new Entity(new SimpleId(UUIDGenerator.newTimeUUID(),muffinScope.getName()));
  muffin=EntityIndexMapUtils.fromMap(muffin,new HashMap<String,Object>(){
{
      put("size","Large");
      put("flavor","Blueberry");
    }
  }
);
  EntityUtils.setVersion(muffin,UUIDGenerator.newTimeUUID());
  CollectionScope peopleScope=new CollectionScopeImpl(appId,appId,"people");
  Entity person=new Entity(new SimpleId(UUIDGenerator.newTimeUUID(),peopleScope.getName()));
  person=EntityIndexMapUtils.fromMap(person,new HashMap<String,Object>(){
{
      put("name","Dave");
      put("hometown","Chapel Hill");
    }
  }
);
  EntityUtils.setVersion(person,UUIDGenerator.newTimeUUID());
  assertNotNull(person.getId());
  assertNotNull(person.getId().getUuid());
  IndexScope scope=new IndexScopeImpl(person.getId(),"likes");
  EntityIndex personLikesIndex=ecif.createEntityIndex(applicationScope);
  EntityIndexBatch batch=personLikesIndex.createBatch();
  batch.index(scope,muffin);
  batch.executeAndRefresh();
  CandidateResults likes=personLikesIndex.search(scope,Query.fromQL("select *"));
  assertEquals(1,likes.size());
  assertEquals(muffin.getId(),likes.get(0).getId());
}
