{
synchronized (cassandraResource) {
    super.before();
    elasticSearchResource.before();
    emf=cassandraResource.getBean(EntityManagerFactory.class);
    smf=cassandraResource.getBean(ServiceManagerFactory.class);
    tokenService=cassandraResource.getBean(TokenService.class);
    providerFactory=cassandraResource.getBean(SignInProviderFactory.class);
    applicationCreator=cassandraResource.getBean(ApplicationCreator.class);
    managementService=cassandraResource.getBean(ManagementService.class);
    if (!setupCalled) {
      managementService.setup();
      setupCalled=true;
    }
    String esStartup=properties.getProperty("elasticsearch.startup");
    if ("embedded".equals(esStartup)) {
      tomcatResource.setCassandraPort(cassandraResource.getRpcPort());
      tomcatResource.setElasticSearchPort(Integer.parseInt(System.getProperty(LOCAL_ES_PORT_PROPNAME)));
    }
 else {
      tomcatResource.setCassandraPort(cassandraResource.getRpcPort());
      tomcatResource.setElasticSearchPort(elasticSearchResource.getPort());
    }
    tomcatResource.before();
    uri=UriBuilder.fromUri("http://localhost/").port(tomcatResource.getPort()).build();
    ready=true;
    LOG.info("Test setup complete...");
  }
}
