{
  LOG.debug("REMOVED {}",deviceUUID);
  try {
    LOG.debug("notification {} removing device {} from remaining",notification.getUuid(),deviceUUID);
    if (queueManager != null) {
      queueManager.commitMessage(messageMap.get(deviceUUID));
    }
    EntityRef deviceRef=new SimpleEntityRef(Device.ENTITY_TYPE,deviceUUID);
    if (receipt != null) {
      LOG.debug("notification {} sent to device {}. saving receipt.",notification.getUuid(),deviceUUID);
      receipt.setSent(System.currentTimeMillis());
      this.saveReceipt(notification,deviceRef,receipt);
      LOG.debug("notification {} receipt saved for device {}",notification.getUuid(),deviceUUID);
      successes.incrementAndGet();
    }
    if (newProviderId != null) {
      LOG.debug("notification {} replacing device {} notifierId",notification.getUuid(),deviceUUID);
      replaceProviderId(deviceRef,notifier,newProviderId);
    }
    LOG.debug("notification {} completed device {}",notification.getUuid(),deviceUUID);
  }
  finally {
    LOG.debug("COUNT is: {}",successes.get());
    if (hasFinished) {
      finishedBatch();
    }
  }
}
