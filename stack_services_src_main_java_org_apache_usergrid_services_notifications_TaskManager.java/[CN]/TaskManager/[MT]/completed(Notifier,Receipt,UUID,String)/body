{
  LOG.debug("REMOVED {}",deviceUUID);
  try {
    EntityRef deviceRef=new SimpleEntityRef(Device.ENTITY_TYPE,deviceUUID);
    if (receipt != null) {
      LOG.debug("notification {} sent to device {}. saving receipt.",notification.getUuid(),deviceUUID);
      successes.incrementAndGet();
      receipt.setSent(System.currentTimeMillis());
      this.saveReceipt(notification,deviceRef,receipt);
      LOG.debug("notification {} receipt saved for device {}",notification.getUuid(),deviceUUID);
    }
    if (remaining.containsKey(deviceUUID)) {
      LOG.debug("notification {} removing device {} from remaining",notification.getUuid(),deviceUUID);
      qm.commitTransaction(path,remaining.get(deviceUUID).getTransaction(),null);
    }
    if (newProviderId != null) {
      LOG.debug("notification {} replacing device {} notifierId",notification.getUuid(),deviceUUID);
      replaceProviderId(deviceRef,notifier,newProviderId);
    }
    LOG.debug("notification {} completed device {}",notification.getUuid(),deviceUUID);
  }
  finally {
    LOG.debug("COUNT is: {}",successes.get());
    remaining.remove(deviceUUID);
    if (remaining.size() == 0) {
      long successesCopy=successes.get();
      long failuresCopy=failures.get();
      if (successesCopy > 0 || failuresCopy > 0 || skips.get() > 0) {
        ns.finishedBatch(notification,successesCopy,failuresCopy);
      }
    }
  }
}
