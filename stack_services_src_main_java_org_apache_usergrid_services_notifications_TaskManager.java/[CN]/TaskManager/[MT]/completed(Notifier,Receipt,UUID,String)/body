{
  if (LOG.isDebugEnabled()) {
    LOG.debug("REMOVED {}",deviceUUID);
  }
  try {
    if (LOG.isDebugEnabled()) {
      LOG.debug("notification {} removing device {} from remaining",notification.getUuid(),deviceUUID);
    }
    EntityRef deviceRef=new SimpleEntityRef(Device.ENTITY_TYPE,deviceUUID);
    if (receipt != null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("notification {} sent to device {}. saving receipt.",notification.getUuid(),deviceUUID);
      }
      receipt.setSent(System.currentTimeMillis());
      this.saveReceipt(notification,deviceRef,receipt,false);
      if (LOG.isDebugEnabled()) {
        LOG.debug("notification {} receipt saved for device {}",notification.getUuid(),deviceUUID);
      }
      successes.incrementAndGet();
    }
    if (newProviderId != null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("notification {} replacing device {} notifierId",notification.getUuid(),deviceUUID);
      }
      replaceProviderId(deviceRef,notifier,newProviderId);
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("notification {} completed device {}",notification.getUuid(),deviceUUID);
    }
  }
  finally {
    if (LOG.isDebugEnabled()) {
      LOG.debug("COUNT is: {}",successes.get());
    }
    if (hasFinished) {
      finishedBatch();
    }
  }
}
