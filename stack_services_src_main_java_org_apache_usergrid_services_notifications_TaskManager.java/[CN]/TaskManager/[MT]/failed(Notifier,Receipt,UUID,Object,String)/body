{
  try {
    if (logger.isDebugEnabled()) {
      StringBuilder sb=new StringBuilder();
      sb.append("notification ").append(notification.getUuid());
      sb.append(" for device ").append(deviceUUID);
      sb.append(" got error ").append(code);
      logger.debug(sb.toString());
    }
    failures.incrementAndGet();
    if (receipt.getUuid() != null) {
      successes.decrementAndGet();
    }
    receipt.setErrorCode(code);
    receipt.setErrorMessage(message);
    this.saveReceipt(notification,new SimpleEntityRef(Device.ENTITY_TYPE,deviceUUID),receipt,true);
    if (logger.isDebugEnabled()) {
      logger.debug("notification {} receipt saved for device {}",notification.getUuid(),deviceUUID);
    }
  }
  finally {
    completed(notifier,deviceUUID);
  }
}
