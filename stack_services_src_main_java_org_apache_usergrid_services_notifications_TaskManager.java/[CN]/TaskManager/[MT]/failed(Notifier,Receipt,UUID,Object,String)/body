{
  try {
    if (logger.isDebugEnabled()) {
      logger.debug("notification {} for device {} got error {}",notification.getUuid(),deviceUUID,code);
    }
    failures.incrementAndGet();
    if (receipt.getUuid() != null) {
      successes.decrementAndGet();
    }
    receipt.setErrorCode(code);
    receipt.setErrorMessage(message);
    this.saveReceipt(notification,new SimpleEntityRef(Device.ENTITY_TYPE,deviceUUID),receipt,true);
    if (logger.isDebugEnabled()) {
      logger.debug("notification {} receipt saved for device {}",notification.getUuid(),deviceUUID);
    }
  }
  finally {
    completed(notifier,deviceUUID);
  }
}
