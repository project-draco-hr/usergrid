{
  boolean debug=false;
  if (this.notification != null) {
    debug=this.notification.getDebug();
  }
  if (debug || hasError) {
    if (receipt.getUuid() == null) {
      Receipt savedReceipt=em.create(receipt);
      receipt.setUuid(savedReceipt.getUuid());
      List<EntityRef> entities=Arrays.asList(notification,device);
      em.addToCollections(entities,Notification.RECEIPTS_COLLECTION,savedReceipt);
    }
 else {
      em.update(receipt);
    }
  }
}
