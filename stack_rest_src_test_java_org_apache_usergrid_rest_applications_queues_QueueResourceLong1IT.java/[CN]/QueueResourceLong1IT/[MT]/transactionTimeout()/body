{
  Queue queue=context.application().queues().queue("test");
  final int count=2;
  for (int i=0; i < count; i++) {
    queue.post(MapUtils.hashMap("id",i));
  }
  refreshIndex(context.getOrgName(),context.getAppName());
  final long timeout=5000;
  queue=queue.withTimeout(timeout);
  TransactionResponseHandler transHandler=new TransactionResponseHandler(count);
  testMessages(queue,transHandler,new NoLastCommand());
  long start=System.currentTimeMillis();
  transHandler.assertResults();
  List<String> originalMessageIds=transHandler.getMessageIds();
  BiMap<String,String> transactionInfo=transHandler.getTransactionToMessageId();
  IncrementHandler incrementHandler=new IncrementHandler(0);
  testMessages(queue,incrementHandler,new NoLastCommand());
  incrementHandler.assertResults();
  Thread.sleep(timeout - (System.currentTimeMillis() - start));
  transHandler=new TransactionResponseHandler(count);
  testMessages(queue,transHandler,new NoLastCommand());
  start=System.currentTimeMillis();
  transHandler.assertResults();
  List<String> returned=transHandler.getMessageIds();
  assertTrue(returned.size() > 0);
  BiMap<String,String> newTransactions=transHandler.getTransactionToMessageId();
  for (int i=0; i < originalMessageIds.size(); i++) {
    assertEquals(originalMessageIds.get(i),returned.get(i));
    assertNotNull(transactionInfo.get(originalMessageIds.get(i)));
  }
  Thread.sleep(timeout - (System.currentTimeMillis() - start));
  transHandler=new TransactionResponseHandler(count);
  testMessages(queue,transHandler,new NoLastCommand());
  start=System.currentTimeMillis();
  transHandler.assertResults();
  returned=transHandler.getMessageIds();
  assertTrue(returned.size() > 0);
  newTransactions=transHandler.getTransactionToMessageId();
  for (int i=0; i < originalMessageIds.size(); i++) {
    assertEquals(originalMessageIds.get(i),returned.get(i));
    assertNotNull(transactionInfo.get(originalMessageIds.get(i)));
    Transaction transaction=queue.transactions().transaction(newTransactions.get(originalMessageIds.get(i)));
    transaction.delete();
  }
  Thread.sleep(timeout - (System.currentTimeMillis() - start));
  incrementHandler=new IncrementHandler(0);
  testMessages(queue,incrementHandler,new NoLastCommand());
  incrementHandler.assertResults();
}
