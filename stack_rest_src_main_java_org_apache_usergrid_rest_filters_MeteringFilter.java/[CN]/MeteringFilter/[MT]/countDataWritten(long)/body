{
  TimerContext timer=(TimerContext)httpServletRequest.getAttribute("application.request.requestTimer");
  try {
    UUID applicationId=(UUID)httpServletRequest.getAttribute("applicationId");
    Long timestamp=(Long)httpServletRequest.getAttribute("application.request.timetamp");
    long time;
    if ((timestamp != null) && (timestamp > 0)) {
      time=System.currentTimeMillis() - timestamp;
    }
 else {
      time=-1;
    }
    usergridSystemMonitor.maybeLogPayload(time,"path",httpServletRequest.getRequestURI(),"applicationId",applicationId);
    if (applicationId != null) {
      Map<String,Long> counters=new HashMap<String,Long>();
      if (time > 0) {
        logger.trace("Application: {}, spent {} milliseconds of CPU time",applicationId,time);
        counters.put("application.request.time",time);
      }
      Long read=(Long)httpServletRequest.getAttribute("application.request.upload");
      if ((read != null) && (read > 0)) {
        logger.trace("Application: {}, received {} bytes",applicationId,written);
        counters.put("application.request.upload",read);
      }
      if (written > 0) {
        logger.trace("Application: {}, sending {} bytes",applicationId,written);
        counters.put("application.request.download",written);
      }
      if (emf != null) {
        EntityManager em=emf.getEntityManager(applicationId);
        em.incrementAggregateCounters(null,null,null,counters);
      }
 else {
        logger.error("No EntityManagerFactory configured");
      }
    }
  }
 catch (  Exception e) {
    logger.error("Unable to capture output",e);
  }
 finally {
    if (timer != null) {
      timer.stop();
    }
    activeRequests.dec();
  }
}
