{
  logger.info("Handling a query... ");
  OpReply reply=new OpReply(this);
  ApplicationInfo application=SubjectUtils.getApplication(Identifier.fromName(getDatabaseName()));
  if (application == null) {
    return reply;
  }
  int count=getNumberToReturn();
  if (count <= 0) {
    count=30;
  }
  EntityManager em=handler.getEmf().getEntityManager(application.getId());
  try {
    Results results=null;
    Query q=MongoQueryParser.toNativeQuery(query,numberToReturn);
    if (q != null) {
      results=em.searchCollection(em.getApplicationRef(),getCollectionName(),q);
    }
 else {
      results=em.getCollection(em.getApplicationRef(),getCollectionName(),null,count,Results.Level.ALL_PROPERTIES,false);
    }
    if (!results.isEmpty()) {
      for (      Entity entity : results.getEntities()) {
        reply.addDocument(map(entry("_id",entity.getUuid()),toJsonMap(entity),entry(Schema.PROPERTY_UUID,entity.getUuid().toString())));
      }
    }
  }
 catch (  Exception ex) {
    logger.error("Unable to retrieve collections",ex);
  }
  return reply;
}
