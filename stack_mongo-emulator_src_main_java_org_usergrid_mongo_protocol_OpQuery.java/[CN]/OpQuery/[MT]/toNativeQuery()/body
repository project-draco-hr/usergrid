{
  if (query == null) {
    return null;
  }
  BSONObject query_expression=null;
  BSONObject sort_order=null;
  Object o=query.get("$query");
  if (!(o instanceof BSONObject)) {
    o=query.get("query");
  }
  if (o instanceof BSONObject) {
    query_expression=(BSONObject)o;
  }
  o=query.get("$orderby");
  if (!(o instanceof BSONObject)) {
    o=query.get("orderby");
  }
  if (o instanceof BSONObject) {
    sort_order=(BSONObject)o;
  }
  if ((query_expression == null) && (sort_order == null)) {
    return null;
  }
  Query q=new Query();
  if (getNumberToReturn() > 0) {
    q.setLimit(getNumberToReturn());
  }
  if (query_expression != null) {
    AndOperand and=new AndOperand();
    append(and,query_expression);
    q.setRootOperand(and);
  }
  if (sort_order != null) {
    for (    String sort : sort_order.keySet()) {
      if (!"_id".equals(sort)) {
        int s=getIntValue(sort_order.toMap(),"_id",1);
        q.addSort(sort,s >= 0 ? SortDirection.ASCENDING : SortDirection.DESCENDING);
      }
    }
  }
  return q;
}
