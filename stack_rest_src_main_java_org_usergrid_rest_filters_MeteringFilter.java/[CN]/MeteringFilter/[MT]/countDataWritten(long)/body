{
  TimerContext timer=(TimerContext)httpServletRequest.getAttribute("application.request.requestTimer");
  try {
    UUID applicationId=(UUID)httpServletRequest.getAttribute("applicationId");
    if (applicationId != null) {
      Map<String,Long> counters=new HashMap<String,Long>();
      Long timestamp=(Long)httpServletRequest.getAttribute("application.request.timetamp");
      if ((timestamp != null) && (timestamp > 0)) {
        long time=System.currentTimeMillis() - timestamp;
        logger.info("Application: {}, spent {} milliseconds of CPU time",applicationId,time);
        counters.put("application.request.time",time);
      }
      Long read=(Long)httpServletRequest.getAttribute("application.request.upload");
      if ((read != null) && (read > 0)) {
        logger.info("Application: {}, received {} bytes",applicationId,written);
        counters.put("application.request.upload",read);
      }
      if (written > 0) {
        logger.info("Application: {}, sending {} bytes",applicationId,written);
        counters.put("application.request.download",written);
      }
      if (emf != null) {
        EntityManager em=emf.getEntityManager(applicationId);
        em.incrementAggregateCounters(null,null,null,counters);
      }
 else {
        logger.error("No EntityManagerFactory configured");
      }
    }
  }
 catch (  Exception e) {
    logger.error("Unable to capture output",e);
  }
 finally {
    if (timer != null) {
      timer.stop();
    }
    activeRequests.dec();
  }
}
