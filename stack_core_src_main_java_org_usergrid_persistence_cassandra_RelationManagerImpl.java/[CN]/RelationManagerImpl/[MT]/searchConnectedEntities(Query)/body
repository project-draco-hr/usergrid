{
  if (query == null) {
    query=new Query();
  }
  String connectedEntityType=query.getEntityType();
  String connectionType=query.getConnectionType();
  headEntity=em.validate(headEntity);
  if (!query.hasQueryPredicates() && !query.hasSortPredicates()) {
    List<ConnectionRefImpl> connections=getConnections(new ConnectionRefImpl(headEntity,new ConnectedEntityRefImpl(NULL_ID),new ConnectedEntityRefImpl(connectionType,connectedEntityType,null)),false);
    Results results=Results.fromConnections(connections);
    results=em.loadEntities(results,query.getResultsLevel(),query.getLimit());
    return results;
  }
  Results results=null;
  ConnectionRefImpl connectionRef=new ConnectionRefImpl(headEntity,new ConnectedEntityRefImpl(connectionType,connectedEntityType,null));
  QueryProcessor qp=new QueryProcessor(query,null);
  SearchConnectionVisitor visitor=new SearchConnectionVisitor(query,qp,connectionRef);
  qp.getFirstNode().visit(visitor);
  results=visitor.getResults();
  if (results == null) {
    return null;
  }
  results=em.loadEntities(results,query.getResultsLevel(),query.getLimit());
  if (results != null) {
    results.setQuery(query);
  }
  return results;
}
