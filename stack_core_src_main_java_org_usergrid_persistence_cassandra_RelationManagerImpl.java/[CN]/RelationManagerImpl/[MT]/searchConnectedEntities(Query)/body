{
  if (query == null) {
    query=new Query();
  }
  String connectedEntityType=query.getEntityType();
  String connectionType=query.getConnectionType();
  headEntity=em.validate(headEntity);
  if (!query.hasQueryPredicates() && !query.hasSortPredicates()) {
    List<ConnectionRefImpl> connections=getConnections(new ConnectionRefImpl(headEntity,new ConnectedEntityRefImpl(NULL_ID),new ConnectedEntityRefImpl(connectionType,connectedEntityType,null)),false);
    Results results=Results.fromConnections(connections);
    results=em.loadEntities(results,query.getResultsLevel(),query.getLimit());
    return results;
  }
  ConnectionRefImpl connectionRef=new ConnectionRefImpl(headEntity,new ConnectedEntityRefImpl(connectionType,connectedEntityType,null));
  QueryProcessor qp=new QueryProcessor(query,null);
  SearchConnectionVisitor visitor=new SearchConnectionVisitor(query,qp,connectionRef);
  List<Entity> searchEntities=qp.getEntities(em,visitor);
  Results results=Results.fromEntities(searchEntities);
  if (results == null) {
    return null;
  }
  results.setQuery(query);
  results.setCursor(qp.getCursor());
  return results;
}
