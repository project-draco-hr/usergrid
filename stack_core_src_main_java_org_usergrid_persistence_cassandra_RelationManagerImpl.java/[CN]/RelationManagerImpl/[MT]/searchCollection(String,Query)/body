{
  if (query == null) {
    query=new Query();
  }
  headEntity=em.validate(headEntity);
  CollectionInfo collection=getDefaultSchema().getCollection(headEntity.getType(),collectionName);
  query.setEntityType(collection.getType());
  boolean reversed=query.isReversed();
  if (!query.hasQueryPredicates() && !query.hasSortPredicates()) {
    List<UUID> ids=query.getUuidIdentifiers();
    if (ids == null) {
      ids=cass.getIdList(cass.getApplicationKeyspace(applicationId),key(headEntity.getUuid(),DICTIONARY_COLLECTIONS,collectionName),query.getStartResult(),null,query.getLimit() + 1,reversed,indexBucketLocator,applicationId,collectionName);
    }
    Results results=Results.fromIdList(ids,collection.getType());
    if (results != null) {
      results.setQuery(query);
    }
    return em.loadEntities(results,query.getResultsLevel(),query.getLimit());
  }
  QueryProcessor qp=new QueryProcessor(query,collection);
  SearchCollectionVisitor visitor=new SearchCollectionVisitor(query,qp,collection);
  qp.getFirstNode().visit(visitor);
  Results results=visitor.getResults();
  if (results == null) {
    return null;
  }
  Map<UUID,UUID> ids=null;
  if (query.getResultsLevel() == Results.Level.LINKED_PROPERTIES) {
    ids=new LinkedHashMap<UUID,UUID>();
    List<UUID> resultIds=results.getIds();
    for (    UUID id : resultIds) {
      ids.put(id,new SimpleCollectionRef(headEntity,collectionName,ref(id)).getUuid());
    }
  }
  results=em.loadEntities(results,query.getResultsLevel(),ids,query.getLimit());
  if (results != null) {
    results.setQuery(query);
  }
  if (results.getLevel().ordinal() >= Results.Level.CORE_PROPERTIES.ordinal()) {
    List<Entity> entities=results.getEntities();
    if (entities != null) {
      qp.sort(entities);
    }
  }
  results.setCursor(qp.getCursor());
  logger.debug("Query cursor: {}",results.getCursor());
  return results;
}
