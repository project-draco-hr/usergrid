{
  String username="tnine" + newUUIDString();
  String password="test";
  String orgName="testAppUserPasswordChangeMd5ShaType" + newUUIDString();
  String appName="testAppUserPasswordChangeMd5ShaType" + newUUIDString();
  UUID appId=setup.getEmf().createApplication(orgName,appName);
  User user=new User();
  user.setActivated(true);
  user.setUsername(username);
  EntityManager em=setup.getEmf().getEntityManager(appId);
  User storedUser=em.create(user);
  em.refreshIndex();
  UUID userId=storedUser.getUuid();
  CredentialsInfo info=new CredentialsInfo();
  info.setRecoverable(false);
  info.setEncrypted(true);
  Md5HashCommand md5=new Md5HashCommand();
  Sha1HashCommand sha1=new Sha1HashCommand();
  byte[] hashed=md5.hash(password.getBytes("UTF-8"),info,userId,appId);
  hashed=sha1.hash(hashed,info,userId,appId);
  info.setSecret(encodeBase64URLSafeString(hashed));
  info.setCipher(sha1.getName());
  info.setHashType(md5.getName());
  em.addToDictionary(storedUser,DICTIONARY_CREDENTIALS,"password",info);
  User authedUser=setup.getMgmtSvc().verifyAppUserPasswordCredentials(appId,username,password);
  assertEquals(userId,authedUser.getUuid());
  String newPassword="test2";
  setup.getMgmtSvc().setAppUserPassword(appId,userId,password,newPassword);
  em.refreshIndex();
  authedUser=setup.getMgmtSvc().verifyAppUserPasswordCredentials(appId,username,newPassword);
  assertEquals(userId,authedUser.getUuid());
}
