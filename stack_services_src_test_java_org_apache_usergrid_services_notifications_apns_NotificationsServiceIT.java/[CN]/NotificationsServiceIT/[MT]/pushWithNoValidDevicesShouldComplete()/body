{
  app.clear();
  app.put("name","gcm");
  app.put("provider",PROVIDER);
  app.put("environment","development");
  app.put("apiKey","xxx");
  InputStream fis=getClass().getClassLoader().getResourceAsStream("pushtest_dev_recent.p12");
  byte[] certBytes=IOUtils.toByteArray(fis);
  app.put("p12Certificate",certBytes);
  app.testRequest(ServiceAction.POST,1,"notifiers").getEntity().toTypedEntity();
  String key="gcm" + NOTIFIER_ID_POSTFIX;
  app.clear();
  app.put(key,PUSH_TOKEN);
  Entity e=app.testRequest(ServiceAction.POST,1,"devices").getEntity();
  app.testRequest(ServiceAction.GET,1,"devices",e.getUuid());
  Device device=app.getEm().get(e.getUuid(),Device.class);
  assertEquals(device.getProperty(key),PUSH_TOKEN);
  app.clear();
  String payload=getPayload();
  Map<String,String> payloads=new HashMap<String,String>(1);
  payloads.put(notifier.getUuid().toString(),payload);
  app.put("payloads",payloads);
  app.put("started",System.currentTimeMillis());
  app.put("queued",System.currentTimeMillis());
  e=app.testRequest(ServiceAction.POST,1,"notifications").getEntity();
  app.testRequest(ServiceAction.GET,1,"notifications",e.getUuid());
  Notification notification=app.getEm().get(e.getUuid(),Notification.class);
  assertEquals(notification.getPayloads().get(notifier.getUuid().toString()),payload);
  ns.addDevice(notification,device);
  Query query=Query.fromQL("select * where type = 'notification'");
  Results results=app.getEm().searchCollection(app.getEm().getApplicationRef(),"notifications",query);
  Notification note=(Notification)results.getEntitiesMap().get(notification.getUuid());
  assertEquals(Notification.State.STARTED,note.getState());
  ns.getQueueManager().processBatchAndReschedule(notification,null);
  query=Query.fromQL("select * where type = 'notification'");
  results=app.getEm().searchCollection(app.getEm().getApplicationRef(),"notifications",query);
  note=(Notification)results.getEntitiesMap().get(notification.getUuid());
  assertEquals(Notification.State.FINISHED,note.getState());
  notification=note;
  checkReceipts(notification,0);
  checkStatistics(notification,0,0);
}
