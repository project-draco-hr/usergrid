{
  setup.getEntityIndex().refresh(app.getId());
  app.clear();
  String payload=getPayload();
  Map<String,String> payloads=new HashMap<String,String>(1);
  payloads.put(notifier.getName().toString(),payload);
  app.put("payloads",payloads);
  app.put("queued",System.currentTimeMillis());
  app.put("debug",true);
  app.put("expire",System.currentTimeMillis() + 300000);
  Entity sentNotification=app.testRequest(ServiceAction.POST,1,"notifications").getEntity();
  Entity fetchedNotification=app.testRequest(ServiceAction.GET,1,"notifications",sentNotification.getUuid()).getEntity();
  try {
    app.testRequest(ServiceAction.DELETE,1,"notifications",fetchedNotification.getUuid());
  }
 catch (  Exception e) {
    assertEquals(e.getClass(),ForbiddenServiceOperationException.class);
  }
  Notification notification=app.getEntityManager().get(fetchedNotification.getUuid(),Notification.class);
  notification=scheduleNotificationAndWait(notification);
  setup.getEntityIndex().refresh(app.getId());
  try {
    notification=app.getEntityManager().get(notification.getUuid(),Notification.class);
    assertEquals(Notification.State.FINISHED,notification.getState());
    app.testRequest(ServiceAction.DELETE,1,"notifications",notification.getUuid());
  }
 catch (  Exception e) {
    fail("Delete should be successful after notification has finished.");
  }
}
