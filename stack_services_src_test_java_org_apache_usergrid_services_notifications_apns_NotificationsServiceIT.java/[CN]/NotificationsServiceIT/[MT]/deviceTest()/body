{
  app.clear();
  Entity e=app.testRequest(ServiceAction.POST,1,"users",user2.getUuid(),"devices",device1.getUuid()).getEntity();
  app.clear();
  e=app.testRequest(ServiceAction.POST,1,"users",user1.getUuid(),"devices",device1.getUuid()).getEntity();
  app.clear();
  e=app.testRequest(ServiceAction.POST,1,"users",user1.getUuid(),"devices",device2.getUuid()).getEntity();
  List device1Users=app.getEm().getCollection(device1,"users",null,100,Query.Level.REFS,false).getEntities();
  assertEquals(device1Users.size(),1);
  List user1Devices=app.getEm().getCollection(user1,"devices",null,100,Query.Level.REFS,false).getEntities();
  assertEquals(user1Devices.size(),2);
  app.clear();
  e=app.testRequest(ServiceAction.POST,1,"users",user1.getUuid(),"devices",device2.getUuid()).getEntity();
  user1Devices=app.getEm().getCollection(user1,"devices",null,100,Query.Level.REFS,false).getEntities();
  assertEquals(user1Devices.size(),2);
  app.getEm().refreshIndex();
  app.clear();
  String payload=getPayload();
  Map<String,String> payloads=new HashMap<String,String>(1);
  payloads.put(notifier.getName().toString(),payload);
  app.put("payloads",payloads);
  app.put("queued",System.currentTimeMillis());
  app.put("debug",true);
  e=app.testRequest(ServiceAction.POST,1,"users",user1.getUuid(),"notifications").getEntity();
  app.testRequest(ServiceAction.GET,1,"notifications",e.getUuid());
  Notification notification=app.getEm().get(e.getUuid(),Notification.class);
  assertEquals(notification.getPayloads().get(notifier.getName().toString()),payload);
  Query query=new Query();
  query.addEqualityFilter("state",Notification.State.STARTED.toString());
  Results results=app.getEm().searchCollection(app.getEm().getApplicationRef(),"notifications",query);
  Entity entity=results.getEntitiesMap().get(notification.getUuid());
  notification=scheduleNotificationAndWait(notification);
  app.getEm().refreshIndex();
  query=new Query();
  query.addEqualityFilter("state",Notification.State.FINISHED.toString());
  results=app.getEm().searchCollection(app.getEm().getApplicationRef(),"notifications",query);
  entity=results.getEntitiesMap().get(notification.getUuid());
  assertNotNull(entity);
  checkReceipts(notification,2);
  checkStatistics(notification,2,0);
}
