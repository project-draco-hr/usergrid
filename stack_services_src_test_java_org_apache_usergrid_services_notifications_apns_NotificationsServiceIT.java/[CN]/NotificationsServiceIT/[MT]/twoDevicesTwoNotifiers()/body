{
  String notifier2Name="apNs2";
  app.clear();
  app.put("name",notifier2Name);
  app.put("provider",PROVIDER);
  app.put("environment","development");
  InputStream fis=getClass().getClassLoader().getResourceAsStream("pushtest_dev_recent.p12");
  byte[] certBytes=IOUtils.toByteArray(fis);
  app.put("p12Certificate",certBytes);
  fis.close();
  Entity e=app.testRequest(ServiceAction.POST,1,"notifiers").getEntity();
  app.getEm().refreshIndex();
  app.testRequest(ServiceAction.GET,1,"notifiers","apNs2");
  Notifier notifier2=app.getEm().get(e.getUuid(),Notifier.class);
  assertEquals(notifier2.getName(),"apNs2");
  assertEquals(notifier2.getProvider(),PROVIDER);
  assertEquals(notifier2.getEnvironment(),"development");
  String key=notifierName + NOTIFIER_ID_POSTFIX;
  String key2=notifier2Name + NOTIFIER_ID_POSTFIX;
  device2.setProperty(key,null);
  device2.setProperty(key2,PUSH_TOKEN);
  app.getEm().update(device2);
  app.getEm().refreshIndex();
  app.clear();
  String payload=getPayload();
  Map<String,String> payloads=new HashMap<String,String>(1);
  payloads.put(notifierName,payload);
  payloads.put(notifier2Name,payload);
  app.put("payloads",payloads);
  app.put("queued",System.currentTimeMillis());
  app.put("debug",true);
  e=app.testRequest(ServiceAction.POST,1,"devices","notifications").getEntity();
  app.testRequest(ServiceAction.GET,1,"notifications",e.getUuid());
  app.getEm().refreshIndex();
  Notification notification=app.getEm().get(e.getUuid(),Notification.class);
  assertEquals(notification.getPayloads().get(notifierName),payload);
  notification=scheduleNotificationAndWait(notification);
  app.getEm().refreshIndex();
  checkReceipts(notification,2);
}
