{
  ApplicationInfo appInfo=management.getApplicationInfo("test-organization/test-app");
  User user=setupAppUser(appInfo.getId(),"registration_requires_admin_approval",Boolean.TRUE,"testAppUserMailUrl","testAppUserMailUrl@test.com",false);
  String subject="Request For User Account Activation testAppUserMailUrl@test.com";
  String activation_url=String.format(properties.getProperty(PROPERTIES_USER_ACTIVATION_URL),"test-organization","test-app",user.getUuid().toString());
  management.startAppUserActivationFlow(appInfo.getId(),user);
  List<Message> inbox=org.jvnet.mock_javamail.Mailbox.get("test@usergrid.com");
  assertFalse(inbox.isEmpty());
  MockImapClient client=new MockImapClient("usergrid.com","test","somepassword");
  client.processMail();
  Message account_activation_message=inbox.get(0);
  assertEquals(subject,account_activation_message.getSubject());
  String mailContent=(String)((MimeMultipart)account_activation_message.getContent()).getBodyPart(1).getContent();
  logger.info(mailContent);
  assertTrue(StringUtils.contains(mailContent,activation_url));
  String token=getTokenFromMessage(account_activation_message);
  logger.info(token);
  ActivationState activeState=management.handleActivationTokenForAppUser(appInfo.getId(),user.getUuid(),token);
  assertEquals(ActivationState.ACTIVATED,activeState);
  subject="Password Reset";
  String reset_url=String.format(properties.getProperty(PROPERTIES_USER_RESETPW_URL),"test-organization","test-app",user.getUuid().toString());
  management.startAppUserPasswordResetFlow(appInfo.getId(),user);
  inbox=org.jvnet.mock_javamail.Mailbox.get("testAppUserMailUrl@test.com");
  assertFalse(inbox.isEmpty());
  client=new MockImapClient("test.com","testAppUserMailUrl","somepassword");
  client.processMail();
  Message password_reset_message=inbox.get(1);
  assertEquals(subject,password_reset_message.getSubject());
  mailContent=(String)((MimeMultipart)password_reset_message.getContent()).getBodyPart(1).getContent();
  logger.info(mailContent);
  assertTrue(StringUtils.contains(mailContent,reset_url));
  token=getTokenFromMessage(password_reset_message);
  logger.info(token);
  assertTrue(management.checkPasswordResetTokenForAppUser(appInfo.getId(),user.getUuid(),token));
  management.revokeAccessTokenForAppUser(token);
  assertFalse(management.checkPasswordResetTokenForAppUser(appInfo.getId(),user.getUuid(),token));
}
