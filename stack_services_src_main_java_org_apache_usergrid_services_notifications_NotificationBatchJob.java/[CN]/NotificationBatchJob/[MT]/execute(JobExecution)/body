{
  Timer.Context timer=timerMetric.time();
  requestMeter.mark();
  logger.info("execute NotificationBatchJob {}",jobExecution);
  JobData jobData=jobExecution.getJobData();
  UUID applicationId=(UUID)jobData.getProperty("applicationId");
  ServiceManager sm=smf.getServiceManager(applicationId);
  NotificationsService notificationsService=(NotificationsService)sm.getService("notifications");
  EntityManager em=emf.getEntityManager(applicationId);
  try {
    if (em == null) {
      logger.info("no EntityManager for applicationId  {}",applicationId);
      return;
    }
    UUID notificationId=(UUID)jobData.getProperty("notificationId");
    Notification notification=em.get(notificationId,Notification.class);
    if (notification == null) {
      logger.info("notificationId {} no longer exists",notificationId);
      return;
    }
    try {
      NotificationsQueueManager queueManager=new NotificationsQueueManager(new JobScheduler(sm,em),em,properties,sm.getQueueManager(),metricsService);
      queueManager.processBatchAndReschedule(notification,jobExecution);
    }
 catch (    Exception e) {
      logger.error("execute NotificationBatchJob failed",e);
      em.setProperty(notification,"errorMessage",e.getMessage());
      throw e;
    }
 finally {
      long diff=System.currentTimeMillis() - notification.getCreated();
      cycleMetric.update(diff);
      postSendMeter.mark();
    }
  }
  finally {
    timer.stop();
  }
  logger.info("execute NotificationBatch completed normally");
}
