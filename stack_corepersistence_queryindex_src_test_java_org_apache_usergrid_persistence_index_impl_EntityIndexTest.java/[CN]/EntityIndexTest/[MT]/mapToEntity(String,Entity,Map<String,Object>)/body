{
  if (entity == null) {
    entity=new Entity();
  }
  for (  String fieldName : map.keySet()) {
    Object value=map.get(fieldName);
    if (value instanceof String) {
      entity.setField(new StringField(fieldName,(String)value));
    }
 else     if (value instanceof Boolean) {
      entity.setField(new BooleanField(fieldName,(Boolean)value));
    }
 else     if (value instanceof Integer) {
      entity.setField(new IntegerField(fieldName,(Integer)value));
    }
 else     if (value instanceof Double) {
      entity.setField(new DoubleField(fieldName,(Double)value));
    }
 else     if (value instanceof Long) {
      entity.setField(new LongField(fieldName,(Long)value));
    }
 else     if (value instanceof List) {
      entity.setField(listToListField(scope,fieldName,(List)value));
    }
 else     if (value instanceof Map) {
      entity.setField(new EntityObjectField(fieldName,mapToEntity(scope,(Map<String,Object>)value)));
    }
 else {
      throw new RuntimeException("Unknown type " + value.getClass().getName());
    }
  }
  return entity;
}
