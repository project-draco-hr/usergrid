{
  Id appId=new SimpleId("application");
  Id ownerId=new SimpleId("owner");
  ApplicationScope applicationScope=new ApplicationScopeImpl(appId);
  IndexScope appScope=new IndexScopeImpl(ownerId,"user");
  ApplicationEntityIndex entityIndex=eif.createApplicationEntityIndex(applicationScope);
  entityIndex.initializeIndex();
  final String middleName="middleName" + UUIDUtils.newTimeUUID();
  Map entityMap=new HashMap(){
{
      put("username","edanuff");
      put("email","ed@anuff.com");
      put("middlename",middleName);
    }
  }
;
  Entity user=EntityIndexMapUtils.fromMap(entityMap);
  EntityUtils.setId(user,new SimpleId("edanuff"));
  EntityUtils.setVersion(user,UUIDGenerator.newTimeUUID());
  EntityIndexBatch batch=entityIndex.createBatch();
  batch.index(appScope,user);
  batch.execute().get();
  ei.refresh();
  Query query=new Query();
  query.addEqualityFilter("username","edanuff");
  CandidateResults r=entityIndex.search(appScope,SearchTypes.fromTypes("edanuff"),query);
  assertEquals(user.getId(),r.get(0).getId());
  batch.deindex(appScope,user.getId(),user.getVersion());
  batch.execute().get();
  ei.refresh();
  query=new Query();
  query.addEqualityFilter("username","edanuff");
  r=entityIndex.search(appScope,SearchTypes.fromTypes("edanuff"),query);
  assertFalse(r.iterator().hasNext());
}
