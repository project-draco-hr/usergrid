{
  this.refreshIndex();
  final String uuid;
  access_token=this.getAdminToken().getAccessToken();
  String orgAppPath=clientSetup.getOrganizationName() + "/" + clientSetup.getAppName();
  Map<String,String> payload=hashMap("name","cassandra_eye.jpg");
  JsonNode node=resource().path("/test-organization/test-app/foos").queryParam("access_token",access_token).accept(MediaType.APPLICATION_JSON).type(MediaType.APPLICATION_JSON_TYPE).post(JsonNode.class,payload);
  JsonNode idNode=node.get("entities").get(0).get("uuid");
  uuid=idNode.textValue();
  byte[] data=IOUtils.toByteArray(this.getClass().getResourceAsStream("/cassandra_eye.jpg"));
  resource().path(orgAppPath + "/foos/" + uuid).queryParam("access_token",access_token).type(MediaType.APPLICATION_OCTET_STREAM_TYPE).put(data);
  Map<String,String> imageGalleryPayload=hashMap("name","my image gallery");
  JsonNode imageGalleryNode=resource().path(orgAppPath + "/imagegalleries").queryParam("access_token",access_token).accept(MediaType.APPLICATION_JSON).type(MediaType.APPLICATION_JSON_TYPE).post(JsonNode.class,imageGalleryPayload);
  JsonNode imageGalleryIdNode=imageGalleryNode.get("entities").get(0).get("uuid");
  String imageGalleryId=imageGalleryIdNode.textValue();
  JsonNode connectNode=resource().path(orgAppPath + "/imagegalleries/" + imageGalleryId+ "/contains/"+ uuid).queryParam("access_token",access_token).accept(MediaType.APPLICATION_JSON).type(MediaType.APPLICATION_JSON_TYPE).post(JsonNode.class);
  LOG.debug(mapToFormattedJsonString(connectNode));
  this.refreshIndex();
  JsonNode listConnectionsNode=resource().path(orgAppPath + "/imagegalleries/" + imageGalleryId+ "/contains/").queryParam("access_token",access_token).accept(MediaType.APPLICATION_JSON).type(MediaType.APPLICATION_JSON_TYPE).get(JsonNode.class);
  LOG.debug(mapToFormattedJsonString(listConnectionsNode));
  assertEquals(uuid,listConnectionsNode.get("entities").get(0).get("uuid").textValue());
  resource().path(orgAppPath + "/imagegalleries/" + imageGalleryId+ "/contains/"+ uuid).queryParam("access_token",access_token).accept(MediaType.APPLICATION_JSON).type(MediaType.APPLICATION_JSON_TYPE).delete();
  this.refreshIndex();
  listConnectionsNode=resource().path(orgAppPath + "/imagegalleries/" + imageGalleryId+ "/contains/").queryParam("access_token",access_token).accept(MediaType.APPLICATION_JSON).type(MediaType.APPLICATION_JSON_TYPE).get(JsonNode.class);
  assertFalse(listConnectionsNode.get("entities").elements().hasNext());
  JsonNode assetNode=resource().path(orgAppPath + "/foos/" + uuid).queryParam("access_token",access_token).accept(MediaType.APPLICATION_JSON_TYPE).get(JsonNode.class);
  Assert.assertEquals("image/jpeg",assetNode.findValue(AssetUtils.CONTENT_TYPE).textValue());
  Assert.assertEquals(7979,assetNode.findValue("content-length").intValue());
  JsonNode assetIdNode=assetNode.get("entities").get(0).get("uuid");
  assertEquals(uuid,assetIdNode.textValue());
  InputStream assetIs=resource().path(orgAppPath + "/foos/" + uuid).queryParam("access_token",access_token).accept(MediaType.APPLICATION_OCTET_STREAM_TYPE).get(InputStream.class);
  byte[] foundData=IOUtils.toByteArray(assetIs);
  assertEquals(7979,foundData.length);
}
