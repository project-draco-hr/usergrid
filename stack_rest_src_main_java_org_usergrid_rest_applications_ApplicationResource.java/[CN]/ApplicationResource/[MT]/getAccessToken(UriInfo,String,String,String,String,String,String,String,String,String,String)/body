{
  logger.info("ApplicationResource.getAccessToken");
  User user=null;
  try {
    if (authorization != null) {
      String type=stringOrSubstringBeforeFirst(authorization,' ').toUpperCase();
      if ("BASIC".equals(type)) {
        String token=stringOrSubstringAfterFirst(authorization,' ');
        String[] values=Base64.decodeToString(token).split(":");
        if (values.length >= 2) {
          client_id=values[0].toLowerCase();
          client_secret=values[1];
        }
      }
    }
    if (GrantType.PASSWORD.toString().equals(grant_type)) {
      try {
        user=management.verifyAppUserPasswordCredentials(services.getApplicationId(),username,password);
      }
 catch (      Exception e1) {
      }
    }
 else     if ("pin".equals(grant_type)) {
      try {
        user=management.verifyAppUserPinCredentials(services.getApplicationId(),username,pin);
      }
 catch (      Exception e1) {
      }
    }
 else     if ("client_credentials".equals(grant_type)) {
      try {
        AccessInfo access_info=management.authorizeClient(client_id,client_secret);
        if (access_info != null) {
          return new JSONWithPadding(Response.status(SC_OK).type(APPLICATION_JSON_TYPE).entity(mapToJsonString(access_info)).build(),callback);
        }
      }
 catch (      Exception e1) {
      }
    }
 else     if ("authorization_code".equals(grant_type)) {
      AccessInfo access_info=new AccessInfo();
      access_info.setAccessToken(code);
      return new JSONWithPadding(Response.status(SC_OK).type(APPLICATION_JSON_TYPE).entity(mapToJsonString(access_info)).build(),callback);
    }
    if (user == null) {
      OAuthResponse response=OAuthResponse.errorResponse(SC_BAD_REQUEST).setError(OAuthError.TokenResponse.INVALID_GRANT).setErrorDescription("invalid username or password").buildJSONMessage();
      return new JSONWithPadding(Response.status(response.getResponseStatus()).type(APPLICATION_JSON_TYPE).entity(response.getBody()).build(),callback);
    }
    AccessInfo access_info=new AccessInfo().withExpiresIn(3600).withAccessToken(management.getAccessTokenForAppUser(services.getApplicationId(),user.getUuid())).withProperty("user",user);
    return new JSONWithPadding(Response.status(SC_OK).type(APPLICATION_JSON_TYPE).entity(mapToJsonString(access_info)).build(),callback);
  }
 catch (  OAuthProblemException e) {
    logger.error("OAuth Error",e);
    OAuthResponse res=OAuthResponse.errorResponse(SC_BAD_REQUEST).error(e).buildJSONMessage();
    return new JSONWithPadding(Response.status(res.getResponseStatus()).type(APPLICATION_JSON_TYPE).entity(res.getBody()).build(),callback);
  }
}
