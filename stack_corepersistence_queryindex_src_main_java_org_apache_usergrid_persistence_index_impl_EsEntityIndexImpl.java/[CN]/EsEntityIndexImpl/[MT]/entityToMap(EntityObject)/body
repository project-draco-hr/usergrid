{
  Map<String,Object> entityMap=new HashMap<String,Object>();
  for (  Object f : entity.getFields().toArray()) {
    Field field=(Field)f;
    if (f instanceof ListField) {
      List list=(List)field.getValue();
      entityMap.put(field.getName(),new ArrayList(processCollectionForMap(list)));
      if (!list.isEmpty()) {
        if (list.get(0) instanceof String) {
          Joiner joiner=Joiner.on(" ").skipNulls();
          String joined=joiner.join(list);
          entityMap.put(field.getName() + ANALYZED_SUFFIX,new ArrayList(processCollectionForMap(list)));
        }
      }
    }
 else     if (f instanceof ArrayField) {
      List list=(List)field.getValue();
      entityMap.put(field.getName(),new ArrayList(processCollectionForMap(list)));
    }
 else     if (f instanceof SetField) {
      Set set=(Set)field.getValue();
      entityMap.put(field.getName(),new ArrayList(processCollectionForMap(set)));
    }
 else     if (f instanceof EntityObjectField) {
      EntityObject eo=(EntityObject)field.getValue();
      entityMap.put(field.getName(),entityToMap(eo));
    }
 else     if (f instanceof StringField) {
      entityMap.put(field.getName(),((String)field.getValue()).toLowerCase());
      entityMap.put(field.getName() + ANALYZED_SUFFIX,field.getValue());
    }
 else     if (f instanceof LocationField) {
      LocationField locField=(LocationField)f;
      Map<String,Object> locMap=new HashMap<String,Object>();
      locMap.put("lat",locField.getValue().getLatitude());
      locMap.put("lon",locField.getValue().getLongtitude());
      entityMap.put(field.getName() + GEO_SUFFIX,locMap);
    }
 else {
      entityMap.put(field.getName(),field.getValue());
    }
  }
  return entityMap;
}
