{
  if (log.isDebugEnabled()) {
    log.debug("Indexing entity {}:{} in scope\n   app {}\n   owner {}\n   name {}\n   type {}",new Object[]{entity.getId().getType(),entity.getId().getUuid(),indexScope.getApplication(),indexScope.getOwner(),indexScope.getName(),indexType});
  }
  ValidationUtils.verifyEntityWrite(entity);
  initType(indexType);
  StopWatch timer=null;
  if (log.isDebugEnabled()) {
    timer=new StopWatch();
    timer.start();
  }
  Map<String,Object> entityAsMap=EsEntityIndexImpl.entityToMap(entity);
  entityAsMap.put(ENTITYID_FIELDNAME,entity.getId().getUuid().toString());
  String indexId=EsEntityIndexImpl.this.createIndexDocId(entity);
  log.debug("Indexing entity id {} data {} ",indexId,entityAsMap);
  IndexRequestBuilder irb=client.prepareIndex(indexName,this.indexType,indexId).setSource(entityAsMap).setRefresh(refresh);
  irb.execute().actionGet();
  if (refresh) {
    refresh();
  }
  if (log.isDebugEnabled()) {
    timer.stop();
    double average=averageIndexTime.get();
    if (!averageIndexTime.compareAndSet(0,timer.getTime())) {
      averageIndexTime.compareAndSet(average,(average + timer.getTime()) / 2.0);
    }
    long count=indexedCount.addAndGet(1);
    if (count % 1000 == 0) {
      log.debug("Indexed {} entities, average time {}ms",count,averageIndexTime.get());
    }
  }
}
