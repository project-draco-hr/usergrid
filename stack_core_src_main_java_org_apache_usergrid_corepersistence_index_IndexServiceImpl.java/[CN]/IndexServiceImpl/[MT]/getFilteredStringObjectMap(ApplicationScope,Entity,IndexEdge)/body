{
  IndexOperation indexOperation=new IndexOperation();
  indexEdge.getNodeId().getUuid();
  Id mapOwner=new SimpleId(indexEdge.getNodeId().getUuid(),TYPE_APPLICATION);
  final MapScope ms=CpNamingUtils.getEntityTypeMapScope(mapOwner);
  MapManager mm=mapManagerFactory.createMapManager(ms);
  String jsonMap=mm.getString(indexEdge.getEdgeName().split("\\|")[1]);
  Set<String> defaultProperties=null;
  ArrayList fieldsToKeep=null;
  if (jsonMap != null) {
    Map jsonMapData=(Map)JsonUtils.parse(jsonMap);
    Schema schema=Schema.getDefaultSchema();
    defaultProperties=schema.getRequiredProperties(indexEdge.getEdgeName().split("\\|")[1]);
    fieldsToKeep=(ArrayList)jsonMapData.get("fields");
    defaultProperties.addAll(fieldsToKeep);
  }
 else   return null;
  Map<String,Object> map=indexOperation.convertedEntityToBeIndexed(applicationScope,indexEdge,entity);
  HashSet mapFields=(HashSet)map.get("fields");
  if (defaultProperties != null) {
    final Set<String> finalDefaultProperties=defaultProperties;
    Iterator collectionIterator=mapFields.iterator();
    while (collectionIterator.hasNext()) {
      EntityField testedField=(EntityField)collectionIterator.next();
      String fieldName=(String)(testedField).get("name");
      if (!finalDefaultProperties.contains(fieldName)) {
        boolean toRemoveFlag=true;
        String[] flattedStringArray=fieldName.split("\\.");
        Iterator fieldIterator=fieldsToKeep.iterator();
        while (fieldIterator.hasNext()) {
          String requiredInclusionString=(String)fieldIterator.next();
          String[] flattedRequirementString=new String[0];
          if (!requiredInclusionString.contains(".")) {
            flattedRequirementString=new String[]{requiredInclusionString};
          }
 else {
            flattedRequirementString=requiredInclusionString.split("\\.");
          }
          for (int index=0; index < flattedRequirementString.length; index++) {
            if (flattedStringArray.length <= index) {
              toRemoveFlag=true;
              break;
            }
            if (flattedRequirementString[index].equals(flattedStringArray[index])) {
              toRemoveFlag=false;
            }
 else {
              toRemoveFlag=true;
            }
          }
          if (toRemoveFlag == false) {
            break;
          }
        }
        if (toRemoveFlag) {
          mapFields.remove(testedField);
        }
      }
    }
  }
  return map;
}
