{
  final MigrationInfoSerialization serialization=mock(MigrationInfoSerialization.class);
  when(serialization.getCurrentVersion()).thenReturn(1);
  final CollectionDataMigration v1=mock(CollectionDataMigration.class);
  when(v1.getVersion()).thenReturn(2);
  when(v1.getType()).thenReturn(DataMigration.MigrationType.Entities);
  when(v1.migrate(any(Observable.class),any(DataMigration.ProgressObserver.class))).thenReturn(Observable.empty());
  final int returnedCode=100;
  final String reason="test reason";
  when(v1.migrate(any(Observable.class),any(DataMigration.ProgressObserver.class))).thenAnswer(new Answer<Object>(){
    @Override public Object answer(    final InvocationOnMock invocation) throws Throwable {
      final DataMigration.ProgressObserver progressObserver=(DataMigration.ProgressObserver)invocation.getArguments()[1];
      progressObserver.failed(returnedCode,reason);
      return null;
    }
  }
);
  final CollectionDataMigration v2=mock(CollectionDataMigration.class);
  when(v2.getVersion()).thenReturn(3);
  when(v2.getType()).thenReturn(DataMigration.MigrationType.Entities);
  when(v2.migrate(any(Observable.class),any(DataMigration.ProgressObserver.class))).thenReturn(Observable.empty());
  Set<CollectionDataMigration> collectionMigrations=new HashSet<>();
  collectionMigrations.add(v1);
  collectionMigrations.add(v2);
  Set<ApplicationDataMigration> applicationDataMigrations=new HashSet<>();
  DataMigrationManagerImpl migrationManager=new DataMigrationManagerImpl(serialization,applicationDataMigrations,collectionMigrations,allEntitiesInSystemObservable,allApplicationsObservable);
  migrationManager.migrate();
  verify(v1).migrate(any(Observable.class),any(DataMigration.ProgressObserver.class));
  verify(v2,never()).migrate(any(Observable.class),any(DataMigration.ProgressObserver.class));
  verify(serialization,times(1)).setStatusCode(DataMigrationManagerImpl.StatusCode.RUNNING.status);
  verify(serialization).setStatusMessage("Migration version 2.  Starting migration");
  verify(serialization).setStatusMessage("Migration version 100.  Failed to migrate, reason is appended.  Error 'test reason'");
  verify(serialization,times(2)).setStatusCode(DataMigrationManagerImpl.StatusCode.ERROR.status);
  verify(serialization,never()).setVersion(1);
  verify(serialization,never()).setVersion(2);
}
