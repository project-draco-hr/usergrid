{
  Preconditions.checkNotNull(entity,"entity should never be null");
  String type=entity.getType();
  Preconditions.checkNotNull(type,"entity type should never be null");
  Id appId=getApplicationScope().getApplication();
  Preconditions.checkNotNull(appId,"app scope should never be null");
  updateEntityMeter.mark();
  Id entityId=new SimpleId(entity.getUuid(),entity.getType());
  if (logger.isDebugEnabled()) {
    logger.debug("Updating entity {}:{}  app {}\n",entityId.getType(),entityId.getUuid(),appId);
  }
  org.apache.usergrid.persistence.model.entity.Entity cpEntity=new org.apache.usergrid.persistence.model.entity.Entity(entityId);
  cpEntity=CpEntityMapUtils.fromMap(cpEntity,entity.getProperties(),entity.getType(),true);
  try {
    cpEntity=ecm.write(cpEntity).toBlocking().last();
    if (logger.isDebugEnabled()) {
      logger.debug("Wrote {}:{} version {}",cpEntity.getId().getType(),cpEntity.getId().getUuid(),cpEntity.getVersion());
    }
  }
 catch (  WriteUniqueVerifyException wuve) {
    handleWriteUniqueVerifyException(entity,wuve);
  }
  indexService.queueEntityIndexUpdate(applicationScope,cpEntity);
}
