{
  CollectionScope collectionScope=new CollectionScopeImpl(getApplicationScope().getApplication(),getApplicationScope().getApplication(),CpNamingUtils.getCollectionScopeNameFromEntityType(entityRef.getType()));
  EntityCollectionManager ecm=managerCache.getEntityCollectionManager(collectionScope);
  Id entityId=new SimpleId(entityRef.getUuid(),entityRef.getType());
  org.apache.usergrid.persistence.model.entity.Entity entity=load(new EntityScope(collectionScope,entityId));
  if (entity != null) {
    RelationManager rm=getRelationManager(entityRef);
    Map<String,Map<UUID,Set<String>>> owners=rm.getOwners();
    logger.debug("Deleting indexes of all {} collections owning the entity",owners.keySet().size());
    final EntityIndex ei=managerCache.getEntityIndex(getApplicationScope());
    final EntityIndexBatch batch=ei.createBatch();
    for (    String ownerType : owners.keySet()) {
      Map<UUID,Set<String>> collectionsByUuid=owners.get(ownerType);
      for (      UUID uuid : collectionsByUuid.keySet()) {
        Set<String> collectionNames=collectionsByUuid.get(uuid);
        for (        String coll : collectionNames) {
          IndexScope indexScope=new IndexScopeImpl(new SimpleId(uuid,ownerType),CpNamingUtils.getCollectionScopeNameFromCollectionName(coll),entityType);
          batch.index(indexScope,entity);
        }
      }
    }
    IndexScope defaultIndexScope=new IndexScopeImpl(getApplicationScope().getApplication(),CpNamingUtils.getCollectionScopeNameFromEntityType(entityRef.getType()),entityType);
    batch.deindex(defaultIndexScope,entity);
    IndexScope allTypesIndexScope=new IndexScopeImpl(getApplicationScope().getApplication(),CpNamingUtils.ALL_TYPES,entityType);
    batch.deindex(allTypesIndexScope,entity);
    batch.execute();
    decrementEntityCollection(Schema.defaultCollectionName(entityId.getType()));
    return ecm.delete(entityId);
  }
 else {
    return Observable.empty();
  }
}
