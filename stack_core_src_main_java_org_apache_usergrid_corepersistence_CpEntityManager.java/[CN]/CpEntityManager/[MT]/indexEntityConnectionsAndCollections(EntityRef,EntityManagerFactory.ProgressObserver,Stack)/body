{
  final GraphManager gm=managerCache.getGraphManager(applicationScope);
  final Id fromEntityId=new SimpleId(entity.getUuid(),entity.getType());
  logger.debug("Loading edges types from {}:{}\n   scope {}:{}",new Object[]{entity.getType(),entity.getUuid(),applicationScope.getApplication().getType(),applicationScope.getApplication().getUuid()});
  Observable<String> edgeTypes=gm.getEdgeTypesFromSource(new SimpleSearchEdgeType(fromEntityId,null,null));
  edgeTypes.forEach(new Action1<String>(){
    @Override public void call(    final String edgeType){
      logger.debug("Loading edges of edgeType {} from {}:{}\n   scope {}:{}",new Object[]{edgeType,entity.getType(),entity.getUuid(),applicationScope.getApplication().getType(),applicationScope.getApplication().getUuid()});
      Observable<Edge> edges=gm.loadEdgesFromSource(new SimpleSearchByEdgeType(fromEntityId,edgeType,Long.MAX_VALUE,SearchByEdgeType.Order.DESCENDING,null));
      edges.forEach(new Action1<Edge>(){
        @Override public void call(        Edge edge){
          if (CpNamingUtils.isCollectionEdgeType(edge.getType())) {
            String collName=CpNamingUtils.getCollectionName(edgeType);
            String memberType=edge.getTargetNode().getType();
            CollectionScope collScope=new CollectionScopeImpl(applicationScope.getApplication(),applicationScope.getApplication(),CpNamingUtils.getCollectionScopeNameFromEntityType(entity.getType()));
            EntityCollectionManager collMgr=managerCache.getEntityCollectionManager(collScope);
            org.apache.usergrid.persistence.model.entity.Entity collEntity=collMgr.load(edge.getSourceNode()).toBlockingObservable().last();
            if (collEntity == null) {
              if (logger.isDebugEnabled()) {
                logger.error("FAILED to load entity {}:{} " + "from scope\n   app {}\n   owner {}\n   name {}",new Object[]{edge.getSourceNode().getType(),edge.getSourceNode().getUuid(),collScope.getApplication(),collScope.getOwner(),collScope.getName()});
              }
              return;
            }
            CollectionScope memberScope=new CollectionScopeImpl(applicationScope.getApplication(),applicationScope.getApplication(),CpNamingUtils.getCollectionScopeNameFromEntityType(memberType));
            EntityCollectionManager memberMgr=managerCache.getEntityCollectionManager(memberScope);
            org.apache.usergrid.persistence.model.entity.Entity memberEntity=memberMgr.load(edge.getTargetNode()).toBlockingObservable().last();
            if (memberEntity == null) {
              if (logger.isDebugEnabled()) {
                logger.error("FAILED to load entity {}:{} " + "from scope\n   app {}\n   owner {}\n   name {}",new Object[]{edge.getTargetNode().getType(),edge.getTargetNode().getUuid(),memberScope.getApplication(),memberScope.getOwner(),memberScope.getName()});
              }
              return;
            }
            indexEntityIntoCollections(collEntity,memberEntity,collName,true);
            EntityRef ref=new SimpleEntityRef(memberEntity.getId().getType(),memberEntity.getId().getUuid());
            po.onProgress(entity,ref,edge.getType());
            if (!stack.contains(ref)) {
              stack.push(ref);
              indexEntityConnectionsAndCollections(ref,po,stack);
              stack.pop();
            }
          }
 else           if (CpNamingUtils.isConnectionEdgeType(edge.getType())) {
            String connType=CpNamingUtils.getConnectionType(edgeType);
            String targetEntityType=edge.getTargetNode().getType();
            String sourceEntityType=entity.getType();
            CollectionScope sourceScope=new CollectionScopeImpl(applicationScope.getApplication(),applicationScope.getApplication(),CpNamingUtils.getCollectionScopeNameFromEntityType(sourceEntityType));
            EntityCollectionManager sourceEcm=managerCache.getEntityCollectionManager(sourceScope);
            org.apache.usergrid.persistence.model.entity.Entity sourceEntity=sourceEcm.load(edge.getSourceNode()).toBlockingObservable().last();
            if (sourceEntity == null) {
              if (logger.isDebugEnabled()) {
                logger.error("FAILED to load entity {}:{} " + "from scope\n   app {}\n   owner {}\n   name {}",new Object[]{edge.getSourceNode().getType(),edge.getSourceNode().getUuid(),sourceScope.getApplication(),sourceScope.getOwner(),sourceScope.getName()});
              }
              return;
            }
            CollectionScope targetScope=new CollectionScopeImpl(applicationScope.getApplication(),applicationScope.getApplication(),CpNamingUtils.getCollectionScopeNameFromEntityType(targetEntityType));
            EntityCollectionManager targetEcm=managerCache.getEntityCollectionManager(targetScope);
            org.apache.usergrid.persistence.model.entity.Entity targetEntity=targetEcm.load(edge.getTargetNode()).toBlockingObservable().last();
            if (targetEntity == null) {
              if (logger.isDebugEnabled()) {
                logger.error("FAILED to load entity {}:{} " + "from scope\n   app {}\n   owner {}\n   name {}",new Object[]{edge.getTargetNode().getType(),edge.getTargetNode().getUuid(),targetScope.getApplication(),targetScope.getOwner(),targetScope.getName()});
              }
              return;
            }
            indexEntityIntoConnection(sourceEntity,targetEntity,targetEntityType,connType);
            EntityRef ref=new SimpleEntityRef(targetEntity.getId().getType(),targetEntity.getId().getUuid());
            po.onProgress(entity,ref,edge.getType());
            if (!stack.contains(ref)) {
              stack.push(ref);
              indexEntityConnectionsAndCollections(ref,po,stack);
              stack.pop();
            }
          }
        }
      }
);
    }
  }
);
}
