{
  if (request.getRequestHeaders().containsKey(ACCESS_CONTROL_REQUEST_METHOD)) {
    for (    String value : request.getRequestHeaders().get(ACCESS_CONTROL_REQUEST_METHOD)) {
      response.getHttpHeaders().add(ACCESS_CONTROL_ALLOW_METHODS,value);
    }
  }
  if (request.getRequestHeaders().containsKey(ACCESS_CONTROL_REQUEST_HEADERS)) {
    for (    String value : request.getRequestHeaders().get(ACCESS_CONTROL_REQUEST_HEADERS)) {
      response.getHttpHeaders().add(ACCESS_CONTROL_ALLOW_HEADERS,value);
    }
  }
  boolean origin_sent=false;
  if (request.getRequestHeaders().containsKey(ORIGIN_HEADER)) {
    for (    String value : request.getRequestHeaders().get(ORIGIN_HEADER)) {
      if (!(value == null || "null".equalsIgnoreCase(value))) {
        origin_sent=true;
        response.getHttpHeaders().add(ACCESS_CONTROL_ALLOW_ORIGIN,value);
      }
    }
  }
  if (!origin_sent) {
    String origin=getOrigin(request);
    if (origin != null) {
      response.getHttpHeaders().add(ACCESS_CONTROL_ALLOW_CREDENTIALS,"true");
      response.getHttpHeaders().add(ACCESS_CONTROL_ALLOW_ORIGIN,origin);
    }
 else {
      if (!request.getRequestHeaders().containsKey(AUTHORIZATION_HEADER)) {
        response.getHttpHeaders().add(ACCESS_CONTROL_ALLOW_ORIGIN,"*");
      }
    }
  }
 else {
    response.getHttpHeaders().add(ACCESS_CONTROL_ALLOW_CREDENTIALS,"true");
  }
  return response;
}
