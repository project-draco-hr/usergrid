{
  String appName=buildAppName(organizationName,name);
  if (lookupApplication(appName) != null) {
    throw new ApplicationAlreadyExistsException(appName);
  }
  getSetup().setupApplicationKeyspace(applicationId,appName);
  UUID orgUuid=lookupOrganization(organizationName);
  if (orgUuid == null) {
    Entity orgInfoEntity=new Entity(generateOrgId(UUIDGenerator.newTimeUUID()));
    orgUuid=orgInfoEntity.getId().getUuid();
    long timestamp=System.currentTimeMillis();
    orgInfoEntity.setField(new LongField(PROPERTY_CREATED,(long)(timestamp / 1000)));
    orgInfoEntity.setField(new StringField(PROPERTY_NAME,name));
    orgInfoEntity.setField(new UUIDField(PROPERTY_UUID,orgUuid));
    EntityCollectionManager ecm=getManagerCache().getEntityCollectionManager(SYSTEM_ORGS_SCOPE);
    EntityIndex eci=getManagerCache().getEntityIndex(SYSTEM_ORGS_INDEX_SCOPE);
    orgInfoEntity=ecm.write(orgInfoEntity).toBlockingObservable().last();
    eci.index(orgInfoEntity);
    eci.refresh();
  }
  if (properties == null) {
    properties=new TreeMap<String,Object>(CASE_INSENSITIVE_ORDER);
  }
  properties.put(PROPERTY_NAME,appName);
  Entity appInfoEntity=new Entity(generateApplicationId(UUIDGenerator.newTimeUUID()));
  long timestamp=System.currentTimeMillis();
  appInfoEntity.setField(new LongField(PROPERTY_CREATED,(long)(timestamp / 1000)));
  appInfoEntity.setField(new StringField(PROPERTY_NAME,name));
  appInfoEntity.setField(new UUIDField(PROPERTY_UUID,applicationId));
  appInfoEntity.setField(new UUIDField("organizationUuid",orgUuid));
{
    EntityCollectionManager ecm=getManagerCache().getEntityCollectionManager(SYSTEM_APP_SCOPE);
    EntityIndex eci=getManagerCache().getEntityIndex(SYSTEM_APPS_INDEX_SCOPE);
    appInfoEntity=ecm.write(appInfoEntity).toBlockingObservable().last();
    eci.index(appInfoEntity);
    eci.refresh();
  }
  EntityManager em=getEntityManager(applicationId);
  em.create(TYPE_APPLICATION,APPLICATION_ENTITY_CLASS,properties);
  em.resetRoles();
  return applicationId;
}
