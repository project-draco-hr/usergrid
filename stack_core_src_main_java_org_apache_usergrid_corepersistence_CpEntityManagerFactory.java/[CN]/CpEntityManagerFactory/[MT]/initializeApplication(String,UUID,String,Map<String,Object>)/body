{
  init();
  EntityManager em=getEntityManager(CpNamingUtils.SYSTEM_APP_ID);
  final String appName=buildAppName(organizationName,name);
  if (lookupApplication(appName) != null) {
    throw new ApplicationAlreadyExistsException(appName);
  }
  getSetup().setupApplicationKeyspace(applicationId,appName);
  final Optional<UUID> cachedValue=orgApplicationCache.getOrganizationId(organizationName);
  UUID orgUuid;
  if (!cachedValue.isPresent()) {
    final String orgName=organizationName;
    try {
      final Entity orgInfo=em.create("organization",new HashMap<String,Object>(){
{
          put(PROPERTY_NAME,orgName);
        }
      }
);
      orgUuid=orgInfo.getUuid();
      orgApplicationCache.evictOrgId(name);
    }
 catch (    DuplicateUniquePropertyExistsException e) {
      orgApplicationCache.evictOrgId(organizationName);
      orgUuid=orgApplicationCache.getOrganizationId(organizationName).get();
    }
  }
 else {
    orgUuid=cachedValue.get();
  }
  final UUID appId=applicationId;
  final UUID orgId=orgUuid;
  Map<String,Object> appInfoMap=new HashMap<String,Object>(){
{
      put(PROPERTY_NAME,appName);
      put("applicationUuid",appId);
      put("organizationUuid",orgId);
    }
  }
;
  try {
    em.create("appinfo",appInfoMap);
  }
 catch (  DuplicateUniquePropertyExistsException e) {
    throw new ApplicationAlreadyExistsException(appName);
  }
  em.refreshIndex();
  if (properties == null) {
    properties=new TreeMap<String,Object>(CASE_INSENSITIVE_ORDER);
  }
  properties.put(PROPERTY_NAME,appName);
  EntityManager appEm=getEntityManager(applicationId);
  appEm.create(applicationId,TYPE_APPLICATION,properties);
  appEm.resetRoles();
  appEm.refreshIndex();
  logger.info("Initialized application {}",appName);
  orgApplicationCache.evictAppId(appName);
  return applicationId;
}
