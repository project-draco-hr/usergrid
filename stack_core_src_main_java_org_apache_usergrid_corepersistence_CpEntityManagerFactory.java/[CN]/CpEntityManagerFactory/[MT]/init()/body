{
  EntityManager em=getEntityManager(getManagementAppId());
  try {
    if (em.getApplication() == null) {
      logger.info("Creating management application");
      Map mgmtAppProps=new HashMap<String,Object>();
      mgmtAppProps.put(PROPERTY_NAME,"systemapp");
      em.create(getManagementAppId(),TYPE_APPLICATION,mgmtAppProps);
      em.getApplication();
    }
    ApplicationScope appScope=new ApplicationScopeImpl(new SimpleId(CpNamingUtils.SYSTEM_APP_ID,"application"));
    ApplicationEntityIndex applicationEntityIndex=entityIndexFactory.createApplicationEntityIndex(appScope);
    applicationEntityIndex.initializeIndex();
    entityIndex.refresh();
  }
 catch (  Exception ex) {
    throw new RuntimeException("Fatal error creating system application",ex);
  }
}
