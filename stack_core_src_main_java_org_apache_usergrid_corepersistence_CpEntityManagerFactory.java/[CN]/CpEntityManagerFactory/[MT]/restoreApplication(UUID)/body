{
  EntityManager em=getEntityManager(getManagementAppId());
  final Results results=em.searchCollection(em.getApplicationRef(),CpNamingUtils.DELETED_APPLICATION_INFOS,Query.fromQL("select * where " + PROPERTY_APPLICATION_ID + " = "+ applicationId.toString()));
  Entity deletedAppInfo=results.getEntity();
  if (deletedAppInfo == null) {
    throw new EntityNotFoundException("Cannot restore. Deleted Application not found: " + applicationId);
  }
  Entity restoredAppInfo=em.create(deletedAppInfo.getUuid(),CpNamingUtils.APPLICATION_INFO,deletedAppInfo.getProperties());
  final Set<String> connectionTypes=em.getConnectionTypes(deletedAppInfo);
  for (  String connType : connectionTypes) {
    final Results connResults=em.getConnectedEntities(deletedAppInfo,connType,null,Query.Level.ALL_PROPERTIES);
    for (    Entity entity : connResults.getEntities()) {
      em.createConnection(restoredAppInfo,connType,entity);
    }
  }
  em.delete(deletedAppInfo);
  this.rebuildApplicationIndexes(applicationId,new ProgressObserver(){
    @Override public void onProgress(    EntityRef entity){
      logger.info("Restored entity {}:{}",entity.getType(),entity.getUuid());
    }
  }
);
  return restoredAppInfo;
}
