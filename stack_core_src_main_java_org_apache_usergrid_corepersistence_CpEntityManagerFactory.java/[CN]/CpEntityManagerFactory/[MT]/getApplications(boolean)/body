{
  Map<String,UUID> appMap=new HashMap<String,UUID>();
  ApplicationScope appScope=CpNamingUtils.getApplicationScope(getManagementAppId());
  GraphManager gm=managerCache.getGraphManager(appScope);
  EntityManager em=getEntityManager(getManagementAppId());
  Application app=em.getApplication();
  Id fromEntityId=new SimpleId(app.getUuid(),app.getType());
  final String scopeName;
  final String edgeType;
  if (deleted) {
    edgeType=CpNamingUtils.getEdgeTypeFromCollectionName(CpNamingUtils.DELETED_APPLICATION_INFOS);
    scopeName=CpNamingUtils.getCollectionScopeNameFromCollectionName(CpNamingUtils.DELETED_APPLICATION_INFOS);
  }
 else {
    edgeType=CpNamingUtils.getEdgeTypeFromCollectionName(CpNamingUtils.APPLICATION_INFOS);
    scopeName=CpNamingUtils.getCollectionScopeNameFromCollectionName(CpNamingUtils.APPLICATION_INFOS);
  }
  logger.debug("getApplications(): Loading edges of edgeType {} from {}:{}",new Object[]{edgeType,fromEntityId.getType(),fromEntityId.getUuid()});
  Observable<Edge> edges=gm.loadEdgesFromSource(new SimpleSearchByEdgeType(fromEntityId,edgeType,Long.MAX_VALUE,SearchByEdgeType.Order.DESCENDING,null));
  Iterator<Edge> iter=edges.toBlockingObservable().getIterator();
  while (iter.hasNext()) {
    Edge edge=iter.next();
    Id targetId=edge.getTargetNode();
    logger.debug("getApplications(): Processing edge from {}:{} to {}:{}",new Object[]{edge.getSourceNode().getType(),edge.getSourceNode().getUuid(),edge.getTargetNode().getType(),edge.getTargetNode().getUuid()});
    CollectionScope collScope=new CollectionScopeImpl(appScope.getApplication(),appScope.getApplication(),scopeName);
    org.apache.usergrid.persistence.model.entity.Entity e=managerCache.getEntityCollectionManager(collScope).load(targetId).toBlockingObservable().lastOrDefault(null);
    if (e == null) {
      logger.warn("Application {} in index but not found in collections",targetId);
      continue;
    }
    appMap.put((String)e.getField(PROPERTY_NAME).getValue(),e.getId().getUuid());
  }
  return appMap;
}
