{
  Map<String,UUID> appMap=new HashMap<>();
  ApplicationScope appScope=CpNamingUtils.getApplicationScope(CpNamingUtils.SYSTEM_APP_ID);
  GraphManager gm=managerCache.getGraphManager(appScope);
  EntityManager em=getEntityManager(CpNamingUtils.SYSTEM_APP_ID);
  Application app=em.getApplication();
  if (app == null)   throw new RuntimeException("System App " + CpNamingUtils.SYSTEM_APP_ID + " should never be null");
  Id fromEntityId=new SimpleId(app.getUuid(),app.getType());
  final String edgeType;
  if (deleted) {
    edgeType=CpNamingUtils.getEdgeTypeFromCollectionName(CpNamingUtils.DELETED_APPLICATION_INFO);
  }
 else {
    edgeType=CpNamingUtils.getEdgeTypeFromCollectionName(CpNamingUtils.APPLICATION_INFOS);
  }
  logger.debug("getApplications(): Loading edges of edgeType {} from {}:{}",new Object[]{edgeType,fromEntityId.getType(),fromEntityId.getUuid()});
  Observable<Edge> edges=gm.loadEdgesFromSource(new SimpleSearchByEdgeType(fromEntityId,edgeType,Long.MAX_VALUE,SearchByEdgeType.Order.DESCENDING,null));
  Iterator<Edge> iter=edges.toBlocking().getIterator();
  while (iter.hasNext()) {
    Edge edge=iter.next();
    Id targetId=edge.getTargetNode();
    logger.debug("getApplications(): Processing edge from {}:{} to {}:{}",new Object[]{edge.getSourceNode().getType(),edge.getSourceNode().getUuid(),edge.getTargetNode().getType(),edge.getTargetNode().getUuid()});
    org.apache.usergrid.persistence.model.entity.Entity appInfo=managerCache.getEntityCollectionManager(appScope).load(targetId).toBlocking().lastOrDefault(null);
    if (appInfo == null) {
      logger.warn("Application {} in index but not found in collections",targetId);
      continue;
    }
    UUID applicationId=UUIDUtils.tryExtractUUID(appInfo.getField(PROPERTY_APPLICATION_ID).getValue().toString());
    appMap.put((String)appInfo.getField(PROPERTY_NAME).getValue(),applicationId);
  }
  return appMap;
}
