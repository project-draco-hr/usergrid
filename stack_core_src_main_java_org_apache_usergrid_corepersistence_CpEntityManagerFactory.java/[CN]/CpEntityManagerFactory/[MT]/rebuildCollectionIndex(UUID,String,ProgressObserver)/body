{
  logger.info("Reindexing collection: {} for app id: {}",collectionName,appId);
  EntityManager em=getEntityManager(appId);
  Application app=em.getApplication();
  Query query=new Query();
  query.setLimit(REBUILD_PAGE_SIZE);
  Results r=null;
  do {
    r=em.searchCollection(app,collectionName,query);
    for (    org.apache.usergrid.persistence.Entity entity : r.getEntities()) {
      logger.info("   Updating Entity name {}, type: {}, id: {} in app id: {}",new Object[]{entity.getName(),entity.getType(),entity.getUuid(),appId});
      try {
        em.update(entity);
        if (po != null) {
          po.onProgress();
        }
      }
 catch (      DuplicateUniquePropertyExistsException dupee) {
        logger.error("   Duplicate property for type: {} with id: {} for app id: {}.  " + "Property name: {} , value: {}",new Object[]{entity.getType(),entity.getUuid(),appId,dupee.getPropertyName(),dupee.getPropertyValue()});
      }
    }
    query.setCursor(r.getCursor());
  }
 while (r != null && r.size() == REBUILD_PAGE_SIZE);
}
