{
  String appName=buildAppName(organizationName,name);
  if (lookupApplication(appName).isPresent()) {
    throw new ApplicationAlreadyExistsException(appName);
  }
  if (properties == null) {
    properties=new TreeMap<String,Object>(CASE_INSENSITIVE_ORDER);
  }
  properties.put(PROPERTY_NAME,appName);
  getSetup().setupApplicationKeyspace(applicationId,appName);
  Keyspace ko=cass.getUsergridApplicationKeyspace();
  Mutator<ByteBuffer> m=CountingMutator.createFlushingMutator(ko,be);
  long timestamp=cass.createTimestamp();
  addInsertToMutator(m,APPLICATIONS_CF,appName,PROPERTY_UUID,applicationId,timestamp);
  addInsertToMutator(m,APPLICATIONS_CF,appName,PROPERTY_NAME,appName,timestamp);
  batchExecute(m,RETRY_COUNT);
  EntityManager em=getEntityManager(applicationId);
  em.create(TYPE_APPLICATION,APPLICATION_ENTITY_CLASS,properties);
  em.resetRoles();
  return applicationId;
}
