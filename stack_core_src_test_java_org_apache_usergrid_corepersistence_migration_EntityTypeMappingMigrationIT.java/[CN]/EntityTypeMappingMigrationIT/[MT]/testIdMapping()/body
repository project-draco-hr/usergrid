{
  assertEquals("version 1 expected",1,entityTypeMappingMigration.getVersion());
  final EntityManager newAppEm=app.getEntityManager();
  final String type1="type1thing";
  final String type2="type2thing";
  final int size=10;
  final Set<Id> type1Identities=EntityWriteHelper.createTypes(newAppEm,type1,size);
  final Set<Id> type2Identities=EntityWriteHelper.createTypes(newAppEm,type2,size);
  final Set<Id> allEntities=new HashSet<>();
  allEntities.addAll(type1Identities);
  allEntities.addAll(type2Identities);
  keyspace.dropColumnFamily(MapSerializationImpl.MAP_ENTRIES);
  keyspace.dropColumnFamily(MapSerializationImpl.MAP_KEYS);
  migrationManager.migrate();
  final TestProgressObserver progressObserver=new TestProgressObserver();
  entityTypeMappingMigration.migrate(progressObserver);
  AllEntitiesInSystemObservable.getAllEntitiesInSystem(managerCache).doOnNext(new Action1<AllEntitiesInSystemObservable.EntityData>(){
    @Override public void call(    final AllEntitiesInSystemObservable.EntityData entity){
      try {
        final EntityManager em=emf.getEntityManager(entity.applicationScope.getApplication().getUuid());
        final Entity returned=em.get(entity.entityId.getUuid());
        if (returned != null) {
          assertEquals(entity.entityId.getUuid(),returned.getUuid());
          assertEquals(entity.entityId.getType(),returned.getType());
        }
 else {
          final String type=managerCache.getMapManager(CpNamingUtils.getEntityTypeMapScope(entity.applicationScope.getApplication())).getString(entity.entityId.getUuid().toString());
          assertEquals(entity.entityId.getType(),type);
        }
      }
 catch (      Exception e) {
        throw new RuntimeException("Unable to get entity " + entity.entityId + " by UUID, migration failed",e);
      }
      allEntities.remove(entity.entityId);
    }
  }
).toBlocking().lastOrDefault(null);
  assertEquals("Every element should have been encountered",0,allEntities.size());
  assertFalse("Progress observer should not have failed",progressObserver.getFailed());
  assertTrue("Progress observer should have update messages",progressObserver.getUpdates().size() > 0);
}
