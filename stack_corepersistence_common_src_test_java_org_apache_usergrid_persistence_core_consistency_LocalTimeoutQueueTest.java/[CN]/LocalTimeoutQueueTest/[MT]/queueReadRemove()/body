{
  TimeService timeService=Mockito.mock(TimeService.class);
  final long time=1000l;
  final long timeout=1000;
  Mockito.when(timeService.getCurrentTime()).thenReturn(time);
  TimeoutQueue<TestEvent> queue=new LocalTimeoutQueue<TestEvent>(timeService);
  final TestEvent event=new TestEvent();
  AsynchronousMessage<TestEvent> asynchronousMessage=queue.queue(event,timeout);
  assertNotNull(asynchronousMessage);
  assertEquals(event,asynchronousMessage.getEvent());
  assertEquals(time + timeout,asynchronousMessage.getTimeout());
  Collection<AsynchronousMessage<TestEvent>> results=queue.take(100,timeout);
  assertEquals("Time not yet elapsed",0,results.size());
  final long firstTime=time + timeout;
  Mockito.when(timeService.getCurrentTime()).thenReturn(firstTime);
  results=queue.take(100,timeout);
  assertEquals("Time elapsed",1,results.size());
  Iterator<AsynchronousMessage<TestEvent>> events=results.iterator();
  AsynchronousMessage<TestEvent> message=events.next();
  assertEquals(event,message.getEvent());
  assertEquals(firstTime + timeout,message.getTimeout());
  queue.remove(message);
  Mockito.when(timeService.getCurrentTime()).thenReturn(firstTime * 20);
  results=queue.take(100,timeout);
  assertEquals("Queue now empty",0,results.size());
}
