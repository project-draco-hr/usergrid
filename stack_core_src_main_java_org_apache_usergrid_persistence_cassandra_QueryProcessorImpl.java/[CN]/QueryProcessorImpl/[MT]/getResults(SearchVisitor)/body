{
  if (rootNode == null) {
    return null;
  }
  rootNode.visit(visitor);
  ResultIterator itr=visitor.getResults();
  List<ScanColumn> entityIds=new ArrayList<ScanColumn>(Math.min(size,Query.MAX_LIMIT));
  CursorCache resultsCursor=new CursorCache();
  while (entityIds.size() < size && itr.hasNext()) {
    entityIds.addAll(itr.next());
  }
  if (entityIds.size() > 0) {
    int resultSize=Math.min(entityIds.size(),size);
    entityIds=entityIds.subList(0,resultSize);
    if (resultSize == size) {
      itr.finalizeCursor(resultsCursor,entityIds.get(resultSize - 1).getUUID());
    }
  }
  if (logger.isDebugEnabled()) {
    logger.debug("Getting result for query: [{}],  returning entityIds size: {}",getQuery(),entityIds.size());
  }
  final ResultsLoader loader=loaderFactory.getResultsLoader(em,query,query.getResultsLevel());
  final Results results=loader.getResults(entityIds,query.getEntityType());
  if (results == null) {
    return null;
  }
  results.setCursor(resultsCursor.asString());
  results.setQuery(query);
  return results;
}
