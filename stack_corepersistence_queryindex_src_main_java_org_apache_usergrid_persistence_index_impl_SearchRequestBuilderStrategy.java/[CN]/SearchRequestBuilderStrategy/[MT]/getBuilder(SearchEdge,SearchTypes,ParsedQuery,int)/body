{
  Preconditions.checkArgument(limit <= EntityIndex.MAX_LIMIT,"limit is greater than max " + EntityIndex.MAX_LIMIT);
  SearchRequestBuilder srb=esProvider.getClient().prepareSearch(alias.getReadAlias()).setTypes(IndexingUtils.ES_ENTITY_TYPE).setScroll(cursorTimeout + "m");
  final QueryVisitor visitor=visitParsedQuery(query);
  final Optional<QueryBuilder> queryBuilder=visitor.getQueryBuilder();
  if (queryBuilder.isPresent()) {
    srb.setQuery(queryBuilder.get());
  }
  srb.setPostFilter(createFilterBuilder(searchEdge,visitor,searchTypes));
  srb=srb.setFrom(0).setSize(limit);
  if (query.getSortPredicates().size() == 0) {
    srb.addSort(SortBuilders.fieldSort(IndexingUtils.EDGE_TIMESTAMP_FIELDNAME).order(SortOrder.DESC));
    srb.addSort(SortBuilders.fieldSort(IndexingUtils.ENTITY_ID_FIELDNAME).order(SortOrder.ASC));
  }
  for (  SortPredicate sp : query.getSortPredicates()) {
    final SortOrder order=sp.getDirection().toEsSort();
    final String propertyName=sp.getPropertyName();
    srb.addSort(createSort(order,IndexingUtils.FIELD_STRING_NESTED,propertyName));
    srb.addSort(createSort(order,IndexingUtils.FIELD_DOUBLE_NESTED,propertyName));
    srb.addSort(createSort(order,IndexingUtils.FIELD_BOOLEAN_NESTED,propertyName));
    srb.addSort(createSort(order,IndexingUtils.FIELD_LONG_NESTED,propertyName));
  }
  return srb;
}
