{
  logger.debug("ServiceResource.executeServiceRequest");
  boolean tree="true".equalsIgnoreCase(ui.getQueryParameters().getFirst("tree"));
  addQueryParams(getServiceParameters(),ui);
  ServiceRequest r=services.newRequest(action,tree,getServiceParameters(),payload);
  response.setServiceRequest(r);
  ServiceResults results=r.execute();
  if (results != null) {
    if (results.hasData()) {
      response.setData(results.getData());
    }
    if (results.getServiceMetadata() != null) {
      response.setMetadata(results.getServiceMetadata());
    }
    Query query=r.getLastQuery();
    if (query != null) {
      query=new Query(query);
      query.setIdsOnly(false);
      if (query.hasSelectSubjects()) {
        response.setList(query.getSelectionResults(results));
        response.setNext(results.getNextResult());
        response.setPath(results.getPath());
        return results;
      }
    }
    response.setResults(results);
  }
  httpServletRequest.setAttribute("applicationId",services.getApplicationId());
  return results;
}
