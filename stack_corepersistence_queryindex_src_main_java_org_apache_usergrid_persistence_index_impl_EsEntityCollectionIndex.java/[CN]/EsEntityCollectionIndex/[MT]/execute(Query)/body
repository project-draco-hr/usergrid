{
  QueryBuilder qb=query.createQueryBuilder();
  logger.debug("Executing query: " + qb.toString());
  SearchRequestBuilder srb=client.prepareSearch(index).setTypes(scope.getName()).setQuery(qb).setFrom(0).setSize(query.getLimit());
  for (  Query.SortPredicate sp : query.getSortPredicates()) {
    final SortOrder order;
    if (sp.getDirection().equals(Query.SortDirection.ASCENDING)) {
      order=SortOrder.ASC;
    }
 else {
      order=SortOrder.DESC;
    }
    srb.addSort(sp.getPropertyName(),order);
  }
  SearchResponse sr=srb.execute().actionGet();
  SearchHits hits=sr.getHits();
  logger.debug("   Hit count: " + hits.getTotalHits());
  Results results=new Results();
  List<Entity> entities=new ArrayList<Entity>();
  for (  SearchHit hit : hits.getHits()) {
    String[] idparts=hit.getId().split("\\|");
    String id=idparts[0];
    String type=idparts[1];
    String version=idparts[2];
    Id entityId=new SimpleId(UUID.fromString(id),type);
    UUID entityVersion=UUID.fromString(version);
    Entity entity=manager.load(entityId).toBlockingObservable().last();
    if (entity == null) {
      throw new RuntimeException("Entity id [" + entityId + "] not found");
    }
    if (entityVersion.compareTo(entity.getVersion()) == -1) {
      logger.debug("   Stale hit " + hit.getId());
    }
 else {
      entities.add(entity);
    }
  }
  if (entities.size() == 1) {
    results.setEntity(entities.get(0));
  }
 else {
    logger.debug("   Returning " + entities.size() + " entities");
    results.setEntities(entities);
  }
  return results;
}
