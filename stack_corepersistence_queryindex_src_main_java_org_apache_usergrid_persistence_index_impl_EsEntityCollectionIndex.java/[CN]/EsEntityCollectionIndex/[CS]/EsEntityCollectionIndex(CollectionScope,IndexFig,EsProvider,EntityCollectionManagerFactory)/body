{
  this.manager=factory.createCollectionManager(scope);
  this.client=provider.getClient();
  this.scope=scope;
  this.index=config.getIndexName();
  this.refresh=config.isForcedRefresh();
  this.cursorTimeout=config.getQueryCursorTimeout();
  AdminClient admin=client.admin();
  if (!admin.indices().exists(new IndicesExistsRequest(index)).actionGet().isExists()) {
    admin.indices().prepareCreate(index).execute().actionGet();
    log.debug("Created new index: " + index);
  }
  if (!admin.indices().typesExists(new TypesExistsRequest(new String[]{index},scope.getName())).actionGet().isExists()) {
    try {
      XContentBuilder mxcb=EsEntityCollectionIndex.createDoubleStringIndexMapping(jsonBuilder(),scope.getName());
      PutMappingResponse pmr=admin.indices().preparePutMapping(index).setType(scope.getName()).setSource(mxcb).execute().actionGet();
      log.debug("Created new type mapping for scope: " + scope.getName());
      log.debug("   Scope organization: " + scope.getOrganization());
      log.debug("   Scope owner: " + scope.getOwner());
    }
 catch (    IOException ex) {
      throw new RuntimeException("Error adding mapping for type " + scope.getName(),ex);
    }
  }
}
