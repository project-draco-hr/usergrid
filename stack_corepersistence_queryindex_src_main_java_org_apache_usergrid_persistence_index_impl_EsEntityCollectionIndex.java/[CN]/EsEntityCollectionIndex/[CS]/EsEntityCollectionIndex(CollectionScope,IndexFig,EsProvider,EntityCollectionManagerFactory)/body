{
  this.manager=factory.createCollectionManager(scope);
  this.client=provider.getClient();
  this.scope=scope;
  this.indexName=config.getIndexName();
  this.typeName=createTypeName(scope);
  this.refresh=config.isForcedRefresh();
  this.cursorTimeout=config.getQueryCursorTimeout();
  AdminClient admin=client.admin();
  if (!admin.indices().exists(new IndicesExistsRequest(indexName)).actionGet().isExists()) {
    admin.indices().prepareCreate(indexName).execute().actionGet();
    log.debug("Created new index: " + indexName);
  }
  if (!admin.indices().typesExists(new TypesExistsRequest(new String[]{indexName},typeName)).actionGet().isExists()) {
    try {
      XContentBuilder mxcb=EsEntityCollectionIndex.createDoubleStringIndexMapping(jsonBuilder(),scope.getName());
      PutMappingResponse pmr=admin.indices().preparePutMapping(indexName).setType(scope.getName()).setSource(mxcb).execute().actionGet();
      log.debug("Created new type mapping for scope named: " + scope.getName());
      log.debug("   Scope organization: " + scope.getOrganization());
      log.debug("   Scope owner: " + scope.getOwner());
      log.debug("   Type name: " + typeName);
    }
 catch (    IOException ex) {
      throw new RuntimeException("Error adding mapping for type " + scope.getName(),ex);
    }
  }
}
