{
  this.app().token().clearToken();
  this.app().token().post(new Token(user1.getUsername(),"password"));
  Entity data=this.app().collection("restaurants").post(new Entity().chainPut("name","4peaks"));
  refreshIndex();
  data=usersResource.entity("me").connection("likes").collection("restaurants").entity("4peaks").post();
  refreshIndex();
  String peaksId=data.getUuid().toString();
  this.app().token().clearToken();
  this.app().token().post(new Token(user2.getUsername(),"password"));
  data=this.app().collection("restaurants").post(new Entity().chainPut("name","arrogantbutcher"));
  refreshIndex();
  data=usersResource.entity("me").connection("likes").collection("restaurants").entity("arrogantbutcher").post();
  refreshIndex();
  String arrogantButcherId=data.getUuid().toString();
  this.app().token().post(new Token(user1.getUsername(),"password"));
  CollectionEndpoint likeRestaurants=usersResource.entity("me").connection("likes").collection("restaurants");
  data=likeRestaurants.entity(peaksId).get();
  assertNotNull(data);
  assertEquals("4peaks",data.get("name").toString());
  data=likeRestaurants.entity("4peaks").get();
  assertNotNull(data);
  assertEquals("4peaks",data.get("name").toString());
  data=likeRestaurants.entity("arrogantbutcher").get();
  assertNull(data);
  data=likeRestaurants.entity(arrogantButcherId).get();
  assertNull(data);
  Collection collectionData=likeRestaurants.get();
  assertEquals("4peaks",collectionData.next().get("name").toString());
  assertNull(collectionData.next());
  this.app().token().post(new Token(user2.getUsername(),"password"));
  likeRestaurants=usersResource.entity("me").connection("likes").collection("restaurants");
  data=likeRestaurants.entity(arrogantButcherId).get();
  assertNotNull(data);
  assertEquals("arrogantbutcher",data.get("name").toString());
  data=likeRestaurants.entity("arrogantbutcher").get();
  assertNotNull(data);
  assertEquals("arrogantbutcher",data.get("name").toString());
  data=likeRestaurants.entity("4peaks").get();
  assertNull(data);
  data=likeRestaurants.entity(peaksId).get();
  assertNull(data);
  collectionData=likeRestaurants.get();
  assertEquals("arrogantbutcher",collectionData.next().get("name").toString());
  assertNull(collectionData.next());
  this.app().token().post(new Token(user1.getUsername(),"password"));
  CollectionEndpoint restaurants=this.app().collection("restaurants");
  data=restaurants.entity("4peaks").get();
  assertNotNull(data);
  assertEquals("4peaks",data.get("name").toString());
  data=restaurants.entity("arrogantbutcher").get();
  assertNotNull(data);
  assertEquals("arrogantbutcher",data.get("name").toString());
  this.app().token().post(new Token(user2.getUsername(),"password"));
  restaurants=this.app().collection("restaurants");
  data=restaurants.entity("4peaks").get();
  assertNotNull(data);
  assertEquals("4peaks",data.get("name").toString());
  data=restaurants.entity("arrogantbutcher").get();
  assertNotNull(data);
  assertEquals("arrogantbutcher",data.get("name").toString());
}
