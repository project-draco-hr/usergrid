{
  Queue queue=context.application().queues().queue("test");
  final int count=100;
  @SuppressWarnings("unchecked") Map<String,?>[] data=new Map[count];
  for (int i=0; i < count; i++) {
    data[i]=MapUtils.hashMap("id",i);
  }
  queue.post(data);
  final long timeout=20000;
  queue=queue.withTimeout(timeout).withLimit(50);
  TransactionResponseHandler transHandler=new TransactionResponseHandler(count);
  testMessages(queue,transHandler,new NoLastCommand());
  long start=System.currentTimeMillis();
  transHandler.assertResults();
  List<String> originalMessageIds=transHandler.getMessageIds();
  BiMap<String,String> transactionInfo=transHandler.getTransactionToMessageId();
  for (  String originalMessageId : originalMessageIds) {
    assertEquals(originalMessageId,originalMessageId);
    assertNotNull(transactionInfo.get(originalMessageId));
    Transaction transaction=queue.transactions().transaction(transactionInfo.get(originalMessageId));
    transaction.delete();
  }
  Thread.sleep(Math.max(0,timeout - (System.currentTimeMillis() - start)));
  IncrementHandler incrementHandler=new IncrementHandler(0);
  testMessages(queue,incrementHandler,new NoLastCommand());
  incrementHandler.assertResults();
}
