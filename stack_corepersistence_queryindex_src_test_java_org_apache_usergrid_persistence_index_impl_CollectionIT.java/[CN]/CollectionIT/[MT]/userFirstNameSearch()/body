{
  String firstName="firstName" + UUIDUtils.newTimeUUID();
  Map<String,Object> properties=new LinkedHashMap<String,Object>();
  properties.put("username","edanuff");
  properties.put("email","ed@anuff.com");
  properties.put("firstname",firstName);
  Entity user=em.create("user",properties);
  assertNotNull(user);
  Query query=new Query();
  query.addEqualityFilter("firstname",firstName);
  Results r=em.searchCollection(em.getApplicationRef(),"users",query);
  assertTrue(r.size() > 0);
  Entity returned=r.getEntities().get(0);
  assertEquals(user.getId(),returned.getId());
  String newFirstName="firstName" + UUIDUtils.newTimeUUID();
  user.setField(new StringField("firstname",newFirstName));
  em.update(user);
  query=new Query();
  query.addEqualityFilter("firstname",firstName);
  r=em.searchCollection(em.getApplicationRef(),"users",query);
  assertEquals(0,r.size());
  query=new Query();
  query.addEqualityFilter("firstname",newFirstName);
  r=em.searchCollection(em.getApplicationRef(),"users",query);
  assertTrue(r.size() > 0);
  returned=r.getEntities().get(0);
  assertEquals(user.getId(),returned.getId());
}
