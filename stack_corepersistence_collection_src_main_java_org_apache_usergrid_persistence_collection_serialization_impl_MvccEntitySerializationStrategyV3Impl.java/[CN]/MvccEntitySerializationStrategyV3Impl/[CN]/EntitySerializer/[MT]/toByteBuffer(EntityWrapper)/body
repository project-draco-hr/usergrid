{
  if (wrapper == null) {
    return null;
  }
  FieldBufferBuilder builder=new FieldBufferBuilder(3);
  builder.addByte(VERSION);
  builder.addUUID(wrapper.version);
  if (!wrapper.entity.isPresent()) {
    builder.addByte(STATE_DELETED);
    return FIELD_BUFFER_SERIALIZER.toByteBuffer(builder.build());
  }
  if (wrapper.status != MvccEntity.Status.COMPLETE) {
    throw new UnsupportedOperationException("Only states " + MvccEntity.Status.DELETED + " and "+ MvccEntity.Status.COMPLETE+ " are supported");
  }
  builder.addByte(STATE_COMPLETE);
  final Entity entity=wrapper.entity.get();
  final EntityMap entityMap=EntityMap.fromEntity(entity);
  final byte[] entityBytes;
  try {
    entityBytes=MAPPER.writeValueAsBytes(entityMap);
  }
 catch (  Exception e) {
    throw new RuntimeException("Unable to serialize entity",e);
  }
  final int maxEntrySize=serializationFig.getMaxEntitySize();
  if (entityBytes.length > maxEntrySize) {
    throw new EntityTooLargeException(entity,maxEntrySize,entityBytes.length,"Your entity cannot exceed " + maxEntrySize + " bytes. The entity you tried to save was "+ entityBytes.length+ " bytes");
  }
  builder.addBytes(entityBytes);
  return FIELD_BUFFER_SERIALIZER.toByteBuffer(builder.build());
}
