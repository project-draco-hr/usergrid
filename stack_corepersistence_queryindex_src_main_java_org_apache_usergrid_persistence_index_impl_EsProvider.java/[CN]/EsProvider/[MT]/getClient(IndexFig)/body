{
  if (client == null) {
    Client newClient=null;
    if (fig.isEmbedded()) {
      int port=AvailablePortFinder.getNextAvailable(2000);
      File tempDir;
      try {
        tempDir=getTempDirectory();
      }
 catch (      IOException ex) {
        throw new RuntimeException("Fatal error unable to create temp dir");
      }
      Settings settings=ImmutableSettings.settingsBuilder().put("node.http.enabled",true).put("transport.tcp.port",port).put("path.logs","target/elasticsearch/logs_" + tempDir.toString()).put("path.data","target/elasticsearch/data_" + tempDir.toString()).put("gateway.type","none").put("index.store.type","memory").put("index.number_of_shards",1).put("index.number_of_replicas",1).build();
      log.info("Starting ElasticSearch embedded with settings: " + settings.getAsMap());
      Node node=NodeBuilder.nodeBuilder().local(true).settings(settings).node();
      newClient=node.client();
    }
 else {
      final String hosts=fig.getHosts();
      Settings settings=ImmutableSettings.settingsBuilder().put("client.transport.ping_timeout",2000).put("client.transport.nodes_sampler_interval",100).put("http.enabled",false).put("discovery.zen.ping.unicast.hosts",hosts).build();
      Node node=NodeBuilder.nodeBuilder().settings(settings).clusterName(fig.getClusterName()).client(true).node();
      newClient=node.client();
    }
    client=newClient;
  }
  return client;
}
