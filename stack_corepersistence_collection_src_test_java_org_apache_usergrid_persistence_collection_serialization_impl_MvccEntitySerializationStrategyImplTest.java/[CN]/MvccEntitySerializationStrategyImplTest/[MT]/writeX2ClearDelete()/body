{
  final Id applicationId=new SimpleId("application");
  final String name="test";
  EntityCollection context=new EntityCollectionImpl(applicationId,name);
  final UUID entityId=UUIDGenerator.newTimeUUID();
  final UUID version1=UUIDGenerator.newTimeUUID();
  final String type="test";
  final Id id=new SimpleId(entityId,type);
  Entity entityv1=new Entity(id);
  EntityUtils.setVersion(entityv1,version1);
  MvccEntity saved=new MvccEntityImpl(id,version1,Optional.of(entityv1));
  serializationStrategy.write(context,saved).execute();
  MvccEntity returnedV1=serializationStrategy.load(context,id,version1);
  assertEquals("Mvcc entities are the same",saved,returnedV1);
  Entity entityv2=new Entity(id);
  UUID version2=UUIDGenerator.newTimeUUID();
  EntityUtils.setVersion(entityv1,version2);
  MvccEntity savedV2=new MvccEntityImpl(id,version2,Optional.of(entityv2));
  serializationStrategy.write(context,savedV2).execute();
  MvccEntity returnedV2=serializationStrategy.load(context,id,version2);
  assertEquals("Mvcc entities are the same",savedV2,returnedV2);
  UUID version3=UUIDGenerator.newTimeUUID();
  serializationStrategy.clear(context,id,version3).execute();
  final Optional<Entity> empty=Optional.absent();
  MvccEntity clearedV3=new MvccEntityImpl(id,version3,empty);
  MvccEntity returnedV3=serializationStrategy.load(context,id,version3);
  assertEquals("entities are the same",clearedV3,returnedV3);
  UUID current=UUIDGenerator.newTimeUUID();
  List<MvccEntity> entities=serializationStrategy.load(context,id,current,3);
  assertEquals(3,entities.size());
  assertEquals(clearedV3,entities.get(0));
  assertEquals(id,entities.get(0).getId());
  assertEquals(returnedV2,entities.get(1));
  assertEquals(id,entities.get(1).getId());
  assertEquals(returnedV1,entities.get(2));
  assertEquals(id,entities.get(2).getId());
  serializationStrategy.delete(context,id,version1).execute();
  serializationStrategy.delete(context,id,version2).execute();
  entities=serializationStrategy.load(context,id,current,3);
  assertEquals(1,entities.size());
  assertEquals(clearedV3,entities.get(0));
  serializationStrategy.delete(context,id,version3).execute();
  entities=serializationStrategy.load(context,id,current,3);
  assertEquals(0,entities.size());
}
