{
  int failCount=0;
  int successCount=0;
  final Import importEntity=getImportEntity(rootEm,fileImport);
  try {
    logger.debug("Got importEntity {}",importEntity.getUuid());
    EntityManager emMgmtApp=emf.getEntityManager(CpNamingUtils.MANAGEMENT_APPLICATION_ID);
    Query query=new Query();
    query.setEntityType(Schema.getDefaultSchema().getEntityType(FileImport.class));
    query.setConnectionType(IMPORT_FILE_INCLUDES_CONNECTION);
    query.setLimit(MAX_FILE_IMPORTS);
    Results entities=emMgmtApp.searchConnectedEntities(importEntity,query);
    PagingResultsIterator itr=new PagingResultsIterator(entities);
    if (!itr.hasNext()) {
      logger.warn("Just processed a file, but we were unable to get it back in a connection, this is a bug");
      return;
    }
    logger.debug("Check {} jobs to see if we are done for file {}",new Object[]{entities.size(),fileImport.getFileName()});
    while (itr.hasNext()) {
      FileImport fi=(FileImport)itr.next();
switch (fi.getState()) {
case FAILED:
        failCount++;
      break;
case FINISHED:
    successCount++;
  continue;
default :
logger.debug("not done yet, bail out...");
return;
}
}
}
 catch (Exception e) {
failCount++;
if (importEntity != null) {
importEntity.setErrorMessage("Error determining status of file import jobs");
}
logger.debug("Error determining status of file import jobs",e);
}
logger.debug("successCount = {} failCount = {}",new Object[]{successCount,failCount});
if (importEntity != null) {
logger.debug("FINISHED");
if (failCount == 0) {
importEntity.setState(Import.State.FINISHED);
}
 else {
importEntity.setState(Import.State.FAILED);
}
try {
rootEm.update(importEntity);
}
 catch (Exception e) {
logger.error("Error updating import entity",e);
}
}
}
