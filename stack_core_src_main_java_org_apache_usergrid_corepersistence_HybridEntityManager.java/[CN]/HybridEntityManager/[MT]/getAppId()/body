{
  Id appId;
  EntityCollectionManager ecm=getManager(SYSTEM_APP_SCOPE);
  EntityCollectionIndex eci=getIndex(SYSTEM_APP_SCOPE);
  UUID appUuid=getApplication().getUuid();
  org.apache.usergrid.persistence.index.query.Query q=org.apache.usergrid.persistence.index.query.Query.fromQL("uuid = '" + appUuid.toString() + "'");
  org.apache.usergrid.persistence.index.query.Results results=eci.execute(q);
  if (results.isEmpty()) {
    org.apache.usergrid.persistence.model.entity.Entity entity=new org.apache.usergrid.persistence.model.entity.Entity(new SimpleId(UUIDGenerator.newTimeUUID(),"application"));
    entity.setField(new UUIDField("uuid",appUuid));
    entity=ecm.write(entity).toBlockingObservable().last();
    log.debug("Added record for app uuid {}",appUuid.toString());
    appId=entity.getId();
  }
 else {
    org.apache.usergrid.persistence.model.entity.Entity entity=results.getEntities().get(0);
    appId=entity.getId();
  }
  return appId;
}
