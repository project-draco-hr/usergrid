{
  if (System.getProperty(EVENTS_DISABLED,"false").equals("true")) {
    return;
  }
  if (logger.isDebugEnabled()) {
    logger.debug("Handling versionDeleted count={} event for entity {}:{} v {} " + "scope\n   name: {}\n   owner: {}\n   app: {}",new Object[]{entityVersions.size(),entityId.getType(),entityId.getUuid(),scope.getName(),scope.getOwner(),scope.getApplication()});
  }
  CpEntityManagerFactory cpemf=(CpEntityManagerFactory)emf;
  final ApplicationEntityIndex ei=cpemf.getManagerCache().getEntityIndex(scope);
  final IndexScope indexScope=new IndexScopeImpl(new SimpleId(scope.getOwner().getUuid(),scope.getOwner().getType()),scope.getName());
  Observable.from(entityVersions).collect(ei.createBatch(),new Action2<EntityIndexBatch,MvccLogEntry>(){
    @Override public void call(    final EntityIndexBatch entityIndexBatch,    final MvccLogEntry mvccLogEntry){
      entityIndexBatch.deindex(indexScope,mvccLogEntry.getEntityId(),mvccLogEntry.getVersion());
    }
  }
).doOnNext(new Action1<EntityIndexBatch>(){
    @Override public void call(    final EntityIndexBatch entityIndexBatch){
      entityIndexBatch.execute();
    }
  }
).toBlocking().last();
}
