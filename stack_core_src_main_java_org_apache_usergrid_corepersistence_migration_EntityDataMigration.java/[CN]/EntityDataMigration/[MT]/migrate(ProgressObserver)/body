{
  final AtomicLong atomicLong=new AtomicLong();
  AllEntitiesInSystemObservable.getAllEntitiesInSystem(managerCache,1000).doOnNext(new Action1<AllEntitiesInSystemObservable.ApplicationEntityGroup>(){
    @Override public void call(    final AllEntitiesInSystemObservable.ApplicationEntityGroup applicationEntityGroup){
      final UUID now=UUIDGenerator.newTimeUUID();
      final Id appScopeId=applicationEntityGroup.applicationScope.getApplication();
      final MutationBatch totalBatch=keyspace.prepareMutationBatch();
      for (      Id entityId : applicationEntityGroup.entityIds) {
        CollectionScope currentScope=CpNamingUtils.getCollectionScopeNameFromEntityType(appScopeId,entityId.getType());
        Iterator<MvccEntity> allVersions=v1Serialization.loadDescendingHistory(currentScope,entityId,now,1000);
        while (allVersions.hasNext()) {
          final MvccEntity version=allVersions.next();
          final MutationBatch versionBatch=v2Serialization.write(currentScope,version);
          totalBatch.mergeShallow(versionBatch);
          if (atomicLong.incrementAndGet() % 50 == 0) {
            executeBatch(totalBatch,observer,atomicLong);
          }
        }
      }
      executeBatch(totalBatch,observer,atomicLong);
    }
  }
).toBlocking().last();
}
