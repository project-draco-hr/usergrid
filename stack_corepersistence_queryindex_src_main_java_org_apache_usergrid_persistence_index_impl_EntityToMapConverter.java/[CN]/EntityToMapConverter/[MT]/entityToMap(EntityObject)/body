{
  Map<String,Object> entityMap=new HashMap<String,Object>();
  for (  Object f : entity.getFields().toArray()) {
    Field field=(Field)f;
    if (f instanceof ArrayField) {
      List list=(List)field.getValue();
      entityMap.put(field.getName().toLowerCase(),new ArrayList(processCollectionForMap(list)));
    }
 else     if (f instanceof ListField) {
      List list=(List)field.getValue();
      entityMap.put(field.getName().toLowerCase(),new ArrayList(processCollectionForMap(list)));
      if (!list.isEmpty()) {
        if (list.get(0) instanceof String) {
          entityMap.put(ANALYZED_STRING_PREFIX + field.getName().toLowerCase(),new ArrayList(processCollectionForMap(list)));
        }
      }
    }
 else     if (f instanceof SetField) {
      Set set=(Set)field.getValue();
      entityMap.put(field.getName().toLowerCase(),new ArrayList(processCollectionForMap(set)));
    }
 else     if (f instanceof EntityObjectField) {
      EntityObject eo=(EntityObject)field.getValue();
      entityMap.put(field.getName().toLowerCase(),entityToMap(eo));
    }
 else     if (f instanceof StringField) {
      entityMap.put(ANALYZED_STRING_PREFIX + field.getName().toLowerCase(),((String)field.getValue()).toLowerCase());
      entityMap.put(STRING_PREFIX + field.getName().toLowerCase(),((String)field.getValue()).toLowerCase());
    }
 else     if (f instanceof LocationField) {
      LocationField locField=(LocationField)f;
      Map<String,Object> locMap=new HashMap<String,Object>();
      locMap.put("lat",locField.getValue().getLatitude());
      locMap.put("lon",locField.getValue().getLongitude());
      entityMap.put(GEO_PREFIX + field.getName().toLowerCase(),locMap);
    }
 else     if (f instanceof DoubleField || f instanceof FloatField) {
      entityMap.put(DOUBLE_PREFIX + field.getName().toLowerCase(),field.getValue());
    }
 else     if (f instanceof LongField || f instanceof IntegerField) {
      entityMap.put(LONG_PREFIX + field.getName().toLowerCase(),field.getValue());
    }
 else     if (f instanceof BooleanField) {
      entityMap.put(BOOLEAN_PREFIX + field.getName().toLowerCase(),field.getValue());
    }
 else     if (f instanceof UUIDField) {
      entityMap.put(STRING_PREFIX + field.getName().toLowerCase(),field.getValue().toString().toLowerCase());
    }
 else {
      entityMap.put(field.getName().toLowerCase(),field.getValue());
    }
  }
  return entityMap;
}
