{
  final EntityManager em=mock(EntityManager.class);
  final UUID importFileId=UUIDGenerator.newTimeUUID();
  final FileImport fileImport=new FileImport();
  fileImport.setUuid(importFileId);
  when(em.get(importFileId,FileImport.class)).thenReturn(fileImport);
  final FileImportStatistics fileImportStatistics=new FileImportStatistics(importFileId,em);
  final long expectedSuccess=100;
  for (long i=0; i < expectedSuccess; i++) {
    fileImportStatistics.entityWritten();
  }
  final long expectedFails=10;
  for (long i=0; i < expectedFails; i++) {
    fileImportStatistics.entityFailed("Failed to write entity " + i);
  }
  fileImportStatistics.complete();
  ArgumentCaptor<FileImport> savedFileImport=ArgumentCaptor.forClass(FileImport.class);
  verify(em).update(savedFileImport.capture());
  final FileImport updated=savedFileImport.getValue();
  assertSame("Same instance should be updated",fileImport,updated);
  assertEquals("Same count expected",expectedSuccess,updated.getImportedEntityCount());
  assertEquals("Same fail expected",expectedFails,updated.getFailedEntityCount());
  assertEquals("Correct error message","Failed to import " + expectedFails + " entities.  Successfully imported "+ expectedSuccess+ " entities",updated.getErrorMessage());
}
