{
  String orgName=clientSetup.getOrganization().getName();
  String appToDeleteName=clientSetup.getAppName() + "_appToDelete";
  Token orgAdminToken=getAdminToken(clientSetup.getUsername(),clientSetup.getUsername());
  List<Entity> entities=new ArrayList<>();
  UUID appToDeleteId=createAppWithCollection(orgName,appToDeleteName,orgAdminToken,entities);
  try {
    clientSetup.getRestClient().management().orgs().org(orgName).apps().app(appToDeleteId.toString()).getTarget().queryParam("access_token",orgAdminToken.getAccessToken()).request().delete();
    fail("Delete must fail without app_delete_confirm parameter");
  }
 catch (  ResponseProcessingException expected) {
    Assert.assertEquals("Error must be 400",400,expected.getResponse().getStatus());
    JsonNode node=mapper.readTree(expected.getResponse().readEntity(String.class));
    Assert.assertEquals("Cannot delete application without app_delete_confirm parameter",node.get("error_description").textValue());
  }
  clientSetup.getRestClient().management().orgs().org(orgName).apps().app(appToDeleteId.toString()).getTarget().queryParam("access_token",orgAdminToken.getAccessToken()).queryParam("app_delete_confirm","confirm_delete_of_application_and_data").request().delete();
  try {
    clientSetup.getRestClient().management().orgs().org(orgName).apps().app(appToDeleteName).getTarget().queryParam("access_token",orgAdminToken.getAccessToken()).request().get(ApiResponse.class);
    fail("Must not be able to get deleted app");
  }
 catch (  ResponseProcessingException expected) {
    Assert.assertEquals("Error must be 404",404,expected.getResponse().getStatus());
    JsonNode node=mapper.readTree(expected.getResponse().readEntity(String.class));
    Assert.assertEquals("entity_not_found",node.get("error").textValue());
  }
  try {
    clientSetup.getRestClient().org(orgName).app(appToDeleteName).getTarget().queryParam("access_token",orgAdminToken.getAccessToken()).request().get(ApiResponse.class);
    fail("Must not be able to get deleted app");
  }
 catch (  ResponseProcessingException expected) {
    Assert.assertEquals("Error must be 404",404,expected.getResponse().getStatus());
    JsonNode node=mapper.readTree(expected.getResponse().readEntity(String.class));
    Assert.assertEquals("organization_application_not_found",node.get("error").textValue());
  }
  try {
    clientSetup.getRestClient().org(orgName).app(appToDeleteName).collection("things").getTarget().queryParam("access_token",orgAdminToken.getAccessToken()).request().get(ApiResponse.class);
    fail("Must not be able to get deleted app's collection");
  }
 catch (  ResponseProcessingException expected) {
    Assert.assertEquals("Error must be 400",404,expected.getResponse().getStatus());
    JsonNode node=mapper.readTree(expected.getResponse().readEntity(String.class));
    Assert.assertEquals("organization_application_not_found",node.get("error").textValue());
  }
  try {
    UUID entityId=entities.get(0).getUuid();
    clientSetup.getRestClient().org(orgName).app(appToDeleteName).collection("things").entity(entityId).getTarget().queryParam("access_token",orgAdminToken.getAccessToken()).request().get(ApiResponse.class);
    fail("Must not be able to get deleted app entity");
  }
 catch (  ResponseProcessingException expected) {
    Assert.assertEquals("Error must be 400",404,expected.getResponse().getStatus());
    JsonNode node=mapper.readTree(expected.getResponse().readEntity(String.class));
    Assert.assertEquals("organization_application_not_found",node.get("error").textValue());
  }
  refreshIndex();
  ManagementResponse orgAppResponse=clientSetup.getRestClient().management().orgs().org(orgName).apps().getOrganizationApplications();
  for (  String appName : orgAppResponse.getData().keySet()) {
    if (orgAppResponse.getData().get(appName).equals(appToDeleteId.toString())) {
      fail("Deleted app must not be included in list of org apps");
    }
  }
  try {
    clientSetup.getRestClient().management().orgs().org(orgName).apps().app(appToDeleteId.toString()).getTarget().queryParam("access_token",orgAdminToken.getAccessToken()).queryParam("app_delete_confirm","confirm_delete_of_application_and_data").request().delete();
    fail("Can't delete a non existent app twice");
  }
 catch (  ResponseProcessingException expected) {
    Assert.assertEquals("Error must be 404",404,expected.getResponse().getStatus());
    JsonNode node=mapper.readTree(expected.getResponse().readEntity(String.class));
    Assert.assertEquals("entity_not_found",node.get("error").textValue());
  }
  ApiResponse appCreateAgainResponse=clientSetup.getRestClient().management().orgs().org(orgName).app().getTarget().queryParam("access_token",orgAdminToken.getAccessToken()).request().post(javax.ws.rs.client.Entity.json(new Application(appToDeleteName)),ApiResponse.class);
  Assert.assertEquals("Must be able to create app with same name as deleted app",(orgName + "/" + appToDeleteName).toLowerCase(),appCreateAgainResponse.getEntities().get(0).get("name"));
}
