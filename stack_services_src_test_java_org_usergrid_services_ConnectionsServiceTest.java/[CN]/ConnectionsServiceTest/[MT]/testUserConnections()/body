{
  UUID applicationId=createApplication("testOrganization","testConnections");
  ServiceManager sm=smf.getServiceManager(applicationId);
  Map<String,Object> properties=new LinkedHashMap<String,Object>();
  properties.put("username","conn-user1");
  properties.put("email","conn-user1@apigee.com");
  Entity user1=testRequest(sm,ServiceAction.POST,1,properties,"users").getEntity();
  assertNotNull(user1);
  testRequest(sm,ServiceAction.GET,1,null,"users","conn-user1");
  properties=new LinkedHashMap<String,Object>();
  properties.put("username","conn-user2");
  properties.put("email","conn-user2@apigee.com");
  Entity user2=testRequest(sm,ServiceAction.POST,1,properties,"users").getEntity();
  assertNotNull(user2);
  testRequest(sm,ServiceAction.POST,1,null,"users","conn-user1","manages","users","conn-user2");
  testRequest(sm,ServiceAction.POST,1,null,"users","conn-user1","reports","users","conn-user2");
  testRequest(sm,ServiceAction.GET,1,null,"users","conn-user1");
  testRequest(sm,ServiceAction.GET,1,null,"users","conn-user2");
  testRequest(sm,ServiceAction.DELETE,1,null,"users","conn-user1","manages","users","conn-user2");
  user1=testRequest(sm,ServiceAction.GET,1,null,"users","conn-user1").getEntities().get(0);
  assertFalse(((Map)user1.getMetadata("connections")).containsKey("manages"));
  user2=testRequest(sm,ServiceAction.GET,1,null,"users","conn-user2").getEntities().get(0);
  assertFalse(((Map)user2.getMetadata("connecting")).containsKey("manages"));
  testRequest(sm,ServiceAction.DELETE,0,null,"users","conn-user1","reports","conn-user2");
  user1=testRequest(sm,ServiceAction.GET,1,null,"users","conn-user1").getEntities().get(0);
  assertTrue(((Map)user1.getMetadata("connections")).containsKey("reports"));
  user2=testRequest(sm,ServiceAction.GET,1,null,"users","conn-user2").getEntities().get(0);
  assertTrue(((Map)user2.getMetadata("connecting")).containsKey("reports"));
  properties=new LinkedHashMap<String,Object>();
  properties.put("username","conn-user3");
  properties.put("email","conn-user3@apigee.com");
  testRequest(sm,ServiceAction.POST,1,properties,"users","conn-user1","manages","user");
}
