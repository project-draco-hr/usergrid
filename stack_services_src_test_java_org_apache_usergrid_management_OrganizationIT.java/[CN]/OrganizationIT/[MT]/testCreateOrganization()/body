{
  final String orgName=uniqueOrg();
  OrganizationOwnerInfo organization=newOrgAppAdminRule.createOwnerAndOrganization(orgName,uniqueUsername(),uniqueEmail(),"Ed Anuff","test");
  assertNotNull(organization);
  setup.getEntityIndex().refresh(CpNamingUtils.MANAGEMENT_APPLICATION_ID);
  Map<UUID,String> userOrganizations=setup.getMgmtSvc().getOrganizationsForAdminUser(organization.getOwner().getUuid());
  assertEquals("wrong number of organizations",1,userOrganizations.size());
  List<UserInfo> users=setup.getMgmtSvc().getAdminUsersForOrganization(organization.getOrganization().getUuid());
  assertEquals("wrong number of users",1,users.size());
  ApplicationInfo applicationInfo=setup.getMgmtSvc().createApplication(organization.getOrganization().getUuid(),"ed-application");
  assertNotNull(applicationInfo.getId());
  setup.getEntityIndex().refresh(applicationInfo.getId());
  Map<UUID,String> applications=setup.getMgmtSvc().getApplicationsForOrganization(organization.getOrganization().getUuid());
  assertEquals("wrong number of applications",1,applications.size());
  OrganizationInfo organization2=setup.getMgmtSvc().getOrganizationForApplication(applicationInfo.getId());
  assertNotNull(organization2);
  assertEquals("wrong organization name",organization.getOrganization().getName(),organization2.getName());
  boolean verified=setup.getMgmtSvc().verifyAdminUserPassword(organization.getOwner().getUuid(),"test");
  assertTrue(verified);
  setup.getMgmtSvc().activateOrganization(organization2);
  setup.getEntityIndex().refresh(CpNamingUtils.MANAGEMENT_APPLICATION_ID);
  UserInfo u=setup.getMgmtSvc().verifyAdminUserPasswordCredentials(organization.getOwner().getUuid().toString(),"test");
  assertNotNull(u);
  String token=setup.getMgmtSvc().getAccessTokenForAdminUser(organization.getOwner().getUuid(),0);
  assertNotNull(token);
  AuthPrincipalInfo principal=((ManagementServiceImpl)setup.getMgmtSvc()).getPrincipalFromAccessToken(token,null,null);
  assertNotNull(principal);
  assertEquals(organization.getOwner().getUuid(),principal.getUuid());
  UserInfo new_user=setup.getMgmtSvc().createAdminUser(organization2.getUuid(),uniqueUsername(),"Test User",uniqueEmail(),"testpassword",true,true);
  assertNotNull(new_user);
  setup.getMgmtSvc().addAdminUserToOrganization(new_user,organization2,false);
}
