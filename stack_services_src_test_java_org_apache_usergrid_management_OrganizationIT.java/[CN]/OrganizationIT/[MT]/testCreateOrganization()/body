{
  UserInfo user=setup.getMgmtSvc().createAdminUser(uniqueUsername(),"Ed Anuff",uniqueEmail(),"test",false,false);
  assertNotNull(user);
  final String orgName=uniqueOrg();
  OrganizationInfo organization=setup.getMgmtSvc().createOrganization(orgName,user,false);
  assertNotNull(organization);
  setup.getEmf().getEntityManager(setup.getSmf().getManagementAppId()).refreshIndex();
  Map<UUID,String> userOrganizations=setup.getMgmtSvc().getOrganizationsForAdminUser(user.getUuid());
  assertEquals("wrong number of organizations",1,userOrganizations.size());
  List<UserInfo> users=setup.getMgmtSvc().getAdminUsersForOrganization(organization.getUuid());
  assertEquals("wrong number of users",1,users.size());
  UUID applicationId=setup.getMgmtSvc().createApplication(organization.getUuid(),"ed-application").getId();
  assertNotNull(applicationId);
  setup.getEmf().getEntityManager(setup.getSmf().getManagementAppId()).refreshIndex();
  setup.getEmf().getEntityManager(applicationId).refreshIndex();
  Map<UUID,String> applications=setup.getMgmtSvc().getApplicationsForOrganization(organization.getUuid());
  assertEquals("wrong number of applications",1,applications.size());
  OrganizationInfo organization2=setup.getMgmtSvc().getOrganizationForApplication(applicationId);
  assertNotNull(organization2);
  assertEquals("wrong organization name",orgName,organization2.getName());
  boolean verified=setup.getMgmtSvc().verifyAdminUserPassword(user.getUuid(),"test");
  assertTrue(verified);
  setup.getMgmtSvc().activateOrganization(organization2);
  setup.getEmf().getEntityManager(setup.getSmf().getManagementAppId()).refreshIndex();
  UserInfo u=setup.getMgmtSvc().verifyAdminUserPasswordCredentials(user.getUuid().toString(),"test");
  assertNotNull(u);
  String token=setup.getMgmtSvc().getAccessTokenForAdminUser(user.getUuid(),0);
  assertNotNull(token);
  AuthPrincipalInfo principal=((ManagementServiceImpl)setup.getMgmtSvc()).getPrincipalFromAccessToken(token,null,null);
  assertNotNull(principal);
  assertEquals(user.getUuid(),principal.getUuid());
  UserInfo new_user=setup.getMgmtSvc().createAdminUser(uniqueUsername(),"Test User",uniqueEmail(),"testpassword",true,true);
  assertNotNull(new_user);
  setup.getMgmtSvc().addAdminUserToOrganization(new_user,organization2,false);
}
