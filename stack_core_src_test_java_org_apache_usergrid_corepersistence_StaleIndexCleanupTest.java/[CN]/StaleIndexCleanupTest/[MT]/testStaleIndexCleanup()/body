{
  logger.info("Started testStaleIndexCleanup()");
  final EntityManager em=app.getEntityManager();
  final int numEntities=10;
  final int numUpdates=3;
  final List<Entity> things=new ArrayList<Entity>(numEntities);
  for (int i=0; i < numEntities; i++) {
    final String thingName="thing" + i;
    things.add(em.create("thing",new HashMap<String,Object>(){
{
        put("name",thingName);
      }
    }
));
    Thread.sleep(writeDelayMs);
  }
  em.refreshIndex();
  CandidateResults crs=queryCollectionCp("things","thing","select *");
  Assert.assertEquals("Expect no stale candidates yet",numEntities,crs.size());
  int count=0;
  List<Entity> maxVersions=new ArrayList<>(numEntities);
  for (  Entity thing : things) {
    Entity toUpdate=null;
    for (int j=0; j < numUpdates; j++) {
      toUpdate=em.get(thing.getUuid());
      toUpdate.setProperty("property" + j,RandomStringUtils.randomAlphanumeric(10));
      em.update(toUpdate);
      Thread.sleep(writeDelayMs);
      count++;
      if (count % 100 == 0) {
        logger.info("Updated {} of {} times",count,numEntities * numUpdates);
      }
    }
    maxVersions.add(toUpdate);
  }
  em.refreshIndex();
  crs=queryCollectionCp("things","thing","select *");
  Assert.assertEquals("Expect stale candidates",numEntities * (numUpdates + 1),crs.size());
  final int limit=8;
  Query q=Query.fromQL("select *");
  q.setLimit(limit);
  int thingCount=0;
  String cursor=null;
  int index=0;
  do {
    Results results=em.searchCollection(em.getApplicationRef(),"things",q);
    thingCount+=results.size();
    logger.debug("Retrieved total of {} entities",thingCount);
    cursor=results.getCursor();
    if (cursor != null && thingCount < numEntities) {
      assertEquals(limit,results.size());
    }
    for (int i=0; i < results.size(); i++, index++) {
      final Entity returned=results.getEntities().get(i);
      final Entity expected=maxVersions.get(index);
      assertEquals("correct entity returned",expected,returned);
    }
  }
 while (cursor != null);
  assertEquals("Expect no stale candidates",numEntities,thingCount);
  em.refreshIndex();
  Thread.sleep(600);
  crs=queryCollectionCp("things","thing","select *");
  Assert.assertEquals("Expect stale candidates de-indexed",numEntities,crs.size());
}
