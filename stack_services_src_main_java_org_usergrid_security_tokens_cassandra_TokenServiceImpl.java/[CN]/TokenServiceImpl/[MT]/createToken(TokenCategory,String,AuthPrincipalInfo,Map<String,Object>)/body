{
  if (principal != null) {
    Assert.notNull(principal.getType());
    Assert.notNull(principal.getApplicationId());
    Assert.notNull(principal.getUuid());
  }
  UUID uuid=UUIDUtils.newTimeUUID();
  long timestamp=getTimestampInMillis(uuid);
  if (type == null) {
    type=TOKEN_TYPE_ACCESS;
  }
  TokenInfo tokenInfo=new TokenInfo(uuid,type,timestamp,timestamp,0,principal,state);
  putTokenInfo(tokenInfo);
  return getTokenForUUID(tokenCategory,uuid);
}
