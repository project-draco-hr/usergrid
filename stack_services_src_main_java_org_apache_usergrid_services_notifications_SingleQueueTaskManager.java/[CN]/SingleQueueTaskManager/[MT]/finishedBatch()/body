{
  long successes=this.successes.getAndSet(0);
  long failures=this.failures.getAndSet(0);
  this.hasFinished=true;
  Notification notification=em.get(this.notification.getUuid(),Notification.class);
  notification.setModified(System.currentTimeMillis());
  long sent=successes, errors=failures;
  Map<String,Long> stats;
  stats=new HashMap<String,Long>(2);
  stats.put("sent",sent);
  stats.put("errors",errors);
  notification.setStatistics(stats);
  LOG.info("notification {} sending to {}",notification.getUuid(),sent + errors);
  if (notification.getExpectedCount() <= (errors + sent)) {
    Map<String,Object> properties=new HashMap<>();
    notification.setFinished(notification.getModified());
    properties.put("finished",notification.getModified());
    properties.put("state",notification.getState());
    LOG.info("done sending to devices in {} ms",notification.getFinished() - notification.getStarted());
    notification.addProperties(properties);
  }
  LOG.info("notification finished batch: {}",notification.getUuid());
  em.update(notification);
}
