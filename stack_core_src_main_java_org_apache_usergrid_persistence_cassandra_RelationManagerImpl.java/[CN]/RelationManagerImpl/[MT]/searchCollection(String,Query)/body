{
  if (query == null) {
    query=new Query();
  }
  headEntity=em.validate(headEntity);
  CollectionInfo collection=getDefaultSchema().getCollection(headEntity.getType(),collectionName);
  query.setEntityType(collection.getType());
  final CollectionResultsLoaderFactory factory=new CollectionResultsLoaderFactory();
  QueryProcessor qp=new QueryProcessor(em,executorService,query,collection,factory);
  CollectionSearchVisitorFactory collectionSearchVisitorFactory=new CollectionSearchVisitorFactory(cass,indexBucketLocator,qp,applicationId,headEntity,collectionName);
  return qp.getResults(collectionSearchVisitorFactory);
}
