{
  if (query == null) {
    query=new Query();
  }
  headEntity=em.validate(headEntity);
  CollectionInfo collection=getDefaultSchema().getCollection(headEntity.getType(),collectionName);
  query.setEntityType(collection.getType());
  final CollectionResultsLoaderFactory factory=new CollectionResultsLoaderFactory();
  QueryProcessorImpl qp=new QueryProcessorImpl(query,collection,em,factory);
  SearchCollectionVisitor visitor=new SearchCollectionVisitor(qp);
  return qp.getResults(visitor);
}
