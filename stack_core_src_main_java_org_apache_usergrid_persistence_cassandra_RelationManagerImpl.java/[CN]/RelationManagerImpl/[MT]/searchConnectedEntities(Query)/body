{
  Preconditions.checkNotNull(query,"Query must not be null");
  final String connectedEntityType=query.getEntityType();
  final String connectionType=query.getConnectionType();
  Preconditions.checkNotNull(connectedEntityType,"entityType must not be null");
  Preconditions.checkNotNull(connectionType,"connectionType must not be null");
  headEntity=em.validate(headEntity);
  ConnectionRefImpl connectionRef=new ConnectionRefImpl(headEntity,connectionType,new SimpleEntityRef(connectedEntityType,null));
  final ConnectionResultsLoaderFactory factory=new ConnectionResultsLoaderFactory(connectionRef);
  QueryProcessorImpl qp=new QueryProcessorImpl(query,null,em,factory);
  SearchConnectionVisitor visitor=new SearchConnectionVisitor(qp,connectionRef,true);
  return qp.getResults(visitor);
}
