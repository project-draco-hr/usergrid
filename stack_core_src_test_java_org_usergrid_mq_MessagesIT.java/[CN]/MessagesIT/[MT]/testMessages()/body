{
  LOG.info("MessagesIT.testMessages");
  UUID applicationId=setup.createApplication("testOrganization","testMessages");
  assertNotNull(applicationId);
  EntityManager em=getEntityManagerFactory().getEntityManager(applicationId);
  assertNotNull(em);
  LOG.info("Creating message #1");
  Message message=new Message();
  message.setStringProperty("foo","bar");
  LOG.info(JsonUtils.mapToFormattedJsonString(message));
  LOG.info("Posting message #1 to queue /foo/bar");
  QueueManager qm=getQueueManagerFactory().getQueueManager(applicationId);
  qm.postToQueue("/foo/bar",message);
  LOG.info("Getting message #1");
  message=qm.getMessage(message.getUuid());
  LOG.info(JsonUtils.mapToFormattedJsonString(message));
  LOG.info("Getting message from /foo/bar, should be message #1");
  QueueResults messages=qm.getFromQueue("/foo/bar",null);
  LOG.info(JsonUtils.mapToFormattedJsonString(messages));
  assertEquals(1,messages.size());
  LOG.info("Getting message from /foo/bar, should empty");
  messages=qm.getFromQueue("/foo/bar",null);
  LOG.info(JsonUtils.mapToFormattedJsonString(messages));
  assertEquals(0,messages.size());
  message=new Message();
  message.setStringProperty("name","alpha");
  qm.postToQueue("/foo/bar",message);
  message=new Message();
  message.setStringProperty("name","bravo");
  qm.postToQueue("/foo/bar",message);
  TimeUnit.SECONDS.sleep(2);
  Map<String,Long> counters=qm.getQueueCounters("/");
  LOG.info("dumping counters...." + counters);
  LOG.info(JsonUtils.mapToFormattedJsonString(counters));
  assertEquals(1,counters.size());
  assertNotNull(counters.get("/foo/bar/"));
  assertEquals(new Long(3),counters.get("/foo/bar/"));
}
