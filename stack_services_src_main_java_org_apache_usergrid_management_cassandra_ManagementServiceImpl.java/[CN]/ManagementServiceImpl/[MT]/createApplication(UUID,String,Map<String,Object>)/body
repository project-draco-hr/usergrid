{
  if ((organizationId == null) || (applicationName == null)) {
    return null;
  }
  if (properties == null) {
    properties=new HashMap<>();
  }
  OrganizationInfo organizationInfo=getOrganizationByUuid(organizationId);
  UUID applicationId=emf.createApplication(organizationInfo.getName(),applicationName,properties);
  EntityManager em=emf.getEntityManager(smf.getManagementAppId());
  em.refreshIndex();
  String appName=buildAppName(applicationName,organizationInfo);
  Query q=Query.fromQL(PROPERTY_NAME + " = '" + appName+ "'");
  Results results=em.searchCollection(em.getApplicationRef(),CpNamingUtils.APPLICATION_INFOS,q);
  Entity appInfo=results.iterator().next();
  writeUserToken(smf.getManagementAppId(),appInfo,encryptionService.plainTextCredentials(generateOAuthSecretKey(AuthPrincipalType.APPLICATION),null,smf.getManagementAppId()));
  addApplicationToOrganization(organizationId,applicationId,appInfo);
  UserInfo user=null;
  try {
    user=SubjectUtils.getUser();
  }
 catch (  UnavailableSecurityManagerException e) {
    logger.warn("Error getting user, organization created activity will not be created",e);
  }
  if ((user != null) && user.isAdminUser()) {
    postOrganizationActivity(organizationId,user,"create",appInfo,"Application",applicationName,"<a href=\"mailto:" + user.getEmail() + "\">"+ user.getName()+ " ("+ user.getEmail()+ ")</a> created a new application named "+ applicationName,null);
  }
  em.refreshIndex();
  return new ApplicationInfo(applicationId,appInfo.getName());
}
