{
  if ((organizationId == null) || (applicationName == null)) {
    return null;
  }
  if (properties == null) {
    properties=new HashMap<>();
  }
  EntityManager em=emf.getEntityManager(smf.getManagementAppId());
  OrganizationInfo organizationInfo=getOrganizationByUuid(organizationId);
  UUID applicationId=emf.createApplication(organizationInfo.getName(),applicationName,properties);
  em.refreshIndex();
  Entity appInfo=em.get(new SimpleEntityRef(CpNamingUtils.APPLICATION_INFO,applicationId));
  writeUserToken(smf.getManagementAppId(),appInfo,encryptionService.plainTextCredentials(generateOAuthSecretKey(AuthPrincipalType.APPLICATION),null,smf.getManagementAppId()));
  addApplicationToOrganization(organizationId,applicationId,appInfo);
  UserInfo user=null;
  try {
    user=SubjectUtils.getUser();
  }
 catch (  UnavailableSecurityManagerException e) {
    logger.warn("Error getting user, application created activity will not be created",e);
  }
  if ((user != null) && user.isAdminUser()) {
    postOrganizationActivity(organizationId,user,"create",appInfo,"Application",applicationName,"<a href=\"mailto:" + user.getEmail() + "\">"+ user.getName()+ " ("+ user.getEmail()+ ")</a> created a new application named "+ applicationName,null);
  }
  em.refreshIndex();
  return new ApplicationInfo(applicationId,appInfo.getName());
}
