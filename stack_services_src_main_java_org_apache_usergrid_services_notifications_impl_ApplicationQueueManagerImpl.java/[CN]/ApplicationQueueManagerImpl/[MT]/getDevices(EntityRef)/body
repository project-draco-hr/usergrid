{
  List<EntityRef> devices=Collections.EMPTY_LIST;
  if ("device".equals(ref.getType())) {
    devices=Collections.singletonList(ref);
  }
 else   if ("user".equals(ref.getType())) {
    devices=em.getCollection(ref,"devices",null,Query.MAX_LIMIT,Query.Level.REFS,false).getRefs();
  }
 else   if ("group".equals(ref.getType())) {
    devices=new ArrayList<EntityRef>();
    for (    EntityRef r : em.getCollection(ref,"users",null,Query.MAX_LIMIT,Query.Level.REFS,false).getRefs()) {
      devices.addAll(getDevices(r));
    }
  }
  return devices;
}
