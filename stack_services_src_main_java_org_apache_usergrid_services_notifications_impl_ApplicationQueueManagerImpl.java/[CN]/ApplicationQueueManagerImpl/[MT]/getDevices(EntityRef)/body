{
  List<EntityRef> devices=new ArrayList<>();
  final int LIMIT=Query.MID_LIMIT;
  try {
    if ("device".equals(ref.getType())) {
      devices=Collections.singletonList(ref);
    }
 else     if ("user".equals(ref.getType())) {
      UUID start=null;
      boolean initial=true;
      int resultSize=0;
      while (initial || resultSize >= Query.DEFAULT_LIMIT) {
        initial=false;
        final List<EntityRef> mydevices=em.getCollection(ref,"devices",start,LIMIT,Query.Level.REFS,true).getRefs();
        resultSize=mydevices.size();
        if (mydevices.size() > 0) {
          start=mydevices.get(mydevices.size() - 1).getUuid();
        }
        devices.addAll(mydevices);
      }
    }
 else     if ("group".equals(ref.getType())) {
      UUID start=null;
      boolean initial=true;
      int resultSize=0;
      while (initial || resultSize >= LIMIT) {
        initial=false;
        final List<EntityRef> myusers=em.getCollection(ref,"users",start,LIMIT,Query.Level.REFS,true).getRefs();
        resultSize=myusers.size();
        if (myusers.size() > 0) {
          start=myusers.get(myusers.size() - 1).getUuid();
        }
        for (        EntityRef user : myusers) {
          devices.addAll(em.getCollection(user,"devices",null,100,Query.Level.REFS,true).getRefs());
        }
      }
    }
  }
 catch (  Exception e) {
    if (ref != null) {
      logger.error("Error while retrieving devices for entity type {} and uuid {}. Error: {}",ref.getType(),ref.getUuid(),e);
    }
 else {
      logger.error("Error while retrieving devices. Entity ref was null.");
    }
    throw new RuntimeException("Unable to retrieve devices for EntityRef",e);
  }
  return devices;
}
