{
  if (operationMessages == null || operationMessages.size() == 0) {
    return;
  }
  Observable<BatchRequest> flattenMessages=Observable.from(operationMessages).subscribeOn(Schedulers.io()).flatMap(new Func1<IndexOperationMessage,Observable<BatchRequest>>(){
    @Override public Observable<BatchRequest> call(    IndexOperationMessage operationMessage){
      return Observable.from(operationMessage.getOperations());
    }
  }
);
  flattenMessages.buffer(config.getIndexBatchSize()).doOnNext(new Action1<List<BatchRequest>>(){
    @Override public void call(    List<BatchRequest> builders){
      try {
        final BulkRequestBuilder bulkRequest=initRequest();
        for (        BatchRequest builder : builders) {
          indexSizeCounter.dec();
          builder.doOperation(client,bulkRequest);
        }
        sendRequest(bulkRequest);
      }
 catch (      Exception e) {
        log.error("Failed while sending bulk",e);
      }
    }
  }
).toBlocking().lastOrDefault(null);
  Observable.from(operationMessages).subscribeOn(Schedulers.io()).doOnNext(new Action1<IndexOperationMessage>(){
    @Override public void call(    IndexOperationMessage operationMessage){
      operationMessage.getFuture().done();
    }
  }
).toBlocking().lastOrDefault(null);
}
