{
  try {
    BulkRequestBuilder bulkRequest=client.prepareBulk();
    bulkRequest.setRefresh(refresh);
    int count=bufferSize;
    while (blockingQueue.size() > 0 && count-- > 0) {
      RequestBuilderContainer container=(RequestBuilderContainer)blockingQueue.take();
      ShardReplicationOperationRequestBuilder builder=container.getBuilder();
      if (builder instanceof IndexRequestBuilder) {
        bulkRequest.add((IndexRequestBuilder)builder);
      }
      if (builder instanceof DeleteRequestBuilder) {
        bulkRequest.add((DeleteRequestBuilder)builder);
      }
    }
    if (bulkRequest.numberOfActions() == 0) {
      return;
    }
    final BulkResponse responses;
    try {
      responses=bulkRequest.execute().actionGet();
    }
 catch (    Throwable t) {
      log.error("Unable to communicate with elasticsearch");
      failureMonitor.fail("Unable to execute batch",t);
      throw t;
    }
    failureMonitor.success();
    for (    BulkItemResponse response : responses) {
      if (response.isFailed()) {
        throw new RuntimeException("Unable to index documents.  Errors are :" + response.getFailure().getMessage());
      }
    }
  }
 catch (  InterruptedException ie) {
    log.error("Problem taking messages off of queue",ie);
    throw new RuntimeException(ie);
  }
}
