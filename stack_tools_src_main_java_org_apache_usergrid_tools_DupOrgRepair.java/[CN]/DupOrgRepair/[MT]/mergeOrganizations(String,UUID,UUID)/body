{
  OrganizationInfo sourceOrgInfo=managementService.getOrganizationByUuid(sourceOrgId);
  Map<String,Object> sourceOrg=managementService.getOrganizationData(sourceOrgInfo);
  OrganizationInfo targetOrgInfo=managementService.getOrganizationByUuid(targetOrgId);
  Map<String,Object> targetOrg=managementService.getOrganizationData(targetOrgInfo);
  FileWriter file=new FileWriter(String.format("%s/%s.%s.orig",outputDir,sourceOrgInfo.getName(),sourceOrgId));
  file.write(JsonUtils.mapToFormattedJsonString(sourceOrg));
  file.write("\n\n");
  file.write(JsonUtils.mapToFormattedJsonString(targetOrg));
  file.flush();
  file.close();
  Map<String,UserInfo> admins=(Map<String,UserInfo>)sourceOrg.get("users");
  for (  Entry<String,UserInfo> adminEntry : admins.entrySet()) {
    UserInfo admin=adminEntry.getValue();
    logger.info("adding admin with uuid {} and email {} to org with name {} and uuid {}",new Object[]{admin.getUuid(),admin.getEmail(),targetOrgInfo.getName(),targetOrgInfo.getUuid()});
    managementService.addAdminUserToOrganization(admin,targetOrgInfo,false);
  }
  EntityManager em=emf.getEntityManager(emf.getManagementAppId());
  Map<String,UUID> sourceApps=(Map<String,UUID>)sourceOrg.get("applications");
  Map<String,UUID> targetApps=(Map<String,UUID>)targetOrg.get("applications");
  for (  Entry<String,UUID> app : sourceApps.entrySet()) {
    if (targetApps.get(app.getKey()) != null) {
      if (app.getValue().equals(targetApps.get(app.getKey()))) {
        continue;
      }
      UUID appIdToKeep=emf.lookupApplication(app.getKey());
      UUID appIdToChange=appIdToKeep.equals(app.getValue()) ? targetApps.get(app.getKey()) : app.getValue();
      Entity appEntity=em.get(new SimpleEntityRef("application",appIdToChange));
      if (appEntity != null) {
        String oldName=appEntity.getProperty("name").toString();
        String newName=oldName + appEntity.getUuid();
        em.setProperty(appEntity,"name",newName,true);
        logger.info("Renamed app from {} to {}",oldName,newName);
      }
    }
    logger.info("Adding application with name {} and id {} to organization with uuid {}",new Object[]{app.getKey(),app.getValue(),targetOrgId});
    managementService.addApplicationToOrganization(targetOrgId,app.getValue());
  }
  logger.info("Deleting org with the name {} and uuid {}",sourceOrgInfo.getName(),sourceOrgInfo.getUuid());
  em.delete(new SimpleEntityRef("group",sourceOrgId));
  targetOrgInfo=managementService.getOrganizationByUuid(targetOrgId);
  targetOrg=managementService.getOrganizationData(targetOrgInfo);
  file=new FileWriter(String.format("%s/%s.%s.new",outputDir,targetOrgInfo.getName(),targetOrgId));
  file.write(JsonUtils.mapToFormattedJsonString(targetOrg));
  file.flush();
  file.close();
}
