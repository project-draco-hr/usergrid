{
  Preconditions.checkNotNull(query,"query cannot be null");
  final String connection=query.getConnectionType();
  Preconditions.checkNotNull(connection,"connection must be specified");
  headEntity=em.validate(headEntity);
  query=adjustQuery(query);
  final Optional<String> entityType=Optional.fromNullable(query.getEntityType());
  final IdBuilder pipelineBuilder=pipelineBuilderFactory.create(applicationScope).withCursor(query.getCursor()).withLimit(query.getLimit()).fromId(cpHeadEntity.getId());
  if (query.getResultsLevel() == Level.REFS) {
    final Observable<ResultsPage<ConnectionRef>> results;
    if (query.isGraphSearch()) {
      results=pipelineBuilder.traverseConnection(connection,entityType).loadConnectionRefs(cpHeadEntity.getId(),connection).build();
    }
 else {
      results=pipelineBuilder.searchConnection(connection,query.getQl().get(),entityType).loadIds().loadConnectionRefs(cpHeadEntity.getId(),connection).build();
    }
    throw new UnsupportedOperationException("Implement me");
  }
  if (query.getResultsLevel() == Level.IDS) {
    throw new UnsupportedOperationException("Not yet implemented");
  }
  final Observable<ResultsPage<org.apache.usergrid.persistence.model.entity.Entity>> results;
  if (query.isGraphSearch()) {
    results=pipelineBuilder.traverseConnection(connection,entityType).loadEntities().build();
  }
 else {
    results=pipelineBuilder.searchConnection(connection,query.getQl().get(),entityType).loadEntities().build();
  }
  return new ObservableQueryExecutor(results).next();
}
