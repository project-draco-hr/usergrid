{
  Preconditions.checkNotNull(query,"query cannot be null");
  final String connection=query.getConnectionType();
  Preconditions.checkNotNull(connection,"connection must be specified");
  headEntity=em.validate(headEntity);
  query=adjustQuery(query);
  final String entityType=query.getEntityType();
  final FilterPipeline<Id> filterPipeline=new FilterPipeline(applicationScope,query.getCursor(),query.getLimit()).withFilter(filterFactory.getEntityIdFilter(cpHeadEntity.getId()));
  final FilterPipeline<org.apache.usergrid.persistence.model.entity.Entity> entityFilterPipeline;
  if (query.isGraphSearch()) {
    entityFilterPipeline=filterPipeline.withFilter(filterFactory.readGraphConnectionFilter(connection)).withFilter(filterFactory.entityLoadFilter());
  }
 else {
    entityFilterPipeline=filterPipeline.withFilter(filterFactory.elasticSearchConnectionFilter(query.getQl().get(),connection,Optional.fromNullable(entityType))).withFilter(filterFactory.candidateEntityFilter());
  }
  final Observable<ResultsPage> resultsObservable=entityFilterPipeline.withFilter(filterFactory.entityResumeFilter()).withCollector(collectorFactory.getResultsPageCollector()).execute();
  return new ObservableQueryExecutor(resultsObservable).next();
}
