{
  headEntity=em.validate(headEntity);
  connectedEntityRef=em.validate(connectedEntityRef);
  ConnectionRefImpl connection=new ConnectionRefImpl(headEntity,connectionType,connectedEntityRef);
  CollectionScope targetScope=new CollectionScopeImpl(applicationScope.getApplication(),applicationScope.getApplication(),CpEntityManager.getCollectionScopeNameFromEntityType(connectedEntityRef.getType()));
  EntityCollectionManager targetEcm=managerCache.getEntityCollectionManager(targetScope);
  if (logger.isDebugEnabled()) {
    logger.debug("createConnection(): " + "Indexing connection type '{}'\n   from source {}:{}]\n" + "   to target {}:{}\n   from scope\n   app {}\n   owner {}\n   name {}",new Object[]{connectionType,headEntity.getType(),headEntity.getUuid(),connectedEntityRef.getType(),connectedEntityRef.getUuid(),targetScope.getApplication(),targetScope.getOwner(),targetScope.getName()});
  }
  org.apache.usergrid.persistence.model.entity.Entity targetEntity=targetEcm.load(new SimpleId(connectedEntityRef.getUuid(),connectedEntityRef.getType())).toBlockingObservable().last();
  String edgeType=CpEntityManager.getEdgeTypeFromConnectionType(connectionType,connectedEntityRef.getType());
  Edge edge=new SimpleEdge(cpHeadEntity.getId(),edgeType,targetEntity.getId(),System.currentTimeMillis());
  GraphManager gm=managerCache.getGraphManager(applicationScope);
  gm.writeEdge(edge).toBlockingObservable().last();
  logger.debug("\n\nWrote edgeType {}\n   from {}:{}\n   to {}:{}\n   scope {}:{}\n\n",new Object[]{edgeType,cpHeadEntity.getId().getType(),cpHeadEntity.getId().getUuid(),targetEntity.getId().getType(),targetEntity.getId().getUuid(),applicationScope.getApplication().getType(),applicationScope.getApplication().getUuid()});
  ((CpEntityManager)em).indexEntityIntoConnection(cpHeadEntity,targetEntity,connectedEntityRef.getType(),connectionType);
  Keyspace ko=cass.getApplicationKeyspace(applicationId);
  Mutator<ByteBuffer> m=createMutator(ko,be);
  batchUpdateEntityConnection(m,false,connection,UUIDGenerator.newTimeUUID());
  batchExecute(m,CassandraService.RETRY_COUNT);
  return connection;
}
