{
  Results raw=null;
  Query query=new Query();
  query.setConnectionType(connectionType);
  query.setEntityType(connectedEntityType);
  if (connectionType == null) {
    raw=searchConnectedEntities(query);
  }
 else {
    headEntity=em.validate(headEntity);
    IndexScope indexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),CpEntityManager.getConnectionScopeName(connectedEntityType,connectionType));
    EntityIndex ei=managerCache.getEntityIndex(indexScope);
    logger.debug("Searching connected entities from scope {}:{}:{}",new String[]{indexScope.getApplication().toString(),indexScope.getOwner().toString(),indexScope.getName()});
    query=adjustQuery(query);
    CandidateResults crs=ei.search(query);
    raw=buildResults(query,crs,query.getConnectionType());
  }
  if (Level.REFS.equals(level)) {
    List<EntityRef> refList=new ArrayList<EntityRef>(raw.getEntities());
    return Results.fromRefList(refList);
  }
  if (Level.IDS.equals(level)) {
    List<UUID> idList=new ArrayList<UUID>();
    for (    EntityRef ref : raw.getEntities()) {
      idList.add(ref.getUuid());
    }
    return Results.fromIdList(idList);
  }
  List<Entity> entities=new ArrayList<Entity>();
  for (  EntityRef ref : raw.getEntities()) {
    Entity entity=em.get(ref);
    entities.add(entity);
  }
  return Results.fromEntities(entities);
}
