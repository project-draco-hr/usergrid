{
  Results raw=null;
  Query query=new Query();
  query.setConnectionType(connectionType);
  query.setEntityType(connectedEntityType);
  if (connectionType == null) {
    raw=searchConnectedEntities(query);
  }
 else {
    headEntity=em.validate(headEntity);
    String scopeName=null;
    if (connectedEntityType != null) {
      scopeName=CpEntityManager.getConnectionScopeName(connectedEntityType,connectionType);
    }
 else {
      scopeName=ALL_TYPES;
    }
    IndexScope indexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),scopeName);
    EntityIndex ei=managerCache.getEntityIndex(indexScope);
    logger.debug("Searching connected entities from scope {}:{}:{}",new String[]{indexScope.getApplication().toString(),indexScope.getOwner().toString(),indexScope.getName()});
    query=adjustQuery(query);
    CandidateResults crs=ei.search(query);
    raw=buildResults(query,crs,query.getConnectionType());
  }
  List<ConnectionRef> crefs=new ArrayList<ConnectionRef>();
  for (  Entity e : raw.getEntities()) {
    ConnectionRef cref=new ConnectionRefImpl(headEntity,connectionType,e);
    crefs.add(cref);
  }
  return Results.fromConnections(crefs);
}
