{
  Results raw=null;
  Query query=new Query();
  query.setConnectionType(connectionType);
  query.setEntityType(connectedEntityType);
  if (connectionType == null) {
    raw=searchConnectedEntities(query);
  }
 else {
    headEntity=em.validate(headEntity);
    String scopeName=null;
    if (connectedEntityType != null) {
      scopeName=CpNamingUtils.getConnectionScopeName(connectedEntityType,connectionType);
    }
 else {
      scopeName=CpNamingUtils.ALL_TYPES;
    }
    IndexScope indexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),scopeName);
    final EntityIndex ei=managerCache.getEntityIndex(applicationScope);
    logger.debug("Searching connected entities from scope {}:{}:{}",new String[]{indexScope.getApplication().toString(),indexScope.getOwner().toString(),indexScope.getName()});
    query=adjustQuery(query);
    CandidateResults crs=ei.search(indexScope,query);
    raw=buildResults(query,crs,query.getConnectionType());
  }
  if (Level.ALL_PROPERTIES.equals(level)) {
    List<Entity> entities=new ArrayList<Entity>();
    for (    EntityRef ref : raw.getEntities()) {
      Entity entity=em.get(ref);
      entities.add(entity);
    }
    return Results.fromEntities(entities);
  }
  List<ConnectionRef> crefs=new ArrayList<ConnectionRef>();
  for (  Entity e : raw.getEntities()) {
    ConnectionRef cref=new ConnectionRefImpl(headEntity,connectionType,e);
    crefs.add(cref);
  }
  return Results.fromConnections(crefs);
}
