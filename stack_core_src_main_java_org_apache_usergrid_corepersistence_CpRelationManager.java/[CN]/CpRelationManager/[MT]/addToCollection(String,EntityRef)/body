{
  CollectionScope memberScope=new CollectionScopeImpl(applicationScope.getApplication(),applicationScope.getApplication(),CpEntityManager.getCollectionScopeNameFromEntityType(itemRef.getType()));
  EntityCollectionManager memberMgr=managerCache.getEntityCollectionManager(memberScope);
  if (logger.isDebugEnabled()) {
    logger.debug("Loading member entity {}:{} from scope\n   app {}\n   owner {}\n   name {}",new Object[]{itemRef.getType(),itemRef.getUuid(),memberScope.getApplication(),memberScope.getOwner(),memberScope.getName()});
  }
  org.apache.usergrid.persistence.model.entity.Entity memberEntity=memberMgr.load(new SimpleId(itemRef.getUuid(),itemRef.getType())).toBlockingObservable().last();
  if (memberEntity == null) {
    throw new RuntimeException("Unable to load entity uuid=" + itemRef.getUuid() + " type="+ itemRef.getType());
  }
  Edge edge=new SimpleEdge(cpHeadEntity.getId(),getEdgeTypeFromCollectionName(collName),memberEntity.getId(),memberEntity.getId().getUuid().timestamp());
  GraphManager gm=managerCache.getGraphManager(applicationScope);
  gm.writeEdge(edge).toBlockingObservable().last();
  IndexScope collectionIndexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),CpEntityManager.getCollectionScopeNameFromCollectionName(collName));
  EntityIndex collectionIndex=managerCache.getEntityIndex(collectionIndexScope);
  collectionIndex.index(memberEntity);
  IndexScope allCollectionsIndexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),ALL_TYPES);
  EntityIndex allCollectionIndex=managerCache.getEntityIndex(allCollectionsIndexScope);
  allCollectionIndex.index(memberEntity);
  logger.debug("Added entity {}:{} to collection {}",new String[]{itemRef.getUuid().toString(),itemRef.getType(),collName});
  logger.debug("With head entity scope is {}:{}:{}",new String[]{headEntityScope.getApplication().toString(),headEntityScope.getOwner().toString(),headEntityScope.getName()});
  return em.get(itemRef);
}
