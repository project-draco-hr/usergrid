{
  CollectionScope memberScope=new CollectionScopeImpl(applicationScope.getApplication(),applicationScope.getApplication(),Schema.defaultCollectionName(memberRef.getType()) + COLLECTION_SUFFIX);
  EntityCollectionManager memberMgr=managerCache.getEntityCollectionManager(memberScope);
  org.apache.usergrid.persistence.model.entity.Entity memberEntity=memberMgr.load(new SimpleId(memberRef.getUuid(),memberRef.getType())).toBlockingObservable().last();
  if (memberEntity == null) {
    throw new RuntimeException("Unable to load entity uuid=" + memberRef.getUuid() + " type="+ memberRef.getType());
  }
  Edge edge=new SimpleMarkedEdge(cpHeadEntity.getId(),collName + COLLECTION_SUFFIX,memberEntity.getId(),UUIDGenerator.newTimeUUID(),false);
  GraphManager gm=managerCache.getGraphManager(applicationScope);
  gm.writeEdge(edge).toBlockingObservable().last();
  IndexScope collectionIndexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),collName + COLLECTION_SUFFIX);
  EntityIndex collectionIndex=managerCache.getEntityIndex(collectionIndexScope);
  collectionIndex.index(memberEntity);
  IndexScope allCollectionsIndexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),ALL_TYPES);
  EntityIndex allCollectionIndex=managerCache.getEntityIndex(allCollectionsIndexScope);
  allCollectionIndex.index(memberEntity);
  logger.debug("Added entity {}:{} to collection {}",new String[]{memberRef.getUuid().toString(),memberRef.getType(),collName});
  logger.debug("With head entity scope is {}:{}:{}",new String[]{headEntityScope.getApplication().toString(),headEntityScope.getOwner().toString(),headEntityScope.getName()});
  return em.get(memberRef);
}
