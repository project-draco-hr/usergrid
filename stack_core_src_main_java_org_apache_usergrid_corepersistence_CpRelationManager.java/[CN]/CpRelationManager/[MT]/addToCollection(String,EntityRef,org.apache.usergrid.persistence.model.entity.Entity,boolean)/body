{
  final Entity itemEntity;
  if (itemRef instanceof Entity) {
    itemEntity=(Entity)itemRef;
  }
 else {
    itemEntity=em.get(itemRef);
  }
  if (itemEntity == null) {
    return null;
  }
  CollectionInfo collection=getDefaultSchema().getCollection(headEntity.getType(),collName);
  if ((collection != null) && !collection.getType().equals(itemRef.getType())) {
    return null;
  }
  CollectionScope memberScope=getCollectionScopeNameFromEntityType(applicationScope.getApplication(),itemRef.getType());
  if (memberEntity == null) {
    throw new RuntimeException("Unable to load entity uuid=" + itemRef.getUuid() + " type="+ itemRef.getType());
  }
  if (logger.isDebugEnabled()) {
    logger.debug("Loaded member entity {}:{} from scope\n   app {}\n   " + "owner {}\n   name {} data {}",new Object[]{itemRef.getType(),itemRef.getUuid(),memberScope.getApplication(),memberScope.getOwner(),memberScope.getName(),CpEntityMapUtils.toMap(memberEntity)});
  }
  String edgeType=CpNamingUtils.getEdgeTypeFromCollectionName(collName);
  UUID timeStampUuid=memberEntity.getId().getUuid() != null && UUIDUtils.isTimeBased(memberEntity.getId().getUuid()) ? memberEntity.getId().getUuid() : UUIDUtils.newTimeUUID();
  long uuidHash=UUIDUtils.getUUIDLong(timeStampUuid);
  Edge edge=new SimpleEdge(cpHeadEntity.getId(),edgeType,memberEntity.getId(),uuidHash);
  GraphManager gm=managerCache.getGraphManager(applicationScope);
  gm.writeEdge(edge).toBlockingObservable().last();
  if (logger.isDebugEnabled()) {
    logger.debug("Wrote edgeType {}\n   from {}:{}\n   to {}:{}\n   scope {}:{}",new Object[]{edgeType,cpHeadEntity.getId().getType(),cpHeadEntity.getId().getUuid(),memberEntity.getId().getType(),memberEntity.getId().getUuid(),applicationScope.getApplication().getType(),applicationScope.getApplication().getUuid()});
  }
  ((CpEntityManager)em).indexEntityIntoCollection(cpHeadEntity,memberEntity,collName);
  if (logger.isDebugEnabled()) {
    logger.debug("Added entity {}:{} to collection {}",new Object[]{itemRef.getUuid().toString(),itemRef.getType(),collName});
  }
  if (connectBack && collection != null && collection.getLinkedCollection() != null) {
    getRelationManager(itemEntity).addToCollection(collection.getLinkedCollection(),headEntity,cpHeadEntity,false);
    getRelationManager(itemEntity).addToCollection(collection.getLinkedCollection(),headEntity,false);
  }
  return itemEntity;
}
