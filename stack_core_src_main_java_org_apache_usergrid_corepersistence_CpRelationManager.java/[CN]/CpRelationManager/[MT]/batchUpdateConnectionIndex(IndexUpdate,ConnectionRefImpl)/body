{
  UUID[] index_keys=connection.getIndexIds();
  for (  IndexUpdate.IndexEntry entry : indexUpdate.getPrevEntries()) {
    if (entry.getValue() != null) {
      batchDeleteConnectionIndexEntries(indexUpdate,entry,connection,index_keys);
      if ("location.coordinates".equals(entry.getPath())) {
        EntityLocationRef loc=new EntityLocationRef(indexUpdate.getEntity(),entry.getTimestampUuid(),entry.getValue().toString());
        batchDeleteLocationInConnectionsIndex(indexUpdate.getBatch(),indexBucketLocator,applicationId,index_keys,entry.getPath(),loc);
      }
    }
 else {
      logger.error("Unexpected condition - deserialized property value is null");
    }
  }
  if ((indexUpdate.getNewEntries().size() > 0) && (!indexUpdate.isMultiValue() || (indexUpdate.isMultiValue() && !indexUpdate.isRemoveListEntry()))) {
    for (    IndexUpdate.IndexEntry indexEntry : indexUpdate.getNewEntries()) {
      batchAddConnectionIndexEntries(indexUpdate,indexEntry,connection,index_keys);
      if ("location.coordinates".equals(indexEntry.getPath())) {
        EntityLocationRef loc=new EntityLocationRef(indexUpdate.getEntity(),indexEntry.getTimestampUuid(),indexEntry.getValue().toString());
        batchStoreLocationInConnectionsIndex(indexUpdate.getBatch(),indexBucketLocator,applicationId,index_keys,indexEntry.getPath(),loc);
      }
    }
  }
  for (  String index : indexUpdate.getIndexesSet()) {
    addInsertToMutator(indexUpdate.getBatch(),ENTITY_DICTIONARIES,key(connection.getConnectingIndexId(),Schema.DICTIONARY_INDEXES),index,null,indexUpdate.getTimestamp());
  }
  return indexUpdate;
}
