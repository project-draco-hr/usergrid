{
  Preconditions.checkNotNull(query,"query cannot be null");
  final String connection=query.getConnectionType();
  Preconditions.checkNotNull(connection,"connection must be specified");
  headEntity=em.validate(headEntity);
  final IndexScope indexScope=new IndexScopeImpl(cpHeadEntity.getId(),CpNamingUtils.getConnectionScopeName(connection));
  final SearchTypes searchTypes=SearchTypes.fromNullableTypes(query.getEntityType());
  EntityIndex ei=managerCache.getEntityIndex(applicationScope);
  logger.debug("Searching connections from the scope {}:{} with types {}",new Object[]{indexScope.getOwner().toString(),indexScope.getName(),searchTypes});
  query=adjustQuery(query);
  CandidateResults crs=ei.search(indexScope,searchTypes,query);
  return buildConnectionResults(indexScope,query,crs,connection);
}
