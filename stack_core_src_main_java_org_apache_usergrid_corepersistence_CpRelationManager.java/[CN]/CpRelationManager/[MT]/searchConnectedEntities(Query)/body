{
  if (query == null) {
    query=new Query();
  }
  headEntity=em.validate(headEntity);
  if (query.getEntityType() == null) {
    IndexScope indexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),ALL_TYPES);
    EntityIndex ei=managerCache.getEntityIndex(indexScope);
    logger.debug("Searching connections from the all-types scope {}:{}:{}",new String[]{indexScope.getApplication().toString(),indexScope.getOwner().toString(),indexScope.getName()});
    query=adjustQuery(query);
    CandidateResults crs=ei.search(query);
    return buildConnectionResults(query,crs,query.getConnectionType());
  }
  IndexScope indexScope=new IndexScopeImpl(applicationScope.getApplication(),cpHeadEntity.getId(),CpEntityManager.getConnectionScopeName(query.getEntityType(),query.getConnectionType()));
  EntityIndex ei=managerCache.getEntityIndex(indexScope);
  logger.debug("Searching connections from the '{}' scope {}:{}:{}",new String[]{indexScope.getApplication().toString(),indexScope.getOwner().toString(),indexScope.getName()});
  query=adjustQuery(query);
  CandidateResults crs=ei.search(query);
  return buildConnectionResults(query,crs,query.getConnectionType());
}
