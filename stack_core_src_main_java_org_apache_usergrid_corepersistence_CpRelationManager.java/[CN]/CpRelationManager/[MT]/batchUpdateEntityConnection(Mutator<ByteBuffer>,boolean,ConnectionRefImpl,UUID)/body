{
  long timestamp=getTimestampInMicros(timestampUuid);
  Entity connectedEntity=em.get(new SimpleEntityRef(conn.getConnectedEntityType(),conn.getConnectedEntityId()));
  if (connectedEntity == null) {
    return batch;
  }
  if (disconnect) {
    addDeleteToMutator(batch,ENTITY_COMPOSITE_DICTIONARIES,key(conn.getConnectingEntityId(),DICTIONARY_CONNECTED_ENTITIES,conn.getConnectionType()),asList(conn.getConnectedEntityId(),conn.getConnectedEntityType()),timestamp);
    addDeleteToMutator(batch,ENTITY_COMPOSITE_DICTIONARIES,key(conn.getConnectedEntityId(),DICTIONARY_CONNECTING_ENTITIES,conn.getConnectionType()),asList(conn.getConnectingEntityId(),conn.getConnectingEntityType()),timestamp);
    if (!moreThanOneOutboundConnection(conn.getConnectingEntity(),conn.getConnectionType())) {
      addDeleteToMutator(batch,ENTITY_DICTIONARIES,key(conn.getConnectingEntityId(),DICTIONARY_CONNECTED_TYPES),conn.getConnectionType(),timestamp);
    }
    if (!moreThanOneInboundConnection(conn.getConnectingEntity(),conn.getConnectionType())) {
      addDeleteToMutator(batch,ENTITY_DICTIONARIES,key(conn.getConnectedEntityId(),DICTIONARY_CONNECTING_TYPES),conn.getConnectionType(),timestamp);
    }
  }
 else {
    addInsertToMutator(batch,ENTITY_COMPOSITE_DICTIONARIES,key(conn.getConnectingEntityId(),DICTIONARY_CONNECTED_ENTITIES,conn.getConnectionType()),asList(conn.getConnectedEntityId(),conn.getConnectedEntityType()),timestamp,timestamp);
    addInsertToMutator(batch,ENTITY_COMPOSITE_DICTIONARIES,key(conn.getConnectedEntityId(),DICTIONARY_CONNECTING_ENTITIES,conn.getConnectionType()),asList(conn.getConnectingEntityId(),conn.getConnectingEntityType()),timestamp,timestamp);
    addInsertToMutator(batch,ENTITY_DICTIONARIES,key(conn.getConnectingEntityId(),DICTIONARY_CONNECTED_TYPES),conn.getConnectionType(),null,timestamp);
    addInsertToMutator(batch,ENTITY_DICTIONARIES,key(conn.getConnectedEntityId(),DICTIONARY_CONNECTING_TYPES),conn.getConnectionType(),null,timestamp);
  }
  Set<String> dictionaryNames=em.getDictionaryNames(connectedEntity);
  Schema schema=getDefaultSchema();
  for (  String dictionaryName : dictionaryNames) {
    boolean has_dictionary=schema.hasDictionary(connectedEntity.getType(),dictionaryName);
    boolean dictionary_indexed=schema.isDictionaryIndexedInConnections(connectedEntity.getType(),dictionaryName);
    if (dictionary_indexed || !has_dictionary) {
      Set<Object> elementValues=em.getDictionaryAsSet(connectedEntity,dictionaryName);
      for (      Object elementValue : elementValues) {
        IndexUpdate indexUpdate=batchStartIndexUpdate(batch,connectedEntity,dictionaryName,elementValue,timestampUuid,has_dictionary,true,disconnect,false);
        batchUpdateConnectionIndex(indexUpdate,conn);
      }
    }
  }
  return batch;
}
