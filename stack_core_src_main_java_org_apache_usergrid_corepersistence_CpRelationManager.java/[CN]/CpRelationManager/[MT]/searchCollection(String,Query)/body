{
  if (query == null) {
    query=new Query();
  }
  headEntity=em.validate(headEntity);
  CollectionInfo collection=getDefaultSchema().getCollection(headEntity.getType(),collName);
  if (collection == null) {
    throw new RuntimeException("Cannot find collection-info for '" + collName + "' of "+ headEntity.getType()+ ":"+ headEntity.getUuid());
  }
  final IndexScope indexScope=new IndexScopeImpl(cpHeadEntity.getId(),CpNamingUtils.getCollectionScopeNameFromCollectionName(collName));
  final EntityIndex ei=managerCache.getEntityIndex(applicationScope);
  final SearchTypes types=SearchTypes.fromTypes(collection.getType());
  logger.debug("Searching scope {}:{}",indexScope.getOwner().toString(),indexScope.getName());
  query.setEntityType(collection.getType());
  query=adjustQuery(query);
  int maxQueries=10;
  final int originalLimit=query.getLimit();
  Results results=null;
  int queryCount=0;
  boolean satisfied=false;
  while (!satisfied && queryCount++ < maxQueries) {
    CandidateResults crs=ei.search(indexScope,types,query);
    if (results == null) {
      logger.debug("Calling build results 1");
      results=buildResults(query,crs,collName);
    }
 else {
      logger.debug("Calling build results 2");
      Results newResults=buildResults(query,crs,collName);
      results.merge(newResults);
    }
    if (crs.isEmpty() || !crs.hasCursor()) {
      satisfied=true;
    }
 else     if (results.size() == originalLimit) {
      satisfied=true;
    }
 else     if (crs.hasCursor()) {
      satisfied=false;
      query.setCursor(results.getCursor());
      query.setLimit(originalLimit - results.size());
      logger.warn("Satisfy query limit {}, new limit {} query count {}",new Object[]{originalLimit,query.getLimit(),queryCount});
    }
  }
  return results;
}
