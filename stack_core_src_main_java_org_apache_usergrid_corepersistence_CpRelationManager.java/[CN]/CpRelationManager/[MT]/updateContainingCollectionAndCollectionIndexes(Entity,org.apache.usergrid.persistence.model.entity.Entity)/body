{
  List<String> results=new ArrayList<String>();
  GraphManager gm=managerCache.getGraphManager(applicationScope);
  Iterator<String> edgeTypesToTarget=gm.getEdgeTypesToTarget(new SimpleSearchEdgeType(cpHeadEntity.getId(),null,null)).toBlockingObservable().getIterator();
  logger.debug("updateContainingCollectionsAndCollections(): " + "Searched for edges to target {}:{}\n   in scope {}\n   found: {}",new Object[]{cpHeadEntity.getId().getType(),cpHeadEntity.getId().getUuid(),applicationScope.getApplication(),edgeTypesToTarget.hasNext()});
  int count=0;
  final EntityIndex ei=managerCache.getEntityIndex(applicationScope);
  final EntityIndexBatch entityIndexBatch=ei.createBatch();
  while (edgeTypesToTarget.hasNext()) {
    String etype=edgeTypesToTarget.next();
    Observable<Edge> edges=gm.loadEdgesToTarget(new SimpleSearchByEdgeType(cpHeadEntity.getId(),etype,Long.MAX_VALUE,SearchByEdgeType.Order.DESCENDING,null));
    Iterator<Edge> iter=edges.toBlockingObservable().getIterator();
    while (iter.hasNext()) {
      Edge edge=iter.next();
      EntityRef sourceEntity=new SimpleEntityRef(edge.getSourceNode().getType(),edge.getSourceNode().getUuid());
      IndexScope indexScope;
      if (CpNamingUtils.isCollectionEdgeType(edge.getType())) {
        String collName=CpNamingUtils.getCollectionName(edge.getType());
        indexScope=new IndexScopeImpl(applicationScope.getApplication(),new SimpleId(sourceEntity.getUuid(),sourceEntity.getType()),CpNamingUtils.getCollectionScopeNameFromCollectionName(collName));
      }
 else {
        String connName=CpNamingUtils.getCollectionName(edge.getType());
        indexScope=new IndexScopeImpl(applicationScope.getApplication(),new SimpleId(sourceEntity.getUuid(),sourceEntity.getType()),CpNamingUtils.getConnectionScopeName(cpHeadEntity.getId().getType(),connName));
      }
      entityIndexBatch.index(indexScope,cpEntity);
      indexScope=new IndexScopeImpl(applicationScope.getApplication(),new SimpleId(sourceEntity.getUuid(),sourceEntity.getType()),CpNamingUtils.ALL_TYPES);
      entityIndexBatch.index(indexScope,cpEntity);
      count++;
    }
  }
  entityIndexBatch.execute();
  logger.debug("updateContainingCollectionsAndCollections() updated {} indexes",count);
  return results;
}
