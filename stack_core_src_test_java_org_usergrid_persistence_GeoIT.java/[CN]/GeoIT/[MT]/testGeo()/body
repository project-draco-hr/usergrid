{
  logger.info("GeoIT.testGeo");
  UUID applicationId=createApplication("testOrganization","testGeo");
  assertNotNull(applicationId);
  EntityManager em=emf.getEntityManager(applicationId);
  assertNotNull(em);
  Map<String,Object> properties=new LinkedHashMap<String,Object>();
  properties.put("username","edanuff");
  properties.put("email","ed@anuff.com");
  Entity user=em.create("user",properties);
  assertNotNull(user);
  EntityLocationRef loc=new EntityLocationRef(user,37.776753,-122.407846);
  GeoIndexManager geo=em.getGeoIndexManager();
  geo.storeLocationInCollectionIndex(em.getApplicationRef(),"users",user.getUuid(),"location.coordinates",loc);
  Point center=new Point(37.774277,-122.404744);
  SearchResults<EntityLocationRef> searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,200,null,GeoIndexManager.MAX_RESOLUTION,10);
  List<EntityLocationRef> listResults=searchResults.getResults();
  assertEquals(0,listResults.size());
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,400,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  this.dump(listResults);
  assertEquals(1,listResults.size());
  geo.removeLocationFromCollectionIndex(em.getApplicationRef(),"users","location.coordinates",loc);
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,400,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  this.dump(listResults);
  assertEquals(0,listResults.size());
  updatePos(em,user,37.426373,-122.14108);
  center=new Point(37.774277,-122.404744);
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,200,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  assertEquals(0,listResults.size());
  updatePos(em,user,37.774277,-122.404744);
  center=new Point(37.776753,-122.407846);
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,1000,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  assertEquals(1,listResults.size());
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,Integer.MAX_VALUE,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  assertEquals(1,listResults.size());
  LinkedHashMap<String,Object> properties2=new LinkedHashMap<String,Object>();
  properties2.put("username","sganyo");
  properties2.put("email","sganyo@anuff.com");
  Entity user2=em.create("user",properties2);
  assertNotNull(user2);
  EntityLocationRef loc2=new EntityLocationRef(user2,31.1,121.2);
  geo.storeLocationInCollectionIndex(em.getApplicationRef(),"users",user2.getUuid(),"location.coordinates",loc2);
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,10000,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  assertEquals(1,listResults.size());
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,Integer.MAX_VALUE,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  assertEquals(2,listResults.size());
  center=new Point(31.14,121.27);
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,Integer.MAX_VALUE,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  assertEquals(2,listResults.size());
  Results emSearchResults=em.searchCollection(em.getApplicationRef(),"users",Query.fromQL("location within 1000 of 37.776753, -122.407846"));
  assertEquals(1,emSearchResults.size());
  updatePos(em,user,37.776753,-122.407846);
  center=new Point(37.428526,-122.140916);
  searchResults=geo.proximitySearchCollection(em.getApplicationRef(),"users","location.coordinates",center,0,1000,null,GeoIndexManager.MAX_RESOLUTION,10);
  listResults=searchResults.getResults();
  assertEquals(0,listResults.size());
  emSearchResults=em.searchCollection(em.getApplicationRef(),"users",Query.fromQL("location within 1000 of 37.428526, -122.140916"));
  assertEquals(0,emSearchResults.size());
  properties=new LinkedHashMap<String,Object>();
  properties.put("name","Brickhouse");
  properties.put("address","426 Brannan Street");
  properties.put("location",getLocation(37.779632,-122.395131));
  Entity restaurant=em.create("restaurant",properties);
  assertNotNull(restaurant);
  em.createConnection(user,"likes",restaurant);
  emSearchResults=em.searchConnectedEntities(user,Query.fromQL("location within 2000 of 37.776753, -122.407846"));
  assertEquals(1,emSearchResults.size());
  emSearchResults=em.searchConnectedEntities(user,Query.fromQL("location within 1000 of 37.776753, -122.407846"));
  assertEquals(0,emSearchResults.size());
}
