{
  QuerySlice slice=node.getSlice();
  queryProcessor.applyCursorAndSort(slice);
  int size=queryProcessor.getPageSizeHint(node);
  ByteBuffer start=null;
  if (slice.hasCursor()) {
    start=slice.getCursor();
  }
  boolean skipFirst=node.isForceKeepFirst() ? false : slice.hasCursor();
  UUID entityIdToUse;
  String dictionaryType;
  String targetType;
  if (outgoing) {
    entityIdToUse=connection.getConnectingEntityId();
    dictionaryType=DICTIONARY_CONNECTED_ENTITIES;
    targetType=connection.getConnectedEntityType();
  }
 else {
    entityIdToUse=connection.getConnectedEntityId();
    dictionaryType=DICTIONARY_CONNECTING_ENTITIES;
    targetType=connection.getConnectingEntityType();
  }
  final String connectionType=connection.getConnectionType();
  final SliceCursorGenerator sliceCursorGenerator=new SliceCursorGenerator(slice);
  final ConnectionIndexSliceParser connectionParser=new ConnectionIndexSliceParser(targetType,sliceCursorGenerator);
  final Iterator<String> connectionTypes;
  if (connectionType != null) {
    connectionTypes=Collections.singleton(connectionType).iterator();
  }
 else {
    connectionTypes=new ConnectionTypesIterator(cassandraService,applicationId,entityIdToUse,outgoing,size);
  }
  IndexScanner connectionScanner=new ConnectedIndexScanner(cassandraService,dictionaryType,applicationId,entityIdToUse,connectionTypes,start,slice.isReversed(),size,skipFirst);
  final ConnectionShardFilter connectionShardFilter=new ConnectionShardFilter(indexBucketLocator,bucket);
  final SliceIterator sliceIterator=new SliceIterator(connectionScanner,connectionParser);
  this.results.push(new ShardFilterIterator(connectionShardFilter,sliceIterator,size));
}
