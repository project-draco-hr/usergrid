{
  if (sqs == null) {
    logger.error("SQS is null - was not initialized properly");
    return rx.Observable.empty();
  }
  String url=getReadQueue().getUrl();
  if (logger.isDebugEnabled())   logger.debug("Getting up to {} messages from {}",limit,url);
  ReceiveMessageRequest receiveMessageRequest=new ReceiveMessageRequest(url);
  receiveMessageRequest.setMaxNumberOfMessages(limit);
  receiveMessageRequest.setVisibilityTimeout(Math.max(1,transactionTimeout / 1000));
  receiveMessageRequest.setWaitTimeSeconds(waitTime / 1000);
  try {
    ReceiveMessageResult result=sqs.receiveMessage(receiveMessageRequest);
    List<Message> messages=result.getMessages();
    if (logger.isDebugEnabled())     logger.debug("Received {} messages from {}",messages.size(),url);
    List<QueueMessage> queueMessages=new ArrayList<>(messages.size());
    for (    Message message : messages) {
      Object body;
      final String originalBody=message.getBody();
      try {
        final JsonNode bodyNode=mapper.readTree(message.getBody());
        JsonNode bodyObj=bodyNode.has("Message") ? bodyNode.get("Message") : bodyNode;
        body=fromString(bodyObj.textValue(),klass);
      }
 catch (      Exception e) {
        logger.error(String.format("failed to deserialize message: %s",message.getBody()),e);
        throw new RuntimeException(e);
      }
      QueueMessage queueMessage=new QueueMessage(message.getMessageId(),message.getReceiptHandle(),body,message.getAttributes().get("type"));
      queueMessage.setStringBody(originalBody);
      queueMessages.add(queueMessage);
    }
    return rx.Observable.from(queueMessages);
  }
 catch (  com.amazonaws.services.sqs.model.QueueDoesNotExistException dne) {
    logger.error(String.format("Queue does not exist! [%s]",url),dne);
  }
catch (  Exception e) {
    logger.error(String.format("Programming error getting messages from queue=[%s] exist!",url),e);
  }
  return rx.Observable.from(new ArrayList<>(0));
}
