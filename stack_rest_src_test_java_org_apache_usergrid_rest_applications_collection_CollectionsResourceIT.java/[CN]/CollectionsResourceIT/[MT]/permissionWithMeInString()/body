{
  String username="sumeet.agarwal@usergrid.com";
  String email="sumeet.agarwal@usergrid.com";
  String password="secret";
  String name="Sumeet Agarwal";
  Entity payload=new Entity();
  payload.put("username",username);
  payload.put("email",email);
  payload.put("password",password);
  payload.put("name",name);
  Entity user=this.app().collection("users").post(payload);
  assertEquals(user.get("username"),username);
  assertEquals(user.get("email"),email);
  this.refreshIndex();
  String collectionName="nestprofiles";
  payload=new Entity();
  payload.put("permission","get,post,put,delete:/" + collectionName + "/**");
  Entity permission=this.app().collection("users").entity(user).collection("permissions").post(payload);
  assertEquals(permission.get("data"),"get,post,put,delete:/" + collectionName + "/**");
  this.app().collection("role").uniqueID("Default").delete();
  Token appToken=this.getAppUserToken(username,password);
  management().token().setToken(appToken);
  payload=new Entity();
  String profileName="profile-sumeet";
  payload.put("name",profileName);
  payload.put("firstname","sumeet");
  payload.put("lastname","agarwal");
  payload.put("mobile","122");
  Entity nestProfile=this.app().collection(collectionName).post(payload);
  assertEquals(nestProfile.get("name"),profileName);
  this.refreshIndex();
  Entity nestprofileReturned=this.app().collection(collectionName).entity(nestProfile).get();
  assertEquals(nestprofileReturned.get("name"),profileName);
}
