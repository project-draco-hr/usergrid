{
  observer.start();
  EntityManager em=emf.getEntityManager(CpNamingUtils.MANAGEMENT_APPLICATION_ID);
  Query q=Query.fromQL("select *");
  Results results;
  try {
    results=em.searchCollection(em.getApplicationRef(),"appinfos",q);
  }
 catch (  Exception e) {
    logger.error("Error reading old appinfos collection, not migrating",e);
    return;
  }
  if (!results.isEmpty()) {
    String currentAppName=null;
    try {
      logger.info("Migrating old appinfos");
      for (      Entity oldAppInfo : results.getEntities()) {
        final String appName=currentAppName=oldAppInfo.getName();
        UUID applicationId;
        UUID organizationId;
        Object uuidObject=oldAppInfo.getProperty("applicationUuid");
        if (uuidObject instanceof UUID) {
          applicationId=(UUID)uuidObject;
        }
 else {
          applicationId=UUIDUtils.tryExtractUUID(uuidObject.toString());
        }
        uuidObject=oldAppInfo.getProperty("organizationUuid");
        if (uuidObject instanceof UUID) {
          organizationId=(UUID)uuidObject;
        }
 else {
          organizationId=UUIDUtils.tryExtractUUID(uuidObject.toString());
        }
        final UUID appId=applicationId;
        Entity appInfo=getApplicationInfo(emf,appId);
        if (appInfo == null) {
          Map<String,Object> appInfoMap=new HashMap<String,Object>(){
{
              put(PROPERTY_NAME,appName);
              put(PROPERTY_APPLICATION_ID,appId);
            }
          }
;
          appInfo=em.create(appId,CpNamingUtils.APPLICATION_INFO,appInfoMap);
          observer.update(getMaxVersion(),"Created application_info for " + appName);
        }
 else {
          appInfo.setProperty(PROPERTY_APPLICATION_ID,appId);
          em.update(appInfo);
          observer.update(getMaxVersion(),"Updated existing application_info for " + appName);
        }
        em.createConnection(new SimpleEntityRef(Group.ENTITY_TYPE,organizationId),"owns",appInfo);
      }
      em.refreshIndex();
      for (      Entity oldAppInfo : results.getEntities()) {
        em.delete(oldAppInfo);
      }
    }
 catch (    Exception e) {
      String msg="Exception writing application_info for " + currentAppName;
      logger.error(msg,e);
      observer.failed(getMaxVersion(),msg);
    }
  }
 else {
    logger.info("No old appinfos found, no need for migration");
  }
  observer.complete();
}
