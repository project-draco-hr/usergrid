{
  Queue queue=context.application().queues().queue("test");
  queue.subscribers().subscribe("testsub1");
  queue.subscribers().subscribe("testsub2");
  final int count=30;
  for (int i=0; i < count; i++) {
    queue.post(MapUtils.hashMap("id",i));
  }
  IncrementHandler handler=new IncrementHandler(count);
  testMessages(queue,handler,new NoLastCommand());
  handler.assertResults();
  handler=new IncrementHandler(count);
  queue=context.application().queues().queue("testsub1");
  testMessages(queue,handler,new NoLastCommand());
  handler.assertResults();
  handler=new IncrementHandler(count);
  queue=context.application().queues().queue("testsub2");
  testMessages(queue,handler,new NoLastCommand());
  handler.assertResults();
  queue=context.application().queues().queue("test");
  queue.subscribers().unsubscribe("testsub1");
  for (int i=0; i < count; i++) {
    queue.post(MapUtils.hashMap("id",i));
  }
  handler=new IncrementHandler(count);
  testMessages(queue,handler,new NoLastCommand());
  handler.assertResults();
  queue=context.application().queues().queue("testsub1");
  handler=new IncrementHandler(0);
  testMessages(queue,handler,new NoLastCommand());
  handler.assertResults();
  queue=context.application().queues().queue("testsub2");
  handler=new IncrementHandler(count);
  testMessages(queue,handler,new NoLastCommand());
  handler.assertResults();
}
