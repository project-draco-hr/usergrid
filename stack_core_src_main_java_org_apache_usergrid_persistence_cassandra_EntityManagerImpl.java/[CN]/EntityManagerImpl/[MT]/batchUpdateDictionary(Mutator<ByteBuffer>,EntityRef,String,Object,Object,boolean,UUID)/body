{
  long timestamp=getTimestampInMicros(timestampUuid);
  if (elementCoValue == null) {
    elementCoValue=ByteBuffer.allocate(0);
  }
  boolean entityHasDictionary=getDefaultSchema().hasDictionary(entity.getType(),dictionaryName);
  if (entityHasDictionary) {
    getRelationManager(entity).batchUpdateSetIndexes(batch,dictionaryName,elementValue,removeFromDictionary,timestampUuid);
  }
  ApplicationCF dictionary_cf=entityHasDictionary ? ENTITY_DICTIONARIES : ENTITY_COMPOSITE_DICTIONARIES;
  if (elementValue != null) {
    if (!removeFromDictionary) {
      elementCoValue=toStorableBinaryValue(elementCoValue,!entityHasDictionary);
      addInsertToMutator(batch,dictionary_cf,key(entity.getUuid(),dictionaryName),entityHasDictionary ? elementValue : asList(elementValue),elementCoValue,timestamp);
      if (!entityHasDictionary) {
        addInsertToMutator(batch,ENTITY_DICTIONARIES,key(entity.getUuid(),DICTIONARY_SETS),dictionaryName,null,timestamp);
      }
    }
 else {
      addDeleteToMutator(batch,dictionary_cf,key(entity.getUuid(),dictionaryName),entityHasDictionary ? elementValue : asList(elementValue),timestamp);
    }
  }
  return batch;
}
