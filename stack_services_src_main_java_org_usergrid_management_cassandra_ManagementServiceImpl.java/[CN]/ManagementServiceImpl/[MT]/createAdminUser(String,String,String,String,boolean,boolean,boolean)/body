{
  if (email == null) {
    return null;
  }
  if (username == null) {
    username=email;
  }
  if (name == null) {
    name=email;
  }
  if (isBlank(password)) {
    password=encodeBase64URLSafeString(bytes(UUID.randomUUID()));
  }
  EntityManager em=emf.getEntityManager(MANAGEMENT_APPLICATION_ID);
  User user=new User();
  user.setUsername(username);
  user.setName(name);
  user.setEmail(email);
  user.setActivated(activated);
  user.setConfirmed(false);
  user.setDisabled(disabled);
  user=em.create(user);
  Map<String,CredentialsInfo> credentials=new HashMap<String,CredentialsInfo>();
  credentials.put("password",passwordCredentials(password));
  credentials.put("mongo_pwd",mongoPasswordCredentials(username,password));
  credentials.put("secret",plainTextCredentials(generateOAuthSecretKey(AuthPrincipalType.ADMIN_USER)));
  em.addMapToDictionary(user,DICTIONARY_CREDENTIALS,credentials);
  UserInfo userInfo=new UserInfo(MANAGEMENT_APPLICATION_ID,user.getUuid(),username,name,email,activated,disabled);
  if (sendEmail) {
    sendAdminUserActivationEmail(userInfo);
  }
  return userInfo;
}
