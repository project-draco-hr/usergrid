{
  Lock usernameLock=getUnqiueUpdateLock(lockManager,MANAGEMENT_APPLICATION_ID,username,"users","username");
  usernameLock.lock();
  Lock emailLock=getUnqiueUpdateLock(lockManager,MANAGEMENT_APPLICATION_ID,email,"users","email");
  emailLock.lock();
  try {
    EntityManager em=emf.getEntityManager(MANAGEMENT_APPLICATION_ID);
    if (!isBlank(username)) {
      em.setProperty(new SimpleEntityRef(User.ENTITY_TYPE,user.getUuid()),"username",username);
    }
    if (!isBlank(name)) {
      em.setProperty(new SimpleEntityRef(User.ENTITY_TYPE,user.getUuid()),"name",name);
    }
    if (!isBlank(email)) {
      em.setProperty(new SimpleEntityRef(User.ENTITY_TYPE,user.getUuid()),"email",email);
    }
    user=getAdminUserByUuid(user.getUuid());
  }
  finally {
    emailLock.unlock();
    usernameLock.unlock();
  }
  return user;
}
