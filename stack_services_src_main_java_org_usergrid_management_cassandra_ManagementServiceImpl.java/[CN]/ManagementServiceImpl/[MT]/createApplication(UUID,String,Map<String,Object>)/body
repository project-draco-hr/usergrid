{
  if ((organizationId == null) || (applicationName == null)) {
    return null;
  }
  if (properties == null) {
    properties=new HashMap<String,Object>();
  }
  UUID applicationId=emf.createApplication(applicationName,properties);
  EntityManager em=emf.getEntityManager(MANAGEMENT_APPLICATION_ID);
  properties.put("name",applicationName);
  Entity applicationEntity=em.create(applicationId,APPLICATION_INFO,properties);
  Map<String,CredentialsInfo> credentials=new HashMap<String,CredentialsInfo>();
  credentials.put("secret",plainTextCredentials(generateOAuthSecretKey(AuthPrincipalType.APPLICATION)));
  em.addMapToDictionary(applicationEntity,DICTIONARY_CREDENTIALS,credentials);
  addApplicationToOrganization(organizationId,applicationId);
  em.grantRolePermissions("default",Arrays.asList("get,put,post,delete:/users/${user}","get,put,post,delete:/users/${user}/feed","get,put,post,delete:/users/${user}/activities","get,put,post,delete:/users/${user}/groups","get,put,post,delete:/users/${user}/following/*","get,put,post,delete:/users/${user}/following/user/*"));
  em.grantRolePermissions("guest",Arrays.asList("post:/users/","put:/devices/"));
  UserInfo user=null;
  try {
    user=SubjectUtils.getUser();
  }
 catch (  UnavailableSecurityManagerException e) {
  }
  if ((user != null) && user.isAdminUser()) {
    postOrganizationActivity(organizationId,user,"create",applicationEntity,"Application",applicationName,"<a mailto=\"" + user.getEmail() + "\">"+ user.getName()+ " ("+ user.getEmail()+ ")</a> created a new application named "+ applicationName,null);
  }
  return applicationId;
}
