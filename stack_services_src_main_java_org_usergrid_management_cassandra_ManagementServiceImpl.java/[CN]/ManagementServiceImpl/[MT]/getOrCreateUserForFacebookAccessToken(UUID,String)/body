{
  ClientConfig clientConfig=new DefaultClientConfig();
  clientConfig.getFeatures().put(JSONConfiguration.FEATURE_POJO_MAPPING,Boolean.TRUE);
  Client client=Client.create(clientConfig);
  WebResource web_resource=client.resource("https://graph.facebook.com/me");
  @SuppressWarnings("unchecked") Map<String,Object> fb_user=web_resource.queryParam("access_token",fb_access_token).accept(MediaType.APPLICATION_JSON).get(Map.class);
  String fb_user_id=(String)fb_user.get("id");
  String fb_user_name=(String)fb_user.get("name");
  String fb_user_username=(String)fb_user.get("username");
  String fb_user_email=(String)fb_user.get("email");
  if (logger.isDebugEnabled()) {
    logger.debug(JsonUtils.mapToFormattedJsonString(fb_user));
  }
  if (applicationId == null) {
    return null;
  }
  User user=null;
  if ((fb_user != null) && !anyNull(fb_user_id,fb_user_name)) {
    EntityManager em=emf.getEntityManager(applicationId);
    Results r=em.searchCollection(em.getApplicationRef(),"users",Query.findForProperty("facebook.id",fb_user_id));
    if (r.size() > 1) {
      logger.error("Multiple users for FB ID: " + fb_user_id);
      throw new BadTokenException("multiple users with same Facebook ID");
    }
    if (r.size() < 1) {
      Map<String,Object> properties=new LinkedHashMap<String,Object>();
      properties.put("facebook",fb_user);
      properties.put("username","fb_" + fb_user_id);
      properties.put("name",fb_user_name);
      properties.put("picture","http://graph.facebook.com/" + fb_user_id + "/picture");
      if (fb_user_email != null) {
        user=getAppUserByIdentifier(applicationId,Identifier.fromEmail(fb_user_email));
        if (user != null) {
          properties.remove("username");
          properties.remove("name");
          em.updateProperties(user,properties);
        }
 else {
          properties.put("email",fb_user_email);
        }
      }
      if (user == null) {
        properties.put("activated",true);
        user=em.create("user",User.class,properties);
      }
    }
 else {
      user=(User)r.getEntity().toTypedEntity();
      Map<String,Object> properties=new LinkedHashMap<String,Object>();
      properties.put("facebook",fb_user);
      properties.put("picture","http://graph.facebook.com/" + fb_user_id + "/picture");
      em.updateProperties(user,properties);
      user.setProperty("facebook",fb_user);
      user.setProperty("picture","http://graph.facebook.com/" + fb_user_id + "/picture");
    }
  }
 else {
    throw new BadTokenException("Unable to confirm Facebook access token");
  }
  return user;
}
