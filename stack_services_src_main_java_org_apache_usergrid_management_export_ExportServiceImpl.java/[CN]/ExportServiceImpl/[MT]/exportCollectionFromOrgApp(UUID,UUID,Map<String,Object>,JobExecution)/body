{
  UUID exportId=(UUID)jobExecution.getJobData().getProperty(EXPORT_ID);
  EntityManager exportManager=emf.getEntityManager((UUID)config.get("applicationId"));
  Export export=exportManager.get(exportId,Export.class);
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  ApplicationInfo application=managementService.getApplicationInfo(applicationUUID);
  JsonGenerator jg=getJsonGenerator(baos);
  EntityManager em=emf.getEntityManager(applicationUUID);
  jg.writeStartArray();
  Map<String,Object> metadata=em.getApplicationCollectionMetadata();
  long starting_time=System.currentTimeMillis();
  String appFileName=prepareOutputFileName("application",application.getName(),(String)config.get("collectionName"));
  for (  String collectionName : metadata.keySet()) {
    if (collectionName.equals((String)config.get("collectionName"))) {
      Query query;
      if (config.get("query") == null) {
        query=new Query();
      }
 else {
        query=Query.fromQL((String)config.get("query"));
      }
      query.setLimit(MAX_ENTITY_FETCH);
      query.setResultsLevel(Results.Level.ALL_PROPERTIES);
      Results entities=em.searchCollection(em.getApplicationRef(),collectionName,query);
      PagingResultsIterator itr=new PagingResultsIterator(entities);
      for (      Object e : itr) {
        starting_time=checkTimeDelta(starting_time,jobExecution);
        Entity entity=(Entity)e;
        jg.writeStartObject();
        jg.writeFieldName("Metadata");
        jg.writeObject(entity);
        saveCollectionMembers(jg,em,(String)config.get("collectionName"),entity);
        jg.writeEndObject();
      }
    }
  }
  jg.writeEndArray();
  jg.close();
  baos.flush();
  baos.close();
  InputStream is=new ByteArrayInputStream(baos.toByteArray());
  try {
    s3Export.copyToS3(is,config,appFileName);
  }
 catch (  Exception e) {
    export.setErrorMessage(e.getMessage());
    export.setState(Export.State.FAILED);
    return;
  }
}
