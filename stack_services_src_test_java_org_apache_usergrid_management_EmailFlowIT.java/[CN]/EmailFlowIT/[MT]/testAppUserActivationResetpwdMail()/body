{
  final String orgName=uniqueOrg();
  final String appName=uniqueApp();
  final String adminUserName=uniqueUsername();
  final String adminEmail=uniqueEmail();
  final String adminPasswd="testpassword";
  OrganizationOwnerInfo orgOwner=createOwnerAndOrganization(orgName,appName,adminUserName,adminEmail,adminPasswd,false,false);
  assertNotNull(orgOwner);
  ApplicationInfo app=setup.getMgmtSvc().createApplication(orgOwner.getOrganization().getUuid(),appName);
  enableAdminApproval(app.getId());
  final String appUserUsername=uniqueUsername();
  final String appUserEmail=uniqueEmail();
  User appUser=setupAppUser(app.getId(),appUserUsername,appUserEmail,false);
  String subject="Request For User Account Activation " + appUserEmail;
  String activation_url=String.format(setup.get(PROPERTIES_USER_ACTIVATION_URL),orgName,appName,appUser.getUuid().toString());
  setup.getEmf().refreshIndex();
  setup.getMgmtSvc().startAppUserActivationFlow(app.getId(),appUser);
  List<Message> inbox=Mailbox.get(adminEmail);
  assertFalse(inbox.isEmpty());
  MockImapClient client=new MockImapClient("usergrid.com",adminUserName,"somepassword");
  client.processMail();
  Message activation=inbox.get(0);
  assertEquals(subject,activation.getSubject());
  String mailContent=(String)((MimeMultipart)activation.getContent()).getBodyPart(1).getContent();
  LOG.info(mailContent);
  assertTrue(StringUtils.contains(mailContent.toLowerCase(),activation_url.toLowerCase()));
  String token=getTokenFromMessage(activation);
  LOG.info(token);
  ActivationState activeState=setup.getMgmtSvc().handleActivationTokenForAppUser(app.getId(),appUser.getUuid(),token);
  assertEquals(ActivationState.ACTIVATED,activeState);
  subject="Password Reset";
  String reset_url=String.format(setup.get(PROPERTIES_USER_RESETPW_URL),orgName,appName,appUser.getUuid().toString());
  setup.getMgmtSvc().startAppUserPasswordResetFlow(app.getId(),appUser);
  inbox=Mailbox.get(appUserEmail);
  assertFalse(inbox.isEmpty());
  client=new MockImapClient("test.com",appUserUsername,"somepassword");
  client.processMail();
  Message reset=inbox.get(1);
  assertEquals(subject,reset.getSubject());
  mailContent=(String)((MimeMultipart)reset.getContent()).getBodyPart(1).getContent();
  LOG.info(mailContent);
  assertTrue(StringUtils.contains(mailContent.toLowerCase(),reset_url.toLowerCase()));
  token=getTokenFromMessage(reset);
  LOG.info(token);
  assertTrue(setup.getMgmtSvc().checkPasswordResetTokenForAppUser(app.getId(),appUser.getUuid(),token));
  setup.getMgmtSvc().revokeAccessTokenForAppUser(token);
  assertFalse(setup.getMgmtSvc().checkPasswordResetTokenForAppUser(app.getId(),appUser.getUuid(),token));
}
